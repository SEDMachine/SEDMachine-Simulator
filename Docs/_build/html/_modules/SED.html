

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>SED &mdash; SEDMachine 0.1.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="SEDMachine 0.1.1 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="../index.html">SEDMachine 0.1.1 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for SED</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c">#</span>
<span class="c">#  SED.py</span>
<span class="c">#  Simulation Software</span>
<span class="c">#</span>
<span class="c">#  Created by Alexander Rudy on 2011-11-04.</span>
<span class="c">#  Copyright 2011 Alexander Rudy. All rights reserved.</span>
<span class="c">#</span>


<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pyfits</span> <span class="kn">as</span> <span class="nn">pf</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="kn">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="kn">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">scipy.signal</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">logging</span><span class="o">,</span><span class="nn">time</span><span class="o">,</span><span class="nn">copy</span><span class="o">,</span><span class="nn">collections</span>

<span class="kn">import</span> <span class="nn">AstroObject</span>
<span class="kn">from</span> <span class="nn">AstroObject.AstroSpectra</span> <span class="kn">import</span> <span class="n">SpectraObject</span>
<span class="kn">from</span> <span class="nn">AstroObject.AstroImage</span> <span class="kn">import</span> <span class="n">ImageObject</span><span class="p">,</span><span class="n">ImageFrame</span>
<span class="kn">from</span> <span class="nn">AstroObject.AnalyticSpectra</span> <span class="kn">import</span> <span class="n">BlackBodySpectrum</span><span class="p">,</span> <span class="n">AnalyticSpectrum</span><span class="p">,</span> <span class="n">FlatSpectrum</span>
<span class="kn">from</span> <span class="nn">AstroObject.Utilities</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">Utilities</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="s">&quot;0.1&quot;</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;update&quot;</span><span class="p">,</span><span class="s">&quot;SEDLimits&quot;</span><span class="p">,</span><span class="s">&quot;Model&quot;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A deep update command for dictionaries.</span>
<span class="sd">    This is because the normal dictionary.update() command does not handle nested dictionaries.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">{}),</span> <span class="n">v</span><span class="p">)</span>
            <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">d</span>


<span class="k">class</span> <span class="nc">SEDLimits</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A Basic Error-Differentiation Class.</span>
<span class="sd">    This error is used to express the fact that the SEDModel has encountered a spectrum which can&#39;t be placed as some part of it falls outside of the limits of the SED system.&quot;&quot;&quot;</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="Model"><a class="viewcode-back" href="../Simulator.html#SED.Model">[docs]</a><span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">ImageObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is a model container for the SEDMachine data simulator. This class is based on `AstroObject.ImageObject`, which it uses to provide some awareness of the way images are stored and retrieved. As such, this object has .save(), .select() and .show() etc. methods which can be used to examine the underlying data. It also means that this ImageObject subclass will contain the final, simulated image when the system is done.</span>
<span class="sd">    </span>
<span class="sd">    Note:: This object is not yet thread-safe, but coming versions of AstroObject will allow objects like this one to be locking and thread safe. Unfortunately, this limitation means that the simulator can generally not be run in multi-thread mode yet.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">configFile</span><span class="p">,</span><span class="n">scriptConfig</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configFile</span> <span class="o">=</span> <span class="n">configFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regenerate</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">scriptConfig</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scriptConfig</span> <span class="o">=</span> <span class="n">scriptConfig</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">scriptConfig</span><span class="p">[</span><span class="s">&quot;Cache&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">regenerate</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initLog</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configure</span><span class="p">()</span>
    
<div class="viewcode-block" id="Model.initLog"><a class="viewcode-back" href="../Simulator.html#SED.Model.initLog">[docs]</a>    <span class="k">def</span> <span class="nf">initLog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup Logging Functions for the SEDMachine Model.</span>
<span class="sd">        The logging system uses a Logs/ folder to store logs. If this folder is not present, it will not store logs.</span>
<span class="sd">        </span>
<span class="sd">        Once the logger is done initializing and configuring, it will print a starting message to the log file to differentiate between different simulation runs.</span>
<span class="sd">        </span>
<span class="sd">        Note:: There is a configuration file directive for the Log folder, but it is not respected at this point, as that would require pre-loading the configuration, without the ability to log that the configuration loading failed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
        
        <span class="n">logfolder</span> <span class="o">=</span> <span class="s">&quot;Logs/&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">__name__</span><span class="o">+</span><span class="s">&quot;-&quot;</span><span class="o">+</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">longFormat</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(asctime)s</span><span class="s"> : </span><span class="si">%(levelname)-8s</span><span class="s"> : </span><span class="si">%(funcName)-20s</span><span class="s"> : </span><span class="si">%(message)s</span><span class="s">&quot;</span>
        <span class="n">shortFormat</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%(levelname)-8s</span><span class="s">: </span><span class="si">%(message)s</span><span class="s">&#39;</span>
        <span class="n">dateFormat</span> <span class="o">=</span> <span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">-%H:%M:%S&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">captureWarnings</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consoleFormatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">shortFormat</span><span class="p">,</span><span class="n">datefmt</span><span class="o">=</span><span class="n">dateFormat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">consoleFormatter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">logfolder</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">F_OK</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">logfolder</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s">&quot;.log&quot;</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s">&quot;a&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="n">fileformatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">longFormat</span><span class="p">,</span><span class="n">datefmt</span><span class="o">=</span><span class="n">dateFormat</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">fileformatter</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;--------------------------------&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Welcome to the SED Machine model&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot; Version </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">__version__</span> <span class="p">)</span>
    
    
    <span class="c"># CONFIGURATION</span></div>
<div class="viewcode-block" id="Model.configure"><a class="viewcode-back" href="../Simulator.html#SED.Model.configure">[docs]</a>    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This is a wrapper function for a variety of private configuration steps. The configuration generall happnes in stages:</span>
<span class="sd">        - Default Values are initalized</span>
<span class="sd">        - System loads the configuration file, updating the default values with the user-selected values. If no configuration file exists, the system will move on.</span>
<span class="sd">        - System loads the configuration from the Caches directory if caching is enabled.</span>
<span class="sd">        - System adds dynamic variables to the configuration. This is the feature which handles variable units etc.</span>
<span class="sd">        </span>
<span class="sd">        To see what the default configuration file looks like, run the runner script with the --dump argument. The runner script will requrie a subcommand, but dump will cause the program to exit before recieving any subcommands for action.</span>
<span class="sd">        </span>
<span class="sd">        You can force the script to ignore cached files in the runner script using the option `--no-cache`. To regenrate the cache manually, simply delete the contents of the Caches directory&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configureDefaults</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configureFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configureCaches</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configureDynamic</span><span class="p">()</span>
    </div>
    <span class="k">def</span> <span class="nf">_configureDefaults</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set up the default configure variable. If you change the default configuration variables in this function (instead of using a configuration file), the script will generally not detect the change, and so will not regenerate Cached files. You can force the script to ignore cached files in the runner script using the option `--no-cache`. To regenrate the cache manually, simply delete the contents of the Caches directory&quot;&quot;&quot;</span>
        
        <span class="c"># Configuration Variables for The System</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;convert&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;ccd_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;image_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;tel_radii&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;tel_obsc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;psf_stdev&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c"># Unit Conversion Defaults</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;convert&quot;</span><span class="p">][</span><span class="s">&quot;pxtomm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0135</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;convert&quot;</span><span class="p">][</span><span class="s">&quot;mmtopx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">0.0135</span>
        <span class="c"># CCD / Image Plane Information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;ccd_size&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2048</span> <span class="c">#pixels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;image_size&quot;</span><span class="p">][</span><span class="s">&quot;mm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">40.0</span> <span class="c">#mm</span>
        <span class="c"># Telescope Information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;tel_radii&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.4</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;tel_obsc&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="c"># PSF Information</span>
        <span class="c"># For a gaussian PSF</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;psf_stdev&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="c"># Image Generation Density</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;density&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;padding&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="c"># Default Gain Value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;gain&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-6</span>
        <span class="c"># File Information for data and Caches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;files&quot;</span><span class="p">][</span><span class="s">&quot;lenslets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Data/xy_17nov2011_v57.TXT&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;files&quot;</span><span class="p">][</span><span class="s">&quot;dispersion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Data/dispersion_12-10-2011.txt&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;files&quot;</span><span class="p">][</span><span class="s">&quot;encircledenergy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Data/encircled_energy_4nov11.TXT&quot;</span>
        <span class="c"># MPL Plotting Save Format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;plot_format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;.pdf&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="s">&quot;defaults&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_configureFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attempt to load the default configuration from the working directory&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configFile</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Configuration File Not Found: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">configFile</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">stream</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="s">&quot;file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_configureCaches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If we are using the caching system, set up the configuration cache&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Enabling Caching&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">scriptConfig</span><span class="p">[</span><span class="s">&quot;Cache-Files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scriptConfig</span><span class="p">[</span><span class="s">&quot;Cache-Files&quot;</span><span class="p">][</span><span class="s">&quot;telescope&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scriptConfig</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">][</span><span class="s">&quot;Caches&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">configFile</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&quot;.yaml&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.tel&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scriptConfig</span><span class="p">[</span><span class="s">&quot;Cache-Files&quot;</span><span class="p">][</span><span class="s">&quot;psf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scriptConfig</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">][</span><span class="s">&quot;Caches&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">configFile</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&quot;.yaml&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.psf&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scriptConfig</span><span class="p">[</span><span class="s">&quot;Cache-Files&quot;</span><span class="p">][</span><span class="s">&quot;conv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scriptConfig</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">][</span><span class="s">&quot;Caches&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">configFile</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&quot;.yaml&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.conv&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scriptConfig</span><span class="p">[</span><span class="s">&quot;Cache-Files&quot;</span><span class="p">][</span><span class="s">&quot;config&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scriptConfig</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">][</span><span class="s">&quot;Caches&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">configFile</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="s">&quot;precached&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scriptConfig</span><span class="p">[</span><span class="s">&quot;Cache-Files&quot;</span><span class="p">][</span><span class="s">&quot;config&quot;</span><span class="p">],</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">stream</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Cached Configuration File Not Found: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">scriptConfig</span><span class="p">[</span><span class="s">&quot;Cache-Files&quot;</span><span class="p">][</span><span class="s">&quot;config&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&quot;Cached Configuration File has a Problem... skipping.&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="s">&quot;precached&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">regenearte</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Configuration has not changed, will not regenerate kernels.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Configuration appears to have changed, will regenerate kernels.&quot;</span><span class="p">)</span>
            
        
        <span class="k">return</span>
    
    <span class="k">def</span> <span class="nf">_configureDynamic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for configureDynamicValues&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="s">&quot;NoDynamic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;image_size&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;image_size&quot;</span><span class="p">][</span><span class="s">&quot;mm&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;convert&quot;</span><span class="p">][</span><span class="s">&quot;mmtopx&quot;</span><span class="p">]</span> <span class="p">,</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;ccd_size&quot;</span><span class="p">][</span><span class="s">&quot;mm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;ccd_size&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;convert&quot;</span><span class="p">][</span><span class="s">&quot;pxtomm&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;tel_radii&quot;</span><span class="p">][</span><span class="s">&quot;mm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;tel_radii&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;convert&quot;</span><span class="p">][</span><span class="s">&quot;pxtomm&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;tel_obsc&quot;</span><span class="p">][</span><span class="s">&quot;mm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;tel_obsc&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;convert&quot;</span><span class="p">][</span><span class="s">&quot;pxtomm&quot;</span><span class="p">]</span>
    
    <span class="c"># Cacheing Functions</span>
<div class="viewcode-block" id="Model.regenerateCache"><a class="viewcode-back" href="../Simulator.html#SED.Model.regenerateCache">[docs]</a>    <span class="k">def</span> <span class="nf">regenerateCache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cache calculated components of the system, including the telescope image and encircled energy image. Caches are stored to speed up system initalization. This function regenerates all cached files, including the configuration file. You can force the script to ignore cached files in the runner script using the option `--no-cache`. To regenrate the cache manually, simply delete the contents of the Caches directory&quot;&quot;&quot;</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scriptConfig</span><span class="p">[</span><span class="s">&quot;Cache-Files&quot;</span><span class="p">][</span><span class="s">&quot;config&quot;</span><span class="p">],</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="s">&quot;NoDynamic&quot;</span><span class="p">],</span><span class="n">stream</span><span class="p">,</span><span class="n">default_flow_style</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scriptConfig</span><span class="p">[</span><span class="s">&quot;Cache-Files&quot;</span><span class="p">][</span><span class="s">&quot;telescope&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">TELIMG</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scriptConfig</span><span class="p">[</span><span class="s">&quot;Cache-Files&quot;</span><span class="p">][</span><span class="s">&quot;psf&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">PSFIMG</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scriptConfig</span><span class="p">[</span><span class="s">&quot;Cache-Files&quot;</span><span class="p">][</span><span class="s">&quot;conv&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">FINIMG</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="Model.cachedKernel"><a class="viewcode-back" href="../Simulator.html#SED.Model.cachedKernel">[docs]</a>    <span class="k">def</span> <span class="nf">cachedKernel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load cached kernels from the Caches directory. If any file is missing, it will attempt to trigger regeneration of the cache.</span>
<span class="sd">        You can force the script to ignore cached files in the runner script using the option `--no-cache`. To regenrate the cache manually, simply delete the contents of the Caches directory&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Telescope Image Setup</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">TELIMG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scriptConfig</span><span class="p">[</span><span class="s">&quot;Cache-Files&quot;</span><span class="p">][</span><span class="s">&quot;telescope&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;.npy&quot;</span><span class="p">)</span>
            <span class="c"># PSF Setup</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PSFIMG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scriptConfig</span><span class="p">[</span><span class="s">&quot;Cache-Files&quot;</span><span class="p">][</span><span class="s">&quot;psf&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;.npy&quot;</span><span class="p">)</span>
            <span class="c"># Preconvolved System</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FINIMG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scriptConfig</span><span class="p">[</span><span class="s">&quot;Cache-Files&quot;</span><span class="p">][</span><span class="s">&quot;conv&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;.npy&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Cached files not found, using configuration to generate files. Error: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">regenerate</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Loaded Telescope Images for Numpy Files&quot;</span><span class="p">)</span>
            
            
        
    </div>
<div class="viewcode-block" id="Model.dumpConfig"><a class="viewcode-back" href="../Simulator.html#SED.Model.dumpConfig">[docs]</a>    <span class="k">def</span> <span class="nf">dumpConfig</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dumps a valid configuration file on top of any old configuration files. This is useful for examining the default configuration fo the system, and providing modifications through this interface.&quot;&quot;&quot;</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configFile</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="s">&quot;NoDynamic&quot;</span><span class="p">],</span><span class="n">stream</span><span class="p">,</span><span class="n">default_flow_style</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="Model.setup"><a class="viewcode-back" href="../Simulator.html#SED.Model.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;After the object has been initialized, it must be setup. Setup relies on an established configuration to determine what fixed parts of the system should be generated. Actions taken in the setup phase are:</span>
<span class="sd">        </span>
<span class="sd">        - Load data from the Cache (if enabled)</span>
<span class="sd">        - Regenerate Kernel Functions (if required)</span>
<span class="sd">        - Regenerate Cache Files (if required, and if enabled)</span>
<span class="sd">        - Load optical system data (not cached right now)</span>
<span class="sd">        - Generate a blank image (no need to cache... np.zeros is fast!)</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cachedKernel</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">regenerate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">regenerateKernel</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">regenerate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">regenerateCache</span><span class="p">()</span>
        
        <span class="c"># Get layout data from files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadOpticsData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;files&quot;</span><span class="p">][</span><span class="s">&quot;lenslets&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;files&quot;</span><span class="p">][</span><span class="s">&quot;dispersion&quot;</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_blank</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Done with SEDM setup&quot;</span><span class="p">)</span>
    
    <span class="c"># Kernel Creation for Image Manipulation</span></div>
<div class="viewcode-block" id="Model.regenerateKernel"><a class="viewcode-back" href="../Simulator.html#SED.Model.regenerateKernel">[docs]</a>    <span class="k">def</span> <span class="nf">regenerateKernel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Regenerate a kernel from the configuration valuse&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Generating Kernels for Image System&quot;</span><span class="p">)</span>
        <span class="c"># Telescope Image Setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TELIMG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tel_kern</span><span class="p">()</span>
        <span class="c"># PSF Setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PSFIMG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_psf_kern</span><span class="p">()</span>
        <span class="c"># Preconvolved System</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FINIMG</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PSFIMG</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">TELIMG</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;same&#39;</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="Model.psf_kern"><a class="viewcode-back" href="../Simulator.html#SED.Model.psf_kern">[docs]</a>    <span class="k">def</span> <span class="nf">psf_kern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates a PSF Kernel from a file with mm-encircled energy conversions&quot;&quot;&quot;</span>
        
        <span class="n">uM</span><span class="p">,</span><span class="n">FR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">skip_header</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        
        <span class="n">PX</span> <span class="o">=</span> <span class="n">uM</span> <span class="o">*</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;convert&quot;</span><span class="p">][</span><span class="s">&quot;mmtopx&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;density&quot;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">PX</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">PX</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        
        <span class="n">fit_vars</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">PX</span><span class="p">,</span><span class="n">FR</span><span class="p">)</span>
        
        <span class="n">fit</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">fit_vars</span><span class="p">,</span><span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">vfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
        
        <span class="n">x</span> <span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="o">-</span><span class="n">size</span><span class="p">:</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="n">size</span><span class="p">:</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">v</span> <span class="o">=</span> <span class="n">vfit</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        
        <span class="n">val</span> <span class="o">=</span> <span class="n">v</span>
        
        <span class="k">return</span> <span class="n">val</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="Model.circle_kern"><a class="viewcode-back" href="../Simulator.html#SED.Model.circle_kern">[docs]</a>    <span class="k">def</span> <span class="nf">circle_kern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">normalize</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a Circle Kernel&quot;&quot;&quot;</span>
        <span class="c"># This allows us to set the size of the kernel arbitrarily</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">radius</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="o">-</span><span class="n">size</span><span class="p">:</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">size</span><span class="p">:</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mf">2.0</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span> <span class="o">&lt;=</span> <span class="n">radius</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>
    </div>
<div class="viewcode-block" id="Model.gauss_kern"><a class="viewcode-back" href="../Simulator.html#SED.Model.gauss_kern">[docs]</a>    <span class="k">def</span> <span class="nf">gauss_kern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stdev</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">stdevy</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">sizey</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a normalized 2D gauss kernel array for convolutions &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">stdev</span><span class="o">**</span><span class="mf">2.0</span><span class="p">):</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">stdev</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stdevy</span><span class="p">:</span>
            <span class="n">stdevy</span> <span class="o">=</span> <span class="n">stdev</span>
        <span class="k">if</span> <span class="n">sizey</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">stdevy</span><span class="o">**</span><span class="mf">2.0</span><span class="p">):</span>
            <span class="n">sizey</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">stdevy</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sizey</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">sizey</span><span class="p">)</span>
        
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="o">-</span><span class="n">size</span><span class="p">:</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">sizey</span><span class="p">:</span><span class="n">sizey</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mf">2.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">stdev</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span><span class="o">+</span><span class="n">y</span><span class="o">**</span><span class="mf">2.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">stdevy</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)))</span>
        
        <span class="k">return</span> <span class="n">g</span> <span class="o">/</span> <span class="n">g</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    
    
    </div>
<div class="viewcode-block" id="Model.get_tel_kern"><a class="viewcode-back" href="../Simulator.html#SED.Model.get_tel_kern">[docs]</a>    <span class="k">def</span> <span class="nf">get_tel_kern</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the telescope kernel&quot;&quot;&quot;</span>
        <span class="n">TELIMG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">circle_kern</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;tel_radii&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;density&quot;</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">circle_kern</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;tel_obsc&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;density&quot;</span><span class="p">]</span> <span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;tel_radii&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;density&quot;</span><span class="p">]</span> <span class="p">,</span> <span class="bp">False</span> <span class="p">)</span>
        <span class="n">TELIMG</span> <span class="o">-=</span> <span class="n">center</span>
        <span class="n">TELIMG</span> <span class="o">=</span> <span class="n">TELIMG</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">TELIMG</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">TELIMG</span>
    </div>
<div class="viewcode-block" id="Model.get_psf_kern"><a class="viewcode-back" href="../Simulator.html#SED.Model.get_psf_kern">[docs]</a>    <span class="k">def</span> <span class="nf">get_psf_kern</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the PSF Kernel&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">PSFIMG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf_kern</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;files&quot;</span><span class="p">][</span><span class="s">&quot;encircledenergy&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Could not access encircled energy file: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">PSFIMG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gauss_kern</span><span class="p">(</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;psf_stdev&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;density&quot;</span><span class="p">])</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Loaded Encircled Energy from </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;files&quot;</span><span class="p">][</span><span class="s">&quot;encircledenergy&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">PSFIMG</span>
    
    </div>
<div class="viewcode-block" id="Model.get_blank_img"><a class="viewcode-back" href="../Simulator.html#SED.Model.get_blank_img">[docs]</a>    <span class="k">def</span> <span class="nf">get_blank_img</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an image of the correct size to use for spectrum placement&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;image_size&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;image_size&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">]))</span>
    
    </div>
<div class="viewcode-block" id="Model.get_wavelengths"><a class="viewcode-back" href="../Simulator.html#SED.Model.get_wavelengths">[docs]</a>    <span class="k">def</span> <span class="nf">get_wavelengths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lenslet_num</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an array of wavelengths for a given lenslet number&quot;&quot;&quot;</span>
        <span class="c"># This method will be the critical slow point for the whole system...</span>
        <span class="c"># It should be re-written to do the conversions in a better way, but</span>
        <span class="c"># I&#39;m not sure how to do that right now.</span>
        
        <span class="c"># First, we take only data points which apply to this lenslet</span>
        <span class="n">use</span> <span class="o">=</span> <span class="n">lenslet_num</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ix</span>
        
        <span class="c"># Each lenslet should have three points. It might not though, because we clipped some lenselet points that were too close to the edge.</span>
        <span class="c"># We really should move this logic up higher.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpix</span><span class="p">[</span><span class="n">use</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SEDLimits</span>
        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpix</span><span class="p">[</span><span class="n">use</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SEDLimits</span>
        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ypix</span><span class="p">[</span><span class="n">use</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SEDLimits</span>
        
        <span class="c"># We ignore anything that has an x-dispersion across more than 30 pixels.</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpix</span><span class="p">[</span><span class="n">use</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SEDLimits</span>
        
        <span class="c"># Interpolation to convert from wavelength to pixels.</span>
        <span class="c">#   The accuracy of this interpolation is not important.</span>
        <span class="c">#   Rather, it is used to find the pixels where the light will fall</span>
        <span class="c">#   and is fed an array that is very dense, used on this dense interpolation</span>
        <span class="c">#   and then binned back onto pixels. Thus it will be used to get a list</span>
        <span class="c">#   of all illuminated pixels.</span>
        <span class="n">fx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lams</span><span class="p">[</span><span class="n">use</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpix</span><span class="p">[</span><span class="n">use</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">fy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lams</span><span class="p">[</span><span class="n">use</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypix</span><span class="p">[</span><span class="n">use</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>
        
        <span class="c"># Find the starting and ending position of the spectra</span>
        <span class="n">startix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lams</span><span class="p">[</span><span class="n">use</span><span class="p">])</span>
        <span class="n">endix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lams</span><span class="p">[</span><span class="n">use</span><span class="p">])</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">xs</span><span class="p">[</span><span class="n">use</span><span class="p">][</span><span class="n">startix</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">ys</span><span class="p">[</span><span class="n">use</span><span class="p">][</span><span class="n">startix</span><span class="p">]])</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">xs</span><span class="p">[</span><span class="n">use</span><span class="p">][</span><span class="n">endix</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">ys</span><span class="p">[</span><span class="n">use</span><span class="p">][</span><span class="n">endix</span><span class="p">]])</span>
        
        <span class="c"># Get the total length of the spectra</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">distance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SEDLimits</span>
        
        <span class="c"># Find the length in units of (int) pixels</span>
        <span class="n">npix</span> <span class="o">=</span> <span class="p">(</span><span class="n">distance</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;convert&quot;</span><span class="p">][</span><span class="s">&quot;mmtopx&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;density&quot;</span><span class="p">]</span>
        
        <span class="c"># Create a data array one hundred times as dense as the number of pixels</span>
        <span class="c">#   This is the super dense array which will use the above interpolation</span>
        <span class="n">superDense_lam</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lams</span><span class="p">[</span><span class="n">use</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lams</span><span class="p">[</span><span class="n">use</span><span class="p">]),</span><span class="n">npix</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
        
        <span class="c"># Interpolate along our really dense set of wavelengths to find all possible</span>
        <span class="c"># illuminated pixel positions in this spectrum</span>
        <span class="n">superDense_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fx</span><span class="p">(</span><span class="n">superDense_lam</span><span class="p">),</span><span class="n">fy</span><span class="p">(</span><span class="n">superDense_lam</span><span class="p">)])</span>
        
        <span class="c"># Measure the distance along our really dense set of points</span>
        <span class="n">superDense_interval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">superDense_pts</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="mi">2</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">superDense_distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">superDense_interval</span><span class="p">)</span>
        
        <span class="c"># Adjust the density of our points. This rounds all values to only full pixel values.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;density&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">superDense_pts</span> <span class="o">=</span> <span class="n">superDense_pts</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">superDense_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">superDense_pts</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;density&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;density&quot;</span><span class="p">]</span>
            <span class="n">superDense_int</span> <span class="o">=</span> <span class="p">(</span><span class="n">superDense_pts</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;density&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        
        <span class="c"># We can identify unique points using the points when the integer position ratchets up or down.</span>
        <span class="n">unique_x</span><span class="p">,</span><span class="n">unique_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">superDense_int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
        
        <span class="c"># We want unique index to include points where either &#39;y&#39; or &#39;x&#39; ratchets up or down</span>
        <span class="n">unique_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">unique_x</span><span class="p">,</span><span class="n">unique_y</span><span class="p">)</span>
        
        <span class="c"># Remove any duplicate points. This does not do so in order, so we must</span>
        <span class="c"># sort the array of unique points afterwards...</span>
        <span class="n">unique_pts</span> <span class="o">=</span> <span class="n">superDense_pts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:][:,</span><span class="n">unique_idx</span><span class="p">]</span>
        
        <span class="c"># An array of distances to the origin of this spectrum, can be used to find wavelength</span>
        <span class="c"># of light at each distance</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">superDense_distance</span><span class="p">[</span><span class="n">unique_idx</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;convert&quot;</span><span class="p">][</span><span class="s">&quot;pxtomm&quot;</span><span class="p">]</span>
        
        <span class="c"># Re sort everything by distnace along the trace.</span>
        <span class="c"># Strictly, this shouldn&#39;t be necessary if all of the above functions preserved order.</span>
        <span class="n">sorted_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>
        
        <span class="c"># Pull out sorted valuses</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">distance</span><span class="p">[</span><span class="n">sorted_idx</span><span class="p">]</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">unique_pts</span><span class="p">[:,</span><span class="n">sorted_idx</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Points set using original, superDense array, bounds [</span><span class="si">%1.4f</span><span class="s">,</span><span class="si">%1.4f</span><span class="s">]&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points</span><span class="p">)))</span>
        
        
        <span class="c"># Pull out the original wavelengths</span>
        <span class="n">wl_orig</span> <span class="o">=</span> <span class="n">superDense_lam</span><span class="p">[</span><span class="n">unique_idx</span><span class="p">][</span><span class="n">sorted_idx</span><span class="p">]</span>
        <span class="n">wl</span> <span class="o">=</span> <span class="n">wl_orig</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Wavelengths set using original, superDense array, bounds [</span><span class="si">%1.4f</span><span class="s">,</span><span class="si">%1.4f</span><span class="s">]&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">wl</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">wl</span><span class="p">)))</span>
        <span class="c"># We are getting some odd behavior, where the dispersion function seems to not cover the whole</span>
        <span class="c"># arc length and instead covers only part of it. This causes much of our arc to leave the desired</span>
        <span class="c"># and available wavelength boundaries. As such, I&#39;m disabling the more accurate dispersion mode.</span>
        
        <span class="c"># Convert to wavelength space along the dispersion spline.</span>
        <span class="c"># wl = self.spline(distance)</span>
        
        <span class="c"># This is a debugging area which will make a lot of graphs and annoying messages.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">getEffectiveLevel</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Plotting Wavelength Information&quot;</span><span class="p">)</span>
            <span class="c"># This graph shows the change in distance along arc per pixel.</span>
            <span class="c"># The graph should produce all data points close to each other, except a variety of much lower</span>
            <span class="c"># data points which are caused by the arc crossing between pixels.</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;$\Delta$Distance Along Arc&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;x (px)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;$\Delta$Distance along arc (px)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">points</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;convert&quot;</span><span class="p">][</span><span class="s">&quot;mmtopx&quot;</span><span class="p">],</span><span class="s">&#39;g.&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&quot;Partials/</span><span class="si">%04d</span><span class="s">-Distances_Diff</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lenslet_num</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;plot_format&quot;</span><span class="p">]))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">points</span><span class="p">,</span><span class="n">wl</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">wl</span><span class="p">)</span>
    
    </div>
<div class="viewcode-block" id="Model.loadDispersionData"><a class="viewcode-back" href="../Simulator.html#SED.Model.loadDispersionData">[docs]</a>    <span class="k">def</span> <span class="nf">loadDispersionData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dispspec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This loads the dispersion data. Dispersion data is provided in mm along the spectrum and wavelength. This method saves both the raw data (in :attr:`self.MM` and :attr:`self.WL`) as well as functions which can be used to convert across the dispersion. Functions by default take a mm position and return the wavelength at this position.&quot;&quot;&quot;</span>
        <span class="n">WLtoMM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">dispspec</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">WL</span> <span class="o">=</span> <span class="n">WLtoMM</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">MM</span> <span class="o">=</span> <span class="n">WLtoMM</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">MM</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">MM</span><span class="p">)</span> <span class="c">#Zero offset the MM data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MM</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">WL</span> <span class="o">=</span> <span class="n">MM</span><span class="p">,</span><span class="n">WL</span>
        
        <span class="c"># A note about functions:</span>
        <span class="c">#</span>
        <span class="c"># All of these functions will return the wavelength of a position, in milimeters,</span>
        <span class="c"># from the origin of the spectrum. We define the origin of the spectrum as the</span>
        <span class="c"># postion where the 0.37 micron wavelength falls.</span>
        
        <span class="c"># Define a basic Floor function interpolation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">floor</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ax</span><span class="p">:</span> <span class="n">MM</span><span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ax</span><span class="o">-</span><span class="n">WL</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()])(</span><span class="n">x</span><span class="p">)</span>
        <span class="c"># Define a piecewise linear interpolation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">WL</span><span class="p">,</span><span class="n">MM</span><span class="p">)</span>
        <span class="c"># Generate the SPLINE function:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spvars</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">MM</span><span class="p">,</span><span class="n">WL</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speval</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speval</span><span class="o">.</span><span class="n">bounds_error</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spline</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">speval</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">spvars</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="Model.loadLensletData"><a class="viewcode-back" href="../Simulator.html#SED.Model.loadLensletData">[docs]</a>    <span class="k">def</span> <span class="nf">loadLensletData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">laspec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for Load Lenselt Data&quot;&quot;&quot;</span>
        <span class="c"># Load Lenslet Specification File</span>
        <span class="n">ix</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">lams</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">laspec</span><span class="p">,</span><span class="n">skip_header</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="c"># This data describes the following:</span>
        <span class="c"># ix - Index (number)</span>
        <span class="c"># p1 - Pupil position in the x-direction</span>
        <span class="c"># p2 - Pupil position in the y-direction</span>
        <span class="c"># lams - wavelengths for this position</span>
        <span class="c"># xs - X position (in mm, offest from top right corner) of this wavelength</span>
        <span class="c"># ys - Y Position (in mm, offset from top right corner) of this wavelength</span>
        
        <span class="c"># Correctly Type Lenslet Specification Data</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">ix</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span> <span class="c">#Indicies should always be integers</span>
        
        <span class="c"># Center xs and ys on detector with a corner at 0,0</span>
        <span class="n">xs</span> <span class="o">+=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;image_size&quot;</span><span class="p">][</span><span class="s">&quot;mm&quot;</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ys</span> <span class="o">+=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;image_size&quot;</span><span class="p">][</span><span class="s">&quot;mm&quot;</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="c"># Find the xs and ys that are not within 0.1 mm of the edge of the detector...</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">xs</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">xs</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;image_size&quot;</span><span class="p">][</span><span class="s">&quot;mm&quot;</span><span class="p">]</span><span class="o">-</span><span class="mf">0.1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ys</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ys</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;image_size&quot;</span><span class="p">][</span><span class="s">&quot;mm&quot;</span><span class="p">]</span><span class="o">-</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">ix</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">lams</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">ix</span><span class="p">[</span><span class="n">ok</span><span class="p">],</span> <span class="n">p1</span><span class="p">[</span><span class="n">ok</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="n">ok</span><span class="p">],</span> <span class="n">lams</span><span class="p">[</span><span class="n">ok</span><span class="p">],</span> <span class="n">xs</span><span class="p">[</span><span class="n">ok</span><span class="p">],</span> <span class="n">ys</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>
        <span class="c"># We remove these positions because we don&#39;t want to generate spectra for them.</span>
        
        <span class="c"># This simply generates a list of all of the lenslets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lenslets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span>
        
        <span class="c"># Convert the xs and ys to pixel positions</span>
        <span class="n">xpix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">xs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;convert&quot;</span><span class="p">][</span><span class="s">&quot;mmtopx&quot;</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        <span class="n">ypix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ys</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;convert&quot;</span><span class="p">][</span><span class="s">&quot;mmtopx&quot;</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        
        <span class="c"># Determine the center of the whole system by finding the x position that is closest to 0,0 in pupil position</span>
        <span class="n">cntix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">p1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="n">cntix</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;convert&quot;</span><span class="p">][</span><span class="s">&quot;mmtopx&quot;</span><span class="p">],</span> <span class="n">ys</span><span class="p">[</span><span class="n">cntix</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;convert&quot;</span><span class="p">][</span><span class="s">&quot;mmtopx&quot;</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lams</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ys</span> <span class="o">=</span> <span class="n">ix</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">lams</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xpix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypix</span> <span class="o">=</span> <span class="n">xpix</span><span class="p">,</span> <span class="n">ypix</span>
    </div>
<div class="viewcode-block" id="Model.loadOpticsData"><a class="viewcode-back" href="../Simulator.html#SED.Model.loadOpticsData">[docs]</a>    <span class="k">def</span> <span class="nf">loadOpticsData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">laspec</span><span class="p">,</span><span class="n">dispspec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Loads an optical conversion based on the lenslet array spec and dispersion spec files provided&quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">loadDispersionData</span><span class="p">(</span><span class="n">dispspec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadLensletData</span><span class="p">(</span><span class="n">laspec</span><span class="p">)</span>
    
    </div>
<div class="viewcode-block" id="Model.get_dense_image"><a class="viewcode-back" href="../Simulator.html#SED.Model.get_dense_image">[docs]</a>    <span class="k">def</span> <span class="nf">get_dense_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lenslet</span><span class="p">,</span><span class="n">spectrum</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function returns a dense image array, with flux placed into single pixels.&quot;&quot;&quot;</span>
        <span class="n">points</span><span class="p">,</span> <span class="n">wl</span><span class="p">,</span> <span class="n">deltawl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wavelengths</span><span class="p">(</span><span class="n">lenslet</span><span class="p">)</span>
        <span class="c"># Some notes about this function:</span>
        <span class="c">#  points:  These points are in normal CCD Pixel units, but are not integers,</span>
        <span class="c">#           as they correspond to dense pixels on the overdense images</span>
        <span class="c">#  wl:      A list of wavelengths that correspond to the points above</span>
        <span class="c">#  deltawl: The np.diff(wl) result, which can be used to handle the flux per pixel</span>
        
        <span class="c"># Create the spectra, by calling the spectra with wavelength</span>
        <span class="c"># (in meters, note the conversion from wl, which was originally in microns)</span>
        <span class="c"># Then use the deltawl to get the true amount of flux in each pixel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Asking for spectrum with bounds [</span><span class="si">%1.4e</span><span class="s">,</span><span class="si">%1.4e</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">wl</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">wl</span><span class="p">)))</span>
        <span class="n">radiance</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">(</span><span class="n">wl</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-6</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;gain&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Generated spectrum with bounds [</span><span class="si">%1.4e</span><span class="s">,</span><span class="si">%1.4e</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">radiance</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">radiance</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Re-scaling Radiance by deltawl with bounds [</span><span class="si">%1.4e</span><span class="s">,</span><span class="si">%1.4e</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">deltawl</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">deltawl</span><span class="p">)))</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">radiance</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">*</span> <span class="n">deltawl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Got Flux with bounds [</span><span class="si">%1.4e</span><span class="s">,</span><span class="si">%1.4e</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flux</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">flux</span><span class="p">)))</span>
        
        <span class="c"># This debugging area generates plots for us.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">getEffectiveLevel</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Generating Plots for Spectra...&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wl</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">flux</span><span class="p">,</span><span class="s">&quot;b.&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Generated, Fluxed Spectra&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Wavelength ($\mu m$)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;Flux (Units undefined)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&quot;Partials/</span><span class="si">%04d</span><span class="s">-SpecFlux</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lenslet</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;plot_format&quot;</span><span class="p">]))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wl</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">deltawl</span><span class="p">,</span><span class="s">&quot;g.&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;$\Delta\lambda$ for each pixel&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Wavelength ($\mu m$)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;$\Delta\lambda$ per pixel&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&quot;Partials/</span><span class="si">%04d</span><span class="s">-SpecDeltaWL</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lenslet</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;plot_format&quot;</span><span class="p">]))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        
        <span class="c"># Take our points out. Note from the above that we multiply by the density in order to do this</span>
        <span class="n">xorig</span><span class="p">,</span><span class="n">yorig</span> <span class="o">=</span> <span class="p">(</span><span class="n">points</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;density&quot;</span><span class="p">])[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">points</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;density&quot;</span><span class="p">])[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        <span class="c"># Get the way in which those points correspond to actual pixels.</span>
        <span class="c"># As such, this array of points should have duplicates</span>
        <span class="n">xint</span><span class="p">,</span><span class="n">yint</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        
        <span class="c"># Zero-adjust our x and y points. They will go into a fake subimage anyways, so we don&#39;t care</span>
        <span class="c"># for now where they would be on the real image</span>
        <span class="n">x</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        
        <span class="c"># Get the approximate size of our spectra</span>
        <span class="n">xdist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">ydist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        
        <span class="c"># Convert this size into an integer number of pixels for our subimage. This makes it</span>
        <span class="c"># *much* easier to register our sub-image to the master, larger pixel image</span>
        <span class="n">xdist</span> <span class="o">+=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;density&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">xdist</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;density&quot;</span><span class="p">])</span>
        <span class="n">ydist</span> <span class="o">+=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;density&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ydist</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;density&quot;</span><span class="p">])</span>
        
        <span class="c"># Move our x and y coordinates to the middle of our sub image by applying padding below each one.</span>
        <span class="n">x</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;padding&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;density&quot;</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;padding&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;density&quot;</span><span class="p">]</span>
        
        <span class="c"># Find the first (by the flatten method) corner of the subimage,</span>
        <span class="c"># useful for placing the sub-image into the full image.</span>
        <span class="n">corner</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">xint</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">x</span><span class="p">)],</span> <span class="n">yint</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">y</span><span class="p">)]])</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Corner Position in Integer Space: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">corner</span><span class="p">)</span>
        <span class="n">corner</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;density&quot;</span><span class="p">]</span>
        <span class="n">realcorner</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">xorig</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">x</span><span class="p">)],</span> <span class="n">yorig</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">y</span><span class="p">)]])</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">corner</span> <span class="o">-</span> <span class="n">realcorner</span>
        <span class="n">corner</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;density&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Corner Position Offset in Dense Space: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">offset</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">getEffectiveLevel</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="n">handle</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="s">&quot;Partials/Offsets.dat&quot;</span><span class="p">,</span><span class="s">&#39;a&#39;</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span><span class="n">offset</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">corner</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;padding&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;padding&quot;</span><span class="p">]])</span>
        
        <span class="n">x</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c"># Create our sub-image, using the x and y width of the spectrum, plus 2 padding widths.</span>
        <span class="c"># Padding is specified in full-size pixels to ensure that the final image is an integer</span>
        <span class="c"># number of full-size pixels across.</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">xdist</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;padding&quot;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;density&quot;</span><span class="p">],</span><span class="n">ydist</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;padding&quot;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;density&quot;</span><span class="p">]))</span>
        
        <span class="c"># Place the spectrum into the sub-image</span>
        <span class="n">img</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Placing flux (shape: </span><span class="si">%s</span><span class="s"> ) for spectrum </span><span class="si">%4d</span><span class="s"> into a sub-image (shape: </span><span class="si">%s</span><span class="s">).&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">flux</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">lenslet</span><span class="p">,</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">getEffectiveLevel</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s">&quot;Partials/SubimageValues.dat&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">wl</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">deltawl</span><span class="p">,</span><span class="n">flux</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">corner</span>
    
    </div>
<div class="viewcode-block" id="Model.get_sub_image"><a class="viewcode-back" href="../Simulator.html#SED.Model.get_sub_image">[docs]</a>    <span class="k">def</span> <span class="nf">get_sub_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lenslet</span><span class="p">,</span><span class="n">spectrum</span><span class="p">,</span><span class="n">fast</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a sub-image for a given lenslet&quot;&quot;&quot;</span>
        <span class="c"># This function gets the dense sub-image with the spectrum placed in single dense pixels</span>
        <span class="n">img</span><span class="p">,</span><span class="n">corner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dense_image</span><span class="p">(</span><span class="n">lenslet</span><span class="p">,</span><span class="n">spectrum</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Retrieved Dense Image for </span><span class="si">%4d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">lenslet</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">fast</span><span class="p">:</span>
            <span class="c"># Convolve with the PSF and Telescope Image simultaneously</span>
            <span class="n">img2</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">FINIMG</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;same&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Convolved Dense Image with PSF and Telescope for </span><span class="si">%4d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">lenslet</span><span class="p">)</span>
            <span class="c"># Bin the image back down to the final pixel size</span>
            <span class="n">small</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;density&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Binned Dense Image to Actual Size for </span><span class="si">%4d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">lenslet</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">small</span><span class="p">,</span><span class="n">corner</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Convolve this spectrum with an appropriate image of the telescope</span>
            <span class="n">img_tel</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">TELIMG</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;same&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Convolved Dense Image with Telescope for </span><span class="si">%4d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">lenslet</span><span class="p">)</span>
            <span class="c"># Convolve again with an appropriate PSF</span>
            <span class="n">img_tel_psf</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">img_tel</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">PSFIMG</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;same&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Convolved Dense Image with PSF for </span><span class="si">%4d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">lenslet</span><span class="p">)</span>
            <span class="c"># Bin the image back down to the final pixel size</span>
            <span class="n">small</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">(</span><span class="n">img_tel_psf</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;density&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Binned Dense Image for </span><span class="si">%4d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">lenslet</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">small</span><span class="p">,</span><span class="n">corner</span><span class="p">,(</span><span class="n">img</span><span class="p">,</span><span class="n">img_tel</span><span class="p">,</span><span class="n">img_tel_psf</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="Model.cache_sed_subimage"><a class="viewcode-back" href="../Simulator.html#SED.Model.cache_sed_subimage">[docs]</a>    <span class="k">def</span> <span class="nf">cache_sed_subimage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lenslet</span><span class="p">,</span><span class="n">spectrum</span><span class="p">,</span><span class="n">write</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">do_return</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates a sub image, and saves that result to this object. Should be thread-safe.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">getEffectiveLevel</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="n">small</span><span class="p">,</span> <span class="n">corner</span><span class="p">,</span> <span class="n">steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sub_image</span><span class="p">(</span><span class="n">lenslet</span><span class="p">,</span><span class="n">spectrum</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">small</span><span class="p">,</span> <span class="n">corner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sub_image</span><span class="p">(</span><span class="n">lenslet</span><span class="p">,</span><span class="n">spectrum</span><span class="p">,</span><span class="n">fast</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Retrieved SED Subimage for lenslet </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">lenslet</span><span class="p">)</span>
        
        <span class="n">label</span> <span class="o">=</span> <span class="s">&quot;SUBIMG</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">lenslet</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">small</span><span class="p">,</span><span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span><span class="o">.</span><span class="n">header</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">Lenslet</span><span class="o">=</span><span class="n">lenslet</span><span class="p">,</span><span class="n">Spectrum</span><span class="o">=</span><span class="n">spectrum</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span><span class="o">.</span><span class="n">metadata</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">Corner</span><span class="o">=</span><span class="n">corner</span><span class="p">)</span>
        
        <span class="n">Stages</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;Raw Image&quot;</span><span class="p">,</span><span class="s">&quot;Convolved with Telescope&quot;</span><span class="p">,</span><span class="s">&quot;Convolved with Telescope and PSF&quot;</span><span class="p">]</span>
        <span class="n">StagesF</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;Raw&quot;</span><span class="p">,</span><span class="s">&quot;Tel&quot;</span><span class="p">,</span><span class="s">&quot;PSF&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">getEffectiveLevel</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">step</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">step</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%04d</span><span class="s">-Intermediate-</span><span class="si">%d</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lenslet</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">Stages</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span><span class="o">.</span><span class="n">header</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">Lenslet</span><span class="o">=</span><span class="n">lenslet</span><span class="p">,</span><span class="n">Spectrum</span><span class="o">=</span><span class="n">spectrum</span><span class="o">.</span><span class="n">label</span><span class="p">,</span><span class="n">Stage</span><span class="o">=</span><span class="n">Stages</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span><span class="o">.</span><span class="n">metadata</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">Corner</span><span class="o">=</span><span class="n">corner</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> Image Generation Steps for Lenslet </span><span class="si">%4d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Stages</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">lenslet</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&quot;Partials/</span><span class="si">%04d</span><span class="s">-</span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lenslet</span><span class="p">,</span><span class="n">StagesF</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;plot_format&quot;</span><span class="p">]))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        
        <span class="c"># We only write the sub-image if the function is called to write sub images</span>
        <span class="k">if</span> <span class="n">write</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Images/Subimage-</span><span class="si">%4d%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lenslet</span><span class="p">,</span><span class="s">&quot;.fits&quot;</span><span class="p">),</span><span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keep</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">do_return</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">small</span><span class="p">,</span> <span class="n">corner</span>
        <span class="k">return</span>
    </div>
<div class="viewcode-block" id="Model.place_cached_sed"><a class="viewcode-back" href="../Simulator.html#SED.Model.place_cached_sed">[docs]</a>    <span class="k">def</span> <span class="nf">place_cached_sed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lenslet</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="n">dlabel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Places a cached SED Subimage&quot;&quot;&quot;</span>
        <span class="n">slabel</span> <span class="o">=</span> <span class="s">&quot;SUBIMG</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">lenslet</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">subframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SEDLimits</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">subimg</span> <span class="o">=</span> <span class="n">subframe</span><span class="p">()</span>
        <span class="n">mlenslet</span> <span class="o">=</span> <span class="n">subframe</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;Lenslet&#39;</span><span class="p">]</span>
        <span class="n">mcorner</span> <span class="o">=</span> <span class="n">subframe</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s">&#39;Corner&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mlenslet</span> <span class="o">!=</span> <span class="n">lenslet</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Lenslet Number Mismatch </span><span class="si">%d</span><span class="s">:</span><span class="si">%d</span><span class="s"> for state </span><span class="si">%s</span><span class="s"> in </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lenslet</span><span class="p">,</span><span class="n">mlenslet</span><span class="p">,</span><span class="n">slabel</span><span class="p">,</span><span class="bp">self</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">subimg</span><span class="p">,</span><span class="n">mcorner</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="n">dlabel</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="Model.place_sed"><a class="viewcode-back" href="../Simulator.html#SED.Model.place_sed">[docs]</a>    <span class="k">def</span> <span class="nf">place_sed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lenslet</span><span class="p">,</span><span class="n">spectrum</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="n">dlabel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Place an SED based on a lenslet number and a spectrum&quot;&quot;&quot;</span>
        <span class="n">small</span><span class="p">,</span> <span class="n">corner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sub_image</span><span class="p">(</span><span class="n">lenslet</span><span class="p">,</span><span class="n">spectrum</span><span class="p">,</span><span class="n">fast</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c"># Place uses the corner position to insert a sub-image into the master image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">small</span><span class="p">,</span><span class="n">corner</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="n">dlabel</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="Model.place"><a class="viewcode-back" href="../Simulator.html#SED.Model.place">[docs]</a>    <span class="k">def</span> <span class="nf">place</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">img</span><span class="p">,</span><span class="n">corner</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="n">dlabel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Place the given AstroObject.AnalyticSpectra.AnalyticSpectrum onto the SEDMachine Image&quot;&quot;&quot;</span>
        
        <span class="n">xstart</span> <span class="o">=</span> <span class="n">corner</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">xend</span> <span class="o">=</span> <span class="n">xstart</span> <span class="o">+</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ystart</span> <span class="o">=</span> <span class="n">corner</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">yend</span> <span class="o">=</span> <span class="n">ystart</span> <span class="o">+</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">dlabel</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">xend</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">yend</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SEDLimits</span>
        
        <span class="k">if</span> <span class="n">xstart</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">ystart</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SEDLimits</span>
        
        <span class="k">if</span> <span class="n">xend</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">yend</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SEDLimits</span>
        
        <span class="n">data</span><span class="p">[</span><span class="n">xstart</span><span class="p">:</span><span class="n">xend</span><span class="p">,</span><span class="n">ystart</span><span class="p">:</span><span class="n">yend</span><span class="p">]</span> <span class="o">+=</span> <span class="n">img</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dlabel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">dlabel</span><span class="p">)</span>
    
    </div>
<div class="viewcode-block" id="Model.generate_blank"><a class="viewcode-back" href="../Simulator.html#SED.Model.generate_blank">[docs]</a>    <span class="k">def</span> <span class="nf">generate_blank</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates a blank SEDMachine Image&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;image_size&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;image_size&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span><span class="s">&quot;Blank&quot;</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="Model.crop"><a class="viewcode-back" href="../Simulator.html#SED.Model.crop">[docs]</a>    <span class="k">def</span> <span class="nf">crop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">xsize</span><span class="p">,</span><span class="n">ysize</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Crops the provided image to twice the specified size, centered around the x and y coordinates provided.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ysize</span><span class="p">:</span>
            <span class="n">ysize</span> <span class="o">=</span> <span class="n">xsize</span>
        <span class="n">cropped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">statename</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="n">xsize</span><span class="p">:</span><span class="n">x</span><span class="o">+</span><span class="n">xsize</span><span class="p">,</span><span class="n">y</span><span class="o">-</span><span class="n">ysize</span><span class="p">:</span><span class="n">y</span><span class="o">+</span><span class="n">ysize</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Cropped and Saved Image&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">cropped</span><span class="p">,</span><span class="s">&quot;Cropped&quot;</span><span class="p">)</span>
    
</pre></div></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li><a href="../index.html">SEDMachine 0.1.1 documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Alexander Rudy.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>