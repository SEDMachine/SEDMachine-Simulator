

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>SEDMachine.Simulator &mdash; SEDMsim 0.3.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.3.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="SEDMsim 0.3.0 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">SEDMsim 0.3.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for SEDMachine.Simulator</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c"># </span>
<span class="c">#  Simulator.py</span>
<span class="c">#  SEDM-Dev</span>
<span class="c">#  </span>
<span class="c">#  Created by Alexander Rudy on 2012-02-08.</span>
<span class="c">#  Copyright 2012 Alexander Rudy. All rights reserved.</span>
<span class="c">#  Version 0.3.0</span>
<span class="c"># </span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="c"># import pyfits as pf</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="kn">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="kn">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">scipy.signal</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="kn">import</span> <span class="nn">shapely</span> <span class="kn">as</span> <span class="nn">sh</span>
<span class="kn">import</span> <span class="nn">shapely.geometry</span>

<span class="kn">import</span> <span class="nn">arpytools.progressbar</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span><span class="o">,</span><span class="nn">logging.handlers</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">gc</span>

<span class="kn">import</span> <span class="nn">AstroObject</span>
<span class="kn">from</span> <span class="nn">AstroObject.AstroSimulator</span> <span class="kn">import</span> <span class="n">Simulator</span>
<span class="kn">from</span> <span class="nn">AstroObject.AstroCache</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">AstroObject.AstroConfig</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">AstroObject.AstroSpectra</span> <span class="kn">import</span> <span class="n">SpectraObject</span><span class="p">,</span><span class="n">SpectraFrame</span>
<span class="kn">from</span> <span class="nn">AstroObject.AstroImage</span> <span class="kn">import</span> <span class="n">ImageObject</span><span class="p">,</span><span class="n">ImageFrame</span>
<span class="kn">from</span> <span class="nn">AstroObject.AnalyticSpectra</span> <span class="kn">import</span> <span class="n">BlackBodySpectrum</span><span class="p">,</span><span class="n">GaussianSpectrum</span><span class="p">,</span> <span class="n">AnalyticSpectrum</span><span class="p">,</span> <span class="n">FlatSpectrum</span><span class="p">,</span> <span class="n">InterpolatedSpectrum</span><span class="p">,</span> <span class="n">UnitarySpectrum</span>
<span class="kn">from</span> <span class="nn">AstroObject.Utilities</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">Lenslet</span> <span class="kn">import</span> <span class="o">*</span>


<div class="viewcode-block" id="SEDSimulator"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator">[docs]</a><span class="k">class</span> <span class="nc">SEDSimulator</span><span class="p">(</span><span class="n">Simulator</span><span class="p">,</span><span class="n">ImageObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A simulator for the SED Machine&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SEDSimulator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;SEDMachine&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataClasses</span> <span class="o">=</span> <span class="p">[</span><span class="n">SubImage</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lenslets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span> <span class="o">=</span> <span class="n">SpectraObject</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">dataClasses</span> <span class="o">+=</span> <span class="p">[</span><span class="n">AnalyticSpectrum</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basics</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">merge</span><span class="p">({</span><span class="s">&quot;Instrument&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span><span class="s">&quot;Caches&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">caches</span><span class="p">,</span><span class="s">&quot;Source&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span><span class="s">&quot;Observation&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">setFile</span><span class="p">(</span><span class="s">&quot;Main&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_stages</span><span class="p">()</span>

    
    <span class="n">basics</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;Debug&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&quot;Plots&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;format&#39;</span><span class="p">:</span> <span class="s">&#39;.pdf&#39;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s">&quot;Output&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&quot;Label&quot;</span><span class="p">:</span> <span class="s">&quot;Generated&quot;</span><span class="p">,</span>
            <span class="s">&quot;Format&quot;</span><span class="p">:</span> <span class="s">&quot;fits&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s">&quot;Configurations&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&quot;Main&quot;</span> <span class="p">:</span> <span class="s">&quot;SED.main.config.yaml&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s">&quot;Dirs&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&quot;Logs&quot;</span><span class="p">:</span> <span class="s">&quot;Logs&quot;</span><span class="p">,</span>
            <span class="s">&quot;Partials&quot;</span> <span class="p">:</span> <span class="s">&quot;Partials&quot;</span><span class="p">,</span>
            <span class="s">&quot;Caches&quot;</span> <span class="p">:</span> <span class="s">&quot;Caches&quot;</span><span class="p">,</span>
            <span class="s">&quot;Images&quot;</span> <span class="p">:</span> <span class="s">&quot;Images&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s">&quot;Lenslets&quot;</span> <span class="p">:</span> <span class="p">{},</span>
        <span class="s">&#39;logging&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;console&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;level&#39;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> 
                <span class="s">&#39;enable&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> 
                <span class="s">&#39;format&#39;</span><span class="p">:</span> <span class="s">&#39;</span><span class="si">%(levelname)-8s</span><span class="s">... </span><span class="si">%(message)s</span><span class="s">&#39;</span>
            <span class="p">},</span>
            <span class="s">&#39;growl&#39;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;enable&#39;</span> <span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                <span class="s">&#39;name&#39;</span> <span class="p">:</span> <span class="s">&quot;SED Machine Simulator&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s">&#39;file&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;format&#39;</span><span class="p">:</span> <span class="s">&#39;</span><span class="si">%(asctime)s</span><span class="s"> : </span><span class="si">%(levelname)-8s</span><span class="s"> : </span><span class="si">%(funcName)-20s</span><span class="s"> : </span><span class="si">%(message)s</span><span class="s">&#39;</span><span class="p">,</span>
                <span class="s">&#39;enable&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> 
                <span class="s">&#39;filename&#39;</span><span class="p">:</span> <span class="s">&#39;SEDMachine&#39;</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">}</span>
    
    <span class="n">caches</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;Telescope&#39;</span> <span class="p">:</span> <span class="s">&quot;SED.tel.npy&quot;</span><span class="p">,</span>
        <span class="s">&#39;PSF&#39;</span> <span class="p">:</span> <span class="s">&quot;SED.psf.npy&quot;</span><span class="p">,</span>
        <span class="s">&#39;CONV&#39;</span> <span class="p">:</span> <span class="s">&quot;SED.conv.npy&quot;</span><span class="p">,</span>
        <span class="s">&#39;config&#39;</span> <span class="p">:</span> <span class="s">&quot;SED.config.yaml&quot;</span><span class="p">,</span>
        <span class="s">&#39;const&#39;</span> <span class="p">:</span> <span class="s">&quot;SED.const.yaml&quot;</span>
    <span class="p">}</span>
    
    <span class="n">observation</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;exposure&#39;</span> <span class="p">:</span> <span class="mi">1200</span><span class="p">,</span>
        <span class="s">&#39;number&#39;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s">&#39;airmass&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s">&#39;Sky&#39;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;Use&#39;</span> <span class="p">:</span> <span class="s">&quot;TurnroseSKY&quot;</span><span class="p">,</span>
            <span class="s">&#39;Atmosphere&#39;</span> <span class="p">:</span> <span class="s">&quot;Atmosph&quot;</span><span class="p">,</span>
            <span class="s">&#39;Files&#39;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;Massey&#39;</span> <span class="p">:</span> <span class="s">&quot;SEDSpec2/MasseySky.fits&quot;</span><span class="p">,</span>
                <span class="s">&#39;Quimby&#39;</span> <span class="p">:</span> <span class="s">&quot;SEDSpec2/Quimby.fits&quot;</span><span class="p">,</span>
                <span class="s">&#39;HansuchikUVES&#39;</span> <span class="p">:</span> <span class="s">&quot;SEDSpec2/HansuchikUVES.fits&quot;</span><span class="p">,</span>
                <span class="s">&#39;TurnroseSKY&#39;</span> <span class="p">:</span> <span class="s">&quot;SEDSpec2/TurnroseSKY.fits&quot;</span><span class="p">,</span>
                <span class="s">&#39;PALext&#39;</span> <span class="p">:</span> <span class="s">&quot;SEDSpec2/atmosphere.fits&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="s">&#39;Moon&#39;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;Phase&#39;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="p">},</span>
        
        
    <span class="p">}</span>
    
    
    <span class="n">instrument</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;files&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;dispersion&#39;</span><span class="p">:</span> <span class="s">&#39;Data/dispersion_12-10-2011.txt&#39;</span><span class="p">,</span>
            <span class="s">&#39;encircledenergy&#39;</span><span class="p">:</span> <span class="s">&#39;Data/encircled_energy_4nov11.TXT&#39;</span><span class="p">,</span>
            <span class="s">&#39;lenslets&#39;</span><span class="p">:</span> <span class="s">&#39;Data/xy_17nov2011_v57.TXT&#39;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s">&#39;camera&#39;</span> <span class="p">:</span> <span class="s">&quot;PI&quot;</span><span class="p">,</span>
        <span class="s">&#39;convert&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;pxtomm&#39;</span><span class="p">:</span> <span class="mf">0.0135</span> <span class="p">},</span> 
        <span class="s">&#39;density&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s">&#39;dispfitorder&#39;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> 
        <span class="s">&#39;tel_obsc&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;px&#39;</span><span class="p">:</span> <span class="mf">0.2</span> <span class="p">,</span> <span class="s">&#39;ratio&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span> 
        <span class="s">&#39;plot&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> 
        <span class="s">&#39;ccd_size&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;px&#39;</span><span class="p">:</span> <span class="mi">2048</span><span class="p">},</span> 
        <span class="s">&#39;padding&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> 
        <span class="s">&#39;psf_stdev&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;px&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">},</span> 
        <span class="s">&#39;bias&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> 
        <span class="s">&#39;psf_size&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s">&#39;px&#39;</span><span class="p">:</span> <span class="mf">2.4</span><span class="p">},</span> 
        <span class="s">&#39;image_size&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s">&#39;mm&#39;</span><span class="p">:</span> <span class="mf">40.0</span><span class="p">},</span> 
        <span class="s">&#39;image_pad&#39;</span> <span class="p">:</span> <span class="p">{</span> <span class="s">&#39;mm&#39;</span> <span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
        <span class="s">&#39;tel_radii&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s">&#39;px&#39;</span><span class="p">:</span> <span class="mf">1.2</span><span class="p">},</span>
        <span class="s">&#39;tel_area&#39;</span> <span class="p">:</span> <span class="mf">18242.</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">,</span>
        <span class="s">&#39;gain&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s">&#39;eADU&#39;</span> <span class="p">:</span> <span class="mf">3.802e-2</span><span class="p">,</span>
        <span class="s">&#39;lenslets&#39;</span> <span class="p">:</span> <span class="p">{</span>
              <span class="s">&#39;radius&#39;</span> <span class="p">:</span> <span class="mf">0.245e-2</span><span class="p">,</span>
              <span class="s">&#39;rotation&#39;</span> <span class="p">:</span> <span class="mf">27.0</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s">&#39;wavelengths&#39;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;max&#39;</span> <span class="p">:</span> <span class="mf">9300e-10</span><span class="p">,</span>
            <span class="s">&#39;min&#39;</span> <span class="p">:</span> <span class="mf">3700e-10</span><span class="p">,</span>
            <span class="s">&#39;resolution&#39;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s">&#39;scatter&#39;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;wavelength&#39;</span> <span class="p">:</span> <span class="mf">4500e-10</span><span class="p">,</span>
            <span class="s">&#39;radius&#39;</span> <span class="p">:</span> <span class="mi">800</span><span class="p">,</span>  
        <span class="p">},</span>
        <span class="s">&#39;Thpt&#39;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;File&#39;</span> <span class="p">:</span> <span class="s">&quot;SEDSpec2/Data/thpt.npy&quot;</span><span class="p">,</span>
            <span class="s">&#39;Type&#39;</span> <span class="p">:</span> <span class="s">&quot;prism_pi&quot;</span><span class="p">,</span>
        <span class="p">},</span>

        
    <span class="p">}</span>
    
    <span class="n">source</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;Filename&#39;</span> <span class="p">:</span> <span class="s">&quot;Data/SNIa.R1000.dat&quot;</span><span class="p">,</span>
        <span class="s">&#39;CubeName&#39;</span> <span class="p">:</span> <span class="s">&quot;Data/CUBE.fits&quot;</span><span class="p">,</span>
        <span class="s">&#39;Flat&#39;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;value&#39;</span> <span class="p">:</span> <span class="mf">1e-6</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s">&#39;WLCal&#39;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;List&#39;</span> <span class="p">:</span> <span class="s">&quot;Data/Lines.dat&quot;</span><span class="p">,</span>
            <span class="s">&#39;sigma&#39;</span> <span class="p">:</span> <span class="mf">1e-9</span><span class="p">,</span>
            <span class="s">&#39;value&#39;</span> <span class="p">:</span> <span class="mf">1e8</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s">&#39;PXSize&#39;</span> <span class="p">:</span> <span class="p">{</span> <span class="s">&#39;mm&#39;</span> <span class="p">:</span> <span class="mf">0.005</span> <span class="p">},</span>
        <span class="s">&#39;Rotation&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.0</span><span class="p">,</span>
        <span class="s">&#39;Sample_Lenslet&#39;</span> <span class="p">:</span> <span class="mi">2000</span><span class="p">,</span>
    <span class="p">}</span>
    
<div class="viewcode-block" id="SEDSimulator.setup_stages"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_stages">[docs]</a>    <span class="k">def</span> <span class="nf">setup_stages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets up all simulator stages&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerConfigOpts</span><span class="p">(</span><span class="s">&quot;D&quot;</span><span class="p">,{</span><span class="s">&quot;Lenslets&quot;</span><span class="p">:{</span><span class="s">&quot;start&quot;</span><span class="p">:</span><span class="mi">2100</span><span class="p">,</span><span class="s">&quot;number&quot;</span><span class="p">:</span><span class="mi">50</span><span class="p">},</span><span class="s">&quot;Debug&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span><span class="s">&quot;Output&quot;</span><span class="p">:{</span><span class="s">&quot;Label&quot;</span><span class="p">:</span><span class="s">&quot;DFlag&quot;</span><span class="p">,},},</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Debug, Limit lenslets (50,start from 2100)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerConfigOpts</span><span class="p">(</span><span class="s">&quot;S&quot;</span><span class="p">,{</span><span class="s">&quot;Lenslets&quot;</span><span class="p">:{</span><span class="s">&quot;start&quot;</span><span class="p">:</span><span class="mi">2100</span><span class="p">,</span><span class="s">&quot;number&quot;</span><span class="p">:</span><span class="mi">5</span><span class="p">},</span><span class="s">&quot;Debug&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span><span class="s">&quot;Output&quot;</span><span class="p">:{</span><span class="s">&quot;Label&quot;</span><span class="p">:</span><span class="s">&quot;SFlag&quot;</span><span class="p">,},},</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Debug, Limit lenslets (5,start from 2100)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerConfigOpts</span><span class="p">(</span><span class="s">&quot;T&quot;</span><span class="p">,{</span><span class="s">&quot;Lenslets&quot;</span><span class="p">:{</span><span class="s">&quot;start&quot;</span><span class="p">:</span><span class="mi">2100</span><span class="p">,</span><span class="s">&quot;number&quot;</span><span class="p">:</span><span class="mi">50</span><span class="p">},</span><span class="s">&quot;Debug&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s">&quot;Output&quot;</span><span class="p">:{</span><span class="s">&quot;Label&quot;</span><span class="p">:</span><span class="s">&quot;TFlag&quot;</span><span class="p">,},},</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Limit lenslets (50,start from 2100)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerConfigOpts</span><span class="p">(</span><span class="s">&quot;M&quot;</span><span class="p">,{</span><span class="s">&quot;Lenslets&quot;</span><span class="p">:{</span><span class="s">&quot;start&quot;</span><span class="p">:</span><span class="mi">1000</span><span class="p">,</span><span class="s">&quot;number&quot;</span><span class="p">:</span><span class="mi">500</span><span class="p">},</span><span class="s">&quot;Debug&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span><span class="s">&quot;Output&quot;</span><span class="p">:{</span><span class="s">&quot;Label&quot;</span><span class="p">:</span><span class="s">&quot;MFlag&quot;</span><span class="p">,},},</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Limit lenslets (500,start from 1000)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerConfigOpts</span><span class="p">(</span><span class="s">&quot;N&quot;</span><span class="p">,{</span><span class="s">&quot;Lenslets&quot;</span><span class="p">:{</span><span class="s">&quot;start&quot;</span><span class="p">:</span><span class="mi">1000</span><span class="p">,</span><span class="s">&quot;number&quot;</span><span class="p">:</span><span class="mi">500</span><span class="p">},</span><span class="s">&quot;Debug&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s">&quot;Output&quot;</span><span class="p">:{</span><span class="s">&quot;Label&quot;</span><span class="p">:</span><span class="s">&quot;NFlag&quot;</span><span class="p">,},},</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Limit lenslets (500,start from 1000)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerConfigOpts</span><span class="p">(</span><span class="s">&quot;A&quot;</span><span class="p">,{</span><span class="s">&quot;Lenslets&quot;</span><span class="p">:{</span><span class="s">&quot;start&quot;</span><span class="p">:</span><span class="mi">2100</span><span class="p">,</span><span class="s">&quot;number&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span><span class="s">&quot;Debug&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span><span class="s">&quot;Output&quot;</span><span class="p">:{</span><span class="s">&quot;Label&quot;</span><span class="p">:</span><span class="s">&quot;AFlag&quot;</span><span class="p">,},},</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Debug, Single lenslets (start from 2100)&quot;</span><span class="p">)</span>
        
        <span class="c"># SETUP Stages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_caches</span><span class="p">,</span><span class="s">&quot;setup-caches&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Setting up caches&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_configuration</span><span class="p">,</span><span class="s">&quot;setup-config&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Setting up dynamic configuration&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_constants</span><span class="p">,</span><span class="s">&quot;setup-constants&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Setting up physical constants&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-caches&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_cameras</span><span class="p">,</span><span class="s">&quot;setup-cameras&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Setting up Cameras&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_lenslets</span><span class="p">,</span><span class="s">&quot;setup-lenslets&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Setting up lenslets&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-config&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_hexagons</span><span class="p">,</span><span class="s">&quot;setup-hexagons&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Setting up lenslet hexagons&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-lenslets&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_blank</span><span class="p">,</span><span class="s">&quot;setup-blank&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Creating blank image&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-config&quot;</span><span class="p">])</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_simple_source</span><span class="p">,</span><span class="s">&quot;setup-source-simple&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Creating simple source spectrum object&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-config&quot;</span><span class="p">,</span><span class="s">&quot;setup-constants&quot;</span><span class="p">],</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">replaces</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-source&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="s">&quot;simple-source&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Use a simple, centered source object&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Replacing default source with a simple one&quot;</span><span class="p">,</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-source-simple&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_source</span><span class="p">,</span><span class="s">&quot;setup-source&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Creating source spectrum objects&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-config&quot;</span><span class="p">,</span><span class="s">&quot;setup-constants&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_source_pixels</span><span class="p">,</span><span class="s">&quot;setup-source-pixels&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Making source pixels&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-source&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_noise</span><span class="p">,</span><span class="s">&quot;setup-noise&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Setting up Dark/Bias frames&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-config&quot;</span><span class="p">,</span><span class="s">&quot;setup-cameras&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_sky</span><span class="p">,</span><span class="s">&quot;setup-sky&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Setting up Sky spectrum object&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-config&quot;</span><span class="p">,</span><span class="s">&quot;setup-constants&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_line_list</span><span class="p">,</span><span class="s">&quot;setup-lines&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Setting up calibration source&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-config&quot;</span><span class="p">,</span><span class="s">&quot;setup-constants&quot;</span><span class="p">],</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometric_resample</span><span class="p">,</span><span class="s">&quot;geometric-resample&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Performing geometric resample&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-source-pixels&quot;</span><span class="p">,</span><span class="s">&quot;setup-hexagons&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_scatter</span><span class="p">,</span><span class="s">&quot;setup-scatter&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Setting up scattered light calculations&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-config&quot;</span><span class="p">,</span><span class="s">&quot;geometric-resample&quot;</span><span class="p">])</span>
        <span class="c"># Setup Macro</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="s">&quot;setup&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;System Setup&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Set up simulator&quot;</span><span class="p">,</span>
            <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-caches&quot;</span><span class="p">,</span><span class="s">&quot;setup-lenslets&quot;</span><span class="p">,</span><span class="s">&quot;setup-hexagons&quot;</span><span class="p">,</span><span class="s">&quot;setup-blank&quot;</span><span class="p">,</span><span class="s">&quot;setup-source&quot;</span><span class="p">,</span><span class="s">&quot;setup-noise&quot;</span><span class="p">,</span><span class="s">&quot;setup-constants&quot;</span><span class="p">,</span><span class="s">&quot;setup-sky&quot;</span><span class="p">,</span><span class="s">&quot;setup-cameras&quot;</span><span class="p">,</span><span class="s">&quot;setup-lines&quot;</span><span class="p">],</span>
            <span class="p">)</span>
        
        <span class="c"># Adjust spectra</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sky_source</span><span class="p">,</span><span class="s">&quot;sky-source&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Use only sky spectrum&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Using only Sky spectrum&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-sky&quot;</span><span class="p">,</span><span class="s">&quot;apply-sky&quot;</span><span class="p">,</span><span class="s">&quot;apply-qe&quot;</span><span class="p">,</span><span class="s">&quot;apply-atmosphere&quot;</span><span class="p">,</span><span class="s">&quot;setup-lenslets&quot;</span><span class="p">],</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">replaces</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-source&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flat_source</span><span class="p">,</span><span class="s">&quot;flat-source&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Make a constant value source&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Using flat source&quot;</span><span class="p">,</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;geometric-resample&quot;</span><span class="p">],</span><span class="n">replaces</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-source&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_source</span><span class="p">,</span><span class="s">&quot;line-source&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Use a calibration lamp source&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Using calibration lamp source&quot;</span><span class="p">,</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;geometric-resample&quot;</span><span class="p">,</span><span class="s">&quot;setup-lines&quot;</span><span class="p">,</span><span class="s">&quot;apply-sky&quot;</span><span class="p">,</span><span class="s">&quot;apply-atmosphere&quot;</span><span class="p">],</span><span class="n">replaces</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-source&quot;</span><span class="p">])</span>
        
        <span class="c"># Apply spectral properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_sky</span><span class="p">,</span><span class="s">&quot;apply-sky&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Including sky spectrum&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-sky&quot;</span><span class="p">,</span><span class="s">&quot;setup-lenslets&quot;</span><span class="p">,</span><span class="s">&quot;geometric-resample&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_qe</span><span class="p">,</span><span class="s">&quot;apply-qe&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Applying Quantum Efficiency Functions&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-sky&quot;</span><span class="p">,</span><span class="s">&quot;setup-source&quot;</span><span class="p">,</span><span class="s">&quot;setup-lenslets&quot;</span><span class="p">,</span><span class="s">&quot;geometric-resample&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_atmosphere</span><span class="p">,</span><span class="s">&quot;apply-atmosphere&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Applying Atmospheric Extinction&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-sky&quot;</span><span class="p">,</span><span class="s">&quot;setup-source&quot;</span><span class="p">,</span><span class="s">&quot;setup-lenslets&quot;</span><span class="p">,</span><span class="s">&quot;geometric-resample&quot;</span><span class="p">])</span>
        
        <span class="c"># Plotting geometry functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_kernel_partials</span><span class="p">,</span><span class="s">&quot;plot-kernel&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Plot PSF Kernels&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Plotting PSF Kernels&quot;</span><span class="p">,</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-caches&quot;</span><span class="p">,</span><span class="s">&quot;setup-config&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_hexagons</span><span class="p">,</span><span class="s">&quot;plot-hexagons&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Plot Lenslet hexagons&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Plotting Lenslet hexagons&quot;</span><span class="p">,</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-hexagons&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_invalid_hexagons</span><span class="p">,</span><span class="s">&quot;plot-bad-hexagons&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Plot Shapely-invalid hexagons&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Plotting invalid hexagons&quot;</span><span class="p">,</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-hexagons&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_pixels</span><span class="p">,</span><span class="s">&quot;plot-pixels&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Plot Pixel positions&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Plotting pixel squares&quot;</span><span class="p">,</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-source-pixels&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_invalid_pixels</span><span class="p">,</span><span class="s">&quot;plot-bad-pixels&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Plot Shapely-invalid Pixel positions&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Plotting invalid pixel squares&quot;</span><span class="p">,</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-source-pixels&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_geometry</span><span class="p">,</span><span class="s">&quot;plot-geometry&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Plot lenslet and source geometry&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Plotting Lenslet-plane geometry&quot;</span><span class="p">,</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-source-pixels&quot;</span><span class="p">,</span><span class="s">&quot;setup-hexagons&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_resample</span><span class="p">,</span><span class="s">&quot;write-resample&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Output Resample Matrix&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Writing resample Matrix&quot;</span><span class="p">,</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;geometric-resample&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_resample</span><span class="p">,</span><span class="s">&quot;plot-resample&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Plot reample matrix&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Plotting resample matrix&quot;</span><span class="p">,</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;geometric-resample&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="s">&quot;plot-all-geo&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Do all geometry plots&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Plotting geometries&quot;</span><span class="p">,</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;plot-hexagons&quot;</span><span class="p">,</span><span class="s">&quot;plot-invalid-hexagons&quot;</span><span class="p">,</span><span class="s">&quot;plot-pixels&quot;</span><span class="p">,</span><span class="s">&quot;plot-geometry&quot;</span><span class="p">,</span><span class="s">&quot;plot-resample&quot;</span><span class="p">])</span>
        
        <span class="c"># Spectrum Plotting Functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compare_methods</span><span class="p">,</span><span class="s">&quot;plot-spectrum-tests&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Plotting Spectrum Tests&quot;</span><span class="p">,</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-sky&quot;</span><span class="p">,</span><span class="s">&quot;setup-source&quot;</span><span class="p">,</span><span class="s">&quot;apply-sky&quot;</span><span class="p">,</span><span class="s">&quot;apply-qe&quot;</span><span class="p">,</span><span class="s">&quot;apply-atmosphere&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_original_calibration</span><span class="p">,</span><span class="s">&quot;plot-cal-o&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Plot generic source spectrum&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Plotting Original Source Spectrum&quot;</span><span class="p">,</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-lines&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_original_source</span><span class="p">,</span><span class="s">&quot;plot-source-o&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Plot generic source spectrum&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Plotting Original Source Spectrum&quot;</span><span class="p">,</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-source&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_source</span><span class="p">,</span><span class="s">&quot;plot-source&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Plot generic source spectrum&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Plotting Source Spectrum&quot;</span><span class="p">,</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-sky&quot;</span><span class="p">,</span><span class="s">&quot;setup-source&quot;</span><span class="p">,</span><span class="s">&quot;apply-sky&quot;</span><span class="p">,</span><span class="s">&quot;apply-qe&quot;</span><span class="p">,</span><span class="s">&quot;apply-atmosphere&quot;</span><span class="p">,</span><span class="s">&quot;plot-source-o&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_sky_original</span><span class="p">,</span><span class="s">&quot;plot-sky-o&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Plot generic sky spectrum&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Plotting Original Sky Spectrum&quot;</span><span class="p">,</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-sky&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_sky</span><span class="p">,</span><span class="s">&quot;plot-sky&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Plot sky spectrum&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Plotting Sky Spectrum&quot;</span><span class="p">,</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-sky&quot;</span><span class="p">,</span><span class="s">&quot;apply-sky&quot;</span><span class="p">,</span><span class="s">&quot;apply-qe&quot;</span><span class="p">,</span><span class="s">&quot;simple-source&quot;</span><span class="p">,</span><span class="s">&quot;plot-sky-o&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_qe</span><span class="p">,</span><span class="s">&quot;plot-qe&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Plot QE spectrum&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Plotting QE Spectrum&quot;</span><span class="p">,</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-sky&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_lenslet_data</span><span class="p">,</span><span class="s">&quot;plot-lenslet-xy&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Plot lenslet positions&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Plotting lenslet positions&quot;</span><span class="p">,</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-lenslets&quot;</span><span class="p">])</span>
        
        <span class="c"># Dispersion functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lenslet_dispersion</span><span class="p">,</span><span class="s">&quot;dispersion&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Calculate lenslet dispersion&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Calculating dispersion for each lenslet&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-lenslets&quot;</span><span class="p">,</span><span class="s">&quot;setup-caches&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lenslet_trace</span><span class="p">,</span><span class="s">&quot;trace&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Trace lenslet spectra dispersion&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Tracing lenslet spectra dispersion&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;dispersion&quot;</span><span class="p">,</span><span class="s">&quot;setup-caches&quot;</span><span class="p">,</span><span class="s">&quot;apply-sky&quot;</span><span class="p">,</span><span class="s">&quot;apply-qe&quot;</span><span class="p">,</span><span class="s">&quot;apply-atmosphere&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lenslet_place</span><span class="p">,</span><span class="s">&quot;place&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Place subimages&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Placing lenslet spectra&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;trace&quot;</span><span class="p">])</span>
        
        <span class="c"># Dispersion plotting functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dispersion_data</span><span class="p">,</span><span class="s">&quot;plot-dispersion&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Plotting dispersion for each lenslet&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;dispersion&quot;</span><span class="p">],</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_trace_data</span><span class="p">,</span><span class="s">&quot;plot-trace&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Plotting trace data for each lenslet&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;trace&quot;</span><span class="p">],</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_spectrum_data</span><span class="p">,</span><span class="s">&quot;plot-spectrum&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Plotting spectral data for each lenslet&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;trace&quot;</span><span class="p">],</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="s">&quot;plot-lenslets&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Plot trace and spectra for each lenslet&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Plotting data about each lenslet&quot;</span><span class="p">,</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;plot-dispersion&quot;</span><span class="p">,</span><span class="s">&quot;plot-trace&quot;</span><span class="p">,</span><span class="s">&quot;plot-spectrum&quot;</span><span class="p">])</span>
        
        <span class="c"># Merge images back together</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_merge</span><span class="p">,</span><span class="s">&quot;merge-cached&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Merging subimages&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-blank&quot;</span><span class="p">,</span><span class="s">&quot;setup-lenslets&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="s">&quot;merge&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Merge Subimages&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Merging subimage into master image&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;place&quot;</span><span class="p">,</span><span class="s">&quot;merge-cached&quot;</span><span class="p">])</span>
        
        <span class="c"># Final Image work</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ccd_crop</span><span class="p">,</span><span class="s">&quot;crop&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Crop Final Image&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Cropping image to CCD size&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-blank&quot;</span><span class="p">,</span><span class="s">&quot;setup-lenslets&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_noise</span><span class="p">,</span><span class="s">&quot;add-noise&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Add Dark/Bias noise to image&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Adding Dark/Bias noise&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;crop&quot;</span><span class="p">,</span><span class="s">&quot;setup-noise&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transpose</span><span class="p">,</span><span class="s">&quot;transpose&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Transpose the image&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Transposing Image&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;crop&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_file</span><span class="p">,</span><span class="s">&quot;save&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Save image to file&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Saving image to disk&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-blank&quot;</span><span class="p">,</span><span class="s">&quot;transpose&quot;</span><span class="p">])</span>
        
        <span class="c"># Alternative work macros</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="s">&quot;cached-only&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Use cached subimages to construct final image&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Building image from caches&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;merge-cached&quot;</span><span class="p">,</span><span class="s">&quot;crop&quot;</span><span class="p">,</span><span class="s">&quot;add-noise&quot;</span><span class="p">,</span><span class="s">&quot;transpose&quot;</span><span class="p">,</span><span class="s">&quot;save&quot;</span><span class="p">],</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="s">&quot;plot&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Create all plots&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Plotting everything&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;plot-lenslet-xy&quot;</span><span class="p">,</span><span class="s">&quot;plot-lenslets&quot;</span><span class="p">,</span><span class="s">&quot;plot-sky&quot;</span><span class="p">,</span><span class="s">&quot;plot-qe&quot;</span><span class="p">,</span><span class="s">&quot;plot-source&quot;</span><span class="p">,</span><span class="s">&quot;plot-geometry&quot;</span><span class="p">,</span><span class="s">&quot;plot-hexagons&quot;</span><span class="p">,</span><span class="s">&quot;plot-pixels&quot;</span><span class="p">,</span><span class="s">&quot;plot-spectrum-tests&quot;</span><span class="p">,</span><span class="s">&quot;plot-kernel&quot;</span><span class="p">],</span><span class="n">include</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="SEDSimulator.setup_caches"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_caches">[docs]</a>    <span class="k">def</span> <span class="nf">setup_caches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register all of the cache objects and types&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Caches&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Caches&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">][</span><span class="s">&quot;Caches&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Caches&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="p">[</span><span class="s">&quot;TEL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NumpyCache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_tel_kern</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Caches&quot;</span><span class="p">][</span><span class="s">&quot;Telescope&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="p">[</span><span class="s">&quot;PSF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NumpyCache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_psf_kern</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Caches&quot;</span><span class="p">][</span><span class="s">&quot;PSF&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="p">[</span><span class="s">&quot;CONV&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NumpyCache</span><span class="p">(</span><span class="k">lambda</span> <span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="p">[</span><span class="s">&quot;PSF&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="p">[</span><span class="s">&quot;TEL&quot;</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;same&#39;</span><span class="p">),</span><span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Caches&quot;</span><span class="p">][</span><span class="s">&quot;CONV&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="p">[</span><span class="s">&quot;CONFIG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ConfigCache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Caches&quot;</span><span class="p">][</span><span class="s">&quot;config&quot;</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="s">&quot;clear_cache&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&quot;clear_cache&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="o">.</span><span class="n">flag</span><span class="p">(</span><span class="s">&#39;enabled&#39;</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&quot;cache&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&quot;cache&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="o">.</span><span class="n">flag</span><span class="p">(</span><span class="s">&#39;saving&#39;</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s">&quot;CONFIG&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="p">[</span><span class="s">&quot;CONFIG&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Caches appear to be out of date, regenerating&quot;</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="SEDSimulator.setup_constants"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_constants">[docs]</a>    <span class="k">def</span> <span class="nf">setup_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Establish Physical Constants&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">const</span> <span class="o">=</span> <span class="n">StructuredConfiguration</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">setFile</span><span class="p">(</span><span class="s">&quot;const&quot;</span><span class="p">,</span><span class="s">&quot;SED.const.config.yaml&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s">&quot;hc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.98644521e-8</span> <span class="c"># erg angstrom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="p">[</span><span class="s">&quot;CONST&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ConfigCache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Caches&quot;</span><span class="p">][</span><span class="s">&quot;const&quot;</span><span class="p">])</span>
        
        </div>
<div class="viewcode-block" id="SEDSimulator.setup_lenslets"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_lenslets">[docs]</a>    <span class="k">def</span> <span class="nf">setup_lenslets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="sd">&quot;&quot;&quot;This function loads data about lenslet positions, and thier dispersion through the prism. The data are original produced by Zeemax. This function reads the Zeemax data directly and then cleans the data in certain ways, preparing it for use later in the system.</span>
<span class="sd">        </span>
<span class="sd">       ..Note:: The source of this function is well documented.</span>
<span class="sd">        </span>
<span class="sd">       ..Note:: This function does not store variables neatly. As such, it has no built-in caching system.</span>
<span class="sd">       &quot;&quot;&quot;</span>
       <span class="c"># Load Lenslet Specification File</span>
       <span class="n">ix</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">lams</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;files&quot;</span><span class="p">][</span><span class="s">&quot;lenslets&quot;</span><span class="p">],</span><span class="n">skip_header</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">comments</span><span class="o">=</span><span class="s">&quot;#&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
       <span class="c"># This data describes the following:</span>
       <span class="c"># ix - Index (number)</span>
       <span class="c"># p1 - Pupil position in the x-direction</span>
       <span class="c"># p2 - Pupil position in the y-direction</span>
       <span class="c"># lams - wavelengths for this position</span>
       <span class="c"># xs - X position (in mm, offest from top right corner) of this wavelength</span>
       <span class="c"># ys - Y Position (in mm, offset from top right corner) of this wavelength</span>
        
       <span class="c"># Correctly Type Lenslet Specification Data</span>
       <span class="n">ix</span> <span class="o">=</span> <span class="n">ix</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span> <span class="c">#Indicies should always be integers</span>
        
       <span class="c"># Center xs and ys on detector with a corner at 0,0</span>
       <span class="n">xs</span> <span class="o">+=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;image_size&quot;</span><span class="p">][</span><span class="s">&quot;mm&quot;</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
       <span class="n">ys</span> <span class="o">+=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;image_size&quot;</span><span class="p">][</span><span class="s">&quot;mm&quot;</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        
       <span class="n">lams</span> <span class="o">*=</span> <span class="mf">1e-6</span> <span class="c"># Convert wavelength to SI units (m)</span>
        
       <span class="c"># This simply generates a list of all of the lenslets</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">lensletIndex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span>
        
       <span class="c"># Determine the center of the whole system by finding the x position that is closest to 0,0 in pupil position</span>
       <span class="n">cntix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">p1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="n">cntix</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;convert&quot;</span><span class="p">][</span><span class="s">&quot;mmtopx&quot;</span><span class="p">],</span> <span class="n">ys</span><span class="p">[</span><span class="n">cntix</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;convert&quot;</span><span class="p">][</span><span class="s">&quot;mmtopx&quot;</span><span class="p">])</span>
       
        
       <span class="c"># Progress bar for lenslet creation and validation</span>
       <span class="n">PBar</span> <span class="o">=</span> <span class="n">arpytools</span><span class="o">.</span><span class="n">progressbar</span><span class="o">.</span><span class="n">ProgressBar</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;green&quot;</span><span class="p">)</span>
       <span class="n">finished</span> <span class="o">=</span> <span class="mf">0.0</span>
       <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lensletIndex</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">useConsole</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
       <span class="n">PBar</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;L:</span><span class="si">%4s</span><span class="s"> </span><span class="si">%4d</span><span class="s">/</span><span class="si">%-4d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">finished</span><span class="p">,</span><span class="n">total</span><span class="p">))</span>
        
       <span class="c"># Variables for lenslet use</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">lenslets</span> <span class="o">=</span> <span class="p">{}</span>
       <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/</span><span class="si">%(name)s%(ext)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Lenslets-raw&quot;</span><span class="p">,</span><span class="n">ext</span><span class="o">=</span><span class="s">&quot;.dat&quot;</span><span class="p">,</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
       <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">FileName</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
           <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lensletIndex</span><span class="p">:</span>
               <span class="n">select</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">ix</span>
               <span class="n">lenslet</span> <span class="o">=</span> <span class="n">Lenslet</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="n">select</span><span class="p">],</span><span class="n">ys</span><span class="p">[</span><span class="n">select</span><span class="p">],</span><span class="n">p1</span><span class="p">[</span><span class="n">select</span><span class="p">],</span><span class="n">p2</span><span class="p">[</span><span class="n">select</span><span class="p">],</span><span class="n">lams</span><span class="p">[</span><span class="n">select</span><span class="p">],</span><span class="n">idx</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="p">)</span>
               <span class="k">if</span> <span class="n">lenslet</span><span class="o">.</span><span class="n">valid</span><span class="p">():</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">lenslets</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">lenslet</span>
                   <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">lenslet</span><span class="o">.</span><span class="n">introspect</span><span class="p">())</span>
               <span class="n">progress</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">finished</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">total</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
               <span class="n">finished</span> <span class="o">+=</span> <span class="mi">1</span>
               <span class="n">PBar</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">progress</span><span class="p">,</span><span class="s">&quot;L:</span><span class="si">%4d</span><span class="s"> </span><span class="si">%4d</span><span class="s">/</span><span class="si">%-4d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">finished</span><span class="p">,</span><span class="n">total</span><span class="p">))</span>
       <span class="n">PBar</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="s">&quot;L:</span><span class="si">%4s</span><span class="s"> </span><span class="si">%4d</span><span class="s">/</span><span class="si">%-4d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;Done&quot;</span><span class="p">,</span><span class="n">total</span><span class="p">,</span><span class="n">total</span><span class="p">))</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">lensletIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lenslets</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">useConsole</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
       
       
       <span class="c"># Central Lenslet Output</span>
       <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/</span><span class="si">%(name)s%(ext)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;center-raw&quot;</span><span class="p">,</span><span class="n">ext</span><span class="o">=</span><span class="s">&quot;.dat&quot;</span><span class="p">,</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
       <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">FileName</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
           <span class="n">lenslet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lenslets</span><span class="p">[</span><span class="n">ix</span><span class="p">[</span><span class="n">cntix</span><span class="p">]]</span>
           <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">lenslet</span><span class="o">.</span><span class="n">introspect</span><span class="p">())</span>
       
       
       <span class="k">if</span> <span class="s">&quot;start&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Lenslets&quot;</span><span class="p">]:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">lensletIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lensletIndex</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Lenslets&quot;</span><span class="p">][</span><span class="s">&quot;start&quot;</span><span class="p">]:]</span>
       <span class="k">if</span> <span class="s">&quot;number&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Lenslets&quot;</span><span class="p">]:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">lensletIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lensletIndex</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Lenslets&quot;</span><span class="p">][</span><span class="s">&quot;number&quot;</span><span class="p">]]</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lensletIndex</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">lenslets</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">lenslets</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lensletIndex</span><span class="p">}</span>
       <span class="k">for</span> <span class="n">ix</span><span class="p">,</span><span class="n">lx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lenslets</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
           <span class="n">lx</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">ix</span>
    </div>
<div class="viewcode-block" id="SEDSimulator.setup_blank"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_blank">[docs]</a>    <span class="k">def</span> <span class="nf">setup_blank</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Establish a blank Image&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="p">[</span><span class="s">&quot;Blank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;image_size&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;image_size&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SEDSimulator.setup_source"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_source">[docs]</a>    <span class="k">def</span> <span class="nf">setup_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets up a uniform source file based spectrum&quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Stage &#39;setup-source&#39; not ready yet, doing nothing!&quot;</span><span class="p">)</span>
        <span class="k">return</span>
        
        <span class="n">Source</span> <span class="o">=</span> <span class="n">ImageObject</span><span class="p">()</span>
        <span class="n">Source</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Source&quot;</span><span class="p">][</span><span class="s">&quot;CubeName&quot;</span><span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">Source</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="c"># Progress bar for lenslet creation and validation</span>
        <span class="n">PBar</span> <span class="o">=</span> <span class="n">arpytools</span><span class="o">.</span><span class="n">progressbar</span><span class="o">.</span><span class="n">ProgressBar</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;green&quot;</span><span class="p">)</span>
        <span class="n">finished</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">useConsole</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">PBar</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;L:</span><span class="si">%4s</span><span class="s">,</span><span class="si">%4s</span><span class="s"> </span><span class="si">%6d</span><span class="s">/</span><span class="si">%-6d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">finished</span><span class="p">,</span><span class="n">total</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">SourcePixels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">progress</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">finished</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">total</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
                <span class="n">finished</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SourcePixels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SourcePixel</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Source Pixel </span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">),</span><span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="n">finished</span><span class="p">))</span>
                <span class="n">PBar</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">progress</span><span class="p">,</span><span class="s">&quot;L:</span><span class="si">%4d</span><span class="s">,</span><span class="si">%4d</span><span class="s"> </span><span class="si">%6d</span><span class="s">/</span><span class="si">%-6d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">finished</span><span class="p">,</span><span class="n">total</span><span class="p">))</span>
        
        <span class="n">PBar</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;L:</span><span class="si">%4s</span><span class="s">,</span><span class="si">%4s</span><span class="s"> </span><span class="si">%6d</span><span class="s">/</span><span class="si">%-6d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;Done&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">finished</span><span class="p">,</span><span class="n">total</span><span class="p">))</span>
        
        </div>
<div class="viewcode-block" id="SEDSimulator.setup_simple_source"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_simple_source">[docs]</a>    <span class="k">def</span> <span class="nf">setup_simple_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for setup_simple_source&quot;&quot;&quot;</span>        
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Source&quot;</span><span class="p">][</span><span class="s">&quot;Filename&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">FL</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s">&quot;hc&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">WL</span>
        <span class="n">FL</span> <span class="o">*=</span> <span class="mf">1e10</span> <span class="c">#Spectrum was per Angstrom, should now be per Meter</span>
        <span class="n">WL</span> <span class="o">*=</span> <span class="mf">1e-10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Spectrum</span> <span class="o">=</span> <span class="n">InterpolatedSpectrum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span><span class="n">FL</span><span class="p">]),</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Source&quot;</span><span class="p">][</span><span class="s">&quot;Filename&quot;</span><span class="p">],</span><span class="n">method</span><span class="o">=</span><span class="s">&quot;resolve_and_integrate&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Original</span> <span class="o">=</span> <span class="n">InterpolatedSpectrum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span><span class="n">FL</span><span class="p">]),</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Source&quot;</span><span class="p">][</span><span class="s">&quot;Filename&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&quot; (O)&quot;</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&quot;resolve_and_integrate&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SpectrumData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span><span class="n">FL</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SourcePixels</span> <span class="o">=</span> <span class="p">[</span><span class="n">SourcePixel</span><span class="p">(</span><span class="o">-</span><span class="mf">0.13</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span><span class="n">FL</span><span class="p">]),</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Source Pixel&quot;</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">SourcePixel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span><span class="n">FL</span><span class="p">]),</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Source Pixel&quot;</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span><span class="n">SourcePixel</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span><span class="n">FL</span><span class="p">]),</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Source Pixel&quot;</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">3</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span><span class="n">px</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SourcePixels</span><span class="p">):</span>
            <span class="n">px</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">ix</span>
    </div>
<div class="viewcode-block" id="SEDSimulator.setup_cameras"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_cameras">[docs]</a>    <span class="k">def</span> <span class="nf">setup_cameras</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set up camera configuration values&quot;&quot;&quot;</span>
        <span class="c"># Camera Data (from sim_pdr.py by Nick)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cameras</span> <span class="o">=</span> <span class="p">{</span>
        	<span class="s">&quot;PI&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;DQEs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        		<span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>	
        		<span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">3500</span><span class="p">,</span> <span class="o">.</span><span class="mi">20</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">4000</span><span class="p">,</span> <span class="o">.</span><span class="mi">60</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">4500</span><span class="p">,</span> <span class="o">.</span><span class="mi">82</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="o">.</span><span class="mi">90</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">5500</span><span class="p">,</span> <span class="o">.</span><span class="mi">93</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">6000</span><span class="p">,</span> <span class="o">.</span><span class="mi">93</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">7000</span><span class="p">,</span> <span class="o">.</span><span class="mi">93</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">7500</span><span class="p">,</span> <span class="o">.</span><span class="mi">88</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">8000</span><span class="p">,</span> <span class="o">.</span><span class="mi">73</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">8500</span><span class="p">,</span> <span class="o">.</span><span class="mi">55</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">9000</span><span class="p">,</span> <span class="o">.</span><span class="mi">33</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="o">.</span><span class="mi">08</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">10500</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">11000</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        	<span class="p">]),</span>
        	<span class="s">&quot;RN&quot;</span> <span class="p">:</span> <span class="mf">5.</span><span class="p">,</span>
        	<span class="s">&quot;DC&quot;</span><span class="p">:</span>  <span class="mf">0.006</span><span class="p">,</span>
        	<span class="s">&quot;readtime&quot;</span><span class="p">:</span> <span class="mi">37</span><span class="p">},</span>
        	<span class="s">&quot;Andor&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="c"># Midband</span>
        		<span class="s">&quot;DQEs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        		<span class="p">(</span><span class="mi">2500</span><span class="p">,</span> <span class="o">.</span><span class="mo">05</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">3500</span><span class="p">,</span> <span class="o">.</span><span class="mi">18</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">4500</span><span class="p">,</span> <span class="o">.</span><span class="mi">75</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="o">.</span><span class="mi">9</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">5500</span><span class="p">,</span> <span class="o">.</span><span class="mi">92</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">6500</span><span class="p">,</span> <span class="o">.</span><span class="mi">91</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">7500</span><span class="p">,</span> <span class="o">.</span><span class="mi">79</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">8500</span><span class="p">,</span> <span class="o">.</span><span class="mi">48</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">9500</span><span class="p">,</span> <span class="o">.</span><span class="mi">13</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">10500</span><span class="p">,</span> <span class="o">.</span><span class="mo">02</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">11000</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        	<span class="p">]),</span> 
        	<span class="s">&quot;RN&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
        	<span class="s">&quot;DC&quot;</span><span class="p">:</span> <span class="mf">0.0004</span><span class="p">,</span>
        	<span class="s">&quot;readtime&quot;</span><span class="p">:</span>  <span class="mi">82</span><span class="p">},</span>
        	<span class="s">&quot;E2V&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;DQEs&quot;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        		<span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="o">.</span><span class="mi">1</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">3500</span><span class="p">,</span> <span class="o">.</span><span class="mi">3</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">4500</span><span class="p">,</span> <span class="o">.</span><span class="mi">8</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">5500</span><span class="p">,</span> <span class="o">.</span><span class="mi">8</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">6500</span><span class="p">,</span> <span class="o">.</span><span class="mi">78</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">7500</span><span class="p">,</span> <span class="o">.</span><span class="mi">7</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">8500</span><span class="p">,</span> <span class="o">.</span><span class="mi">4</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">9500</span><span class="p">,</span> <span class="o">.</span><span class="mi">13</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">10500</span><span class="p">,</span> <span class="o">.</span><span class="mo">02</span><span class="p">),</span>
        		<span class="p">(</span><span class="mi">11000</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]),</span>
        	<span class="s">&quot;RN&quot;</span><span class="p">:</span> <span class="mf">3.3</span><span class="p">,</span>
        	<span class="s">&quot;DC&quot;</span><span class="p">:</span> <span class="mf">0.006</span><span class="p">,</span>
        	<span class="s">&quot;readtime&quot;</span><span class="p">:</span> <span class="mi">37</span><span class="p">},</span>
        <span class="p">}</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">cameras</span><span class="p">[</span><span class="s">&quot;PI-fast&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cameras</span><span class="p">[</span><span class="s">&quot;PI&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cameras</span><span class="p">[</span><span class="s">&quot;PI-fast&quot;</span><span class="p">][</span><span class="s">&quot;RN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cameras</span><span class="p">[</span><span class="s">&quot;PI-fast&quot;</span><span class="p">][</span><span class="s">&quot;readtime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.265</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cameras</span><span class="p">[</span><span class="s">&quot;Andor-fast&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cameras</span><span class="p">[</span><span class="s">&quot;Andor&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cameras</span><span class="p">[</span><span class="s">&quot;Andor-fast&quot;</span><span class="p">][</span><span class="s">&quot;RN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">11.7</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cameras</span><span class="p">[</span><span class="s">&quot;Andor-fast&quot;</span><span class="p">][</span><span class="s">&quot;readtime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.398</span>
        
    </div>
<div class="viewcode-block" id="SEDSimulator.setup_sky"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_sky">[docs]</a>    <span class="k">def</span> <span class="nf">setup_sky</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup sky spectrum information&quot;&quot;&quot;</span>

        
        <span class="c"># Sky Data (From sim_pdr.py by Nick, regenerated using SEDSpec2 module&#39;s make_files.py script)</span>
        <span class="c"># Each sky spectrum is saved in a FITS file for easy recall as a spectrum object.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SKYData</span> <span class="o">=</span> <span class="n">SpectraObject</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span><span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Observation&quot;</span><span class="p">][</span><span class="s">&quot;Sky&quot;</span><span class="p">][</span><span class="s">&quot;Files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SKYData</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">statename</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
        
        <span class="c"># Moon phase adjustments. These moon phase attenuation values are for different filter bands.</span>
        <span class="c"># The intermediate wavelengths are accounted for using a polyfit</span>
        <span class="c"># the result is a function which takes phase and wavelength, and outputs an attenuation...</span>
        
        <span class="c"># See derivation on pg 83 of SED NB 1 (20 July 2011)</span>
        <span class="n">moon_phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.24</span><span class="p">,</span> <span class="mf">0.32</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">])</span>
        <span class="n">moon_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2e-17</span><span class="p">,</span> <span class="mf">2.1e-17</span><span class="p">,</span> <span class="mf">2.15e-17</span><span class="p">,</span> <span class="mf">2.3e-17</span><span class="p">,</span> <span class="mf">5.3e-17</span><span class="p">,</span> <span class="mf">1.7e-16</span><span class="p">,</span> <span class="mf">3.2e-16</span><span class="p">])</span>
        <span class="n">moon_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.3e-17</span><span class="p">,</span><span class="mf">2.3e-17</span><span class="p">,</span><span class="mf">2.3e-17</span><span class="p">,</span><span class="mf">3.3e-17</span><span class="p">,</span><span class="mf">3.5e-17</span><span class="p">,</span><span class="mf">8.3e-17</span><span class="p">,</span><span class="mf">1.3e-16</span><span class="p">])</span>
        <span class="n">moon_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.8e-17</span><span class="p">,</span><span class="mf">3.0e-17</span><span class="p">,</span><span class="mf">3.0e-17</span><span class="p">,</span><span class="mf">3.3e-17</span><span class="p">,</span><span class="mf">3.8e-17</span><span class="p">,</span><span class="mf">7.0e-17</span><span class="p">,</span><span class="mf">9.0e-17</span><span class="p">])</span>

        <span class="n">sky_ls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">4868.</span><span class="p">,</span> <span class="mf">6290.</span><span class="p">,</span> <span class="mf">7706.</span><span class="p">,</span> <span class="mi">10000</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e-10</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">moon_specs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">moon_phase</span><span class="p">)):</span>
            <span class="n">gm</span> <span class="o">=</span> <span class="n">moon_g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">moon_g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">rm</span> <span class="o">=</span> <span class="n">moon_r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">moon_r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">moon_i</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">moon_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">zm</span> <span class="o">=</span> <span class="n">im</span>
            <span class="n">fluxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">gm</span><span class="p">,</span> <span class="n">rm</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">zm</span><span class="p">])</span>
            <span class="c"># fluxes /= self.const[&quot;hc&quot;] / sky_ls</span>
            <span class="n">moon_spec</span> <span class="o">=</span> <span class="n">InterpolatedSpectrum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sky_ls</span><span class="p">,</span><span class="n">fluxes</span><span class="p">]),</span><span class="s">&quot;Moon Phase </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&#39;polyfit&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">moon_specs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">moon_spec</span><span class="p">)</span>
        
        <span class="c"># Throughputs are generated from Nick&#39;s simulation scripts in throughput.py</span>
        <span class="c"># They are simply re-read here.</span>
        <span class="n">thpts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;Thpt&quot;</span><span class="p">][</span><span class="s">&quot;File&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qe</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">WL</span> <span class="o">=</span> <span class="n">thpts</span><span class="p">[</span><span class="s">&quot;lambda&quot;</span><span class="p">]</span><span class="o">*</span> <span class="mf">1e-10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qe</span><span class="p">[</span><span class="s">&quot;prism_pi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">InterpolatedSpectrum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span> <span class="n">thpts</span><span class="p">[</span><span class="s">&quot;thpt-prism-PI&quot;</span><span class="p">]]),</span><span class="s">&quot;PI Prism&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qe</span><span class="p">[</span><span class="s">&quot;prism_andor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">InterpolatedSpectrum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span> <span class="n">thpts</span><span class="p">[</span><span class="s">&quot;thpt-prism-Andor&quot;</span><span class="p">]]),</span><span class="s">&quot;Andor Prism&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qe</span><span class="p">[</span><span class="s">&quot;grating&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">InterpolatedSpectrum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span> <span class="n">thpts</span><span class="p">[</span><span class="s">&quot;thpt-grating&quot;</span><span class="p">]]),</span><span class="s">&quot;Grating&quot;</span><span class="p">)</span>
        
        <span class="c"># Set up extinction and airmass term.</span>
        <span class="n">WL</span><span class="p">,</span><span class="n">EX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SKYData</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Observation&quot;</span><span class="p">][</span><span class="s">&quot;Sky&quot;</span><span class="p">][</span><span class="s">&quot;Atmosphere&quot;</span><span class="p">])</span>
        <span class="n">FL</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">EX</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Observation&quot;</span><span class="p">][</span><span class="s">&quot;airmass&quot;</span><span class="p">]</span><span class="o">/</span><span class="mf">2.5</span><span class="p">)</span>
        <span class="n">WL</span> <span class="o">*=</span> <span class="mf">1e-10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Extinction</span> <span class="o">=</span> <span class="n">InterpolatedSpectrum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span><span class="n">FL</span><span class="p">]),</span><span class="s">&quot;Atmosphere&quot;</span><span class="p">)</span>
        
        
        <span class="c"># This calculation fixes the units of the TurnroseSKY values</span>
        <span class="c"># I&#39;m not sure what these units are doing, but we will leave them here for now.</span>
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SKYData</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Observation&quot;</span><span class="p">][</span><span class="s">&quot;Sky&quot;</span><span class="p">][</span><span class="s">&quot;Use&quot;</span><span class="p">])</span>
        <span class="n">FL</span> <span class="o">*=</span> <span class="mf">1e-18</span> <span class="o">*</span> <span class="mi">3</span> <span class="c"># NICK! I NEED THIS EXPLAINED!</span>
        <span class="n">FL</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s">&quot;hc&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">WL</span>
        <span class="n">FL</span> <span class="o">*=</span> <span class="mf">1e10</span> <span class="c">#Spectrum was per Angstrom, should now be per Meter</span>
        
        
        <span class="n">M_FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">moon_specs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Observation&quot;</span><span class="p">][</span><span class="s">&quot;Moon&quot;</span><span class="p">][</span><span class="s">&quot;Phase&quot;</span><span class="p">]](</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e-10</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">M_FL</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s">&quot;hc&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">WL</span>
        <span class="n">M_FL</span> <span class="o">*=</span> <span class="mf">1e10</span>
        
        <span class="n">WL</span> <span class="o">*=</span> <span class="mf">1e-10</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">MoonSpectrum</span> <span class="o">=</span> <span class="n">InterpolatedSpectrum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span><span class="n">M_FL</span><span class="p">]),</span><span class="s">&quot;Moon Phase&quot;</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&#39;resolve_and_integrate&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SkyOriginal</span> <span class="o">=</span> <span class="n">InterpolatedSpectrum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span><span class="n">FL</span><span class="p">]),</span><span class="s">&quot;SkySpectrum (O)&quot;</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&quot;resolve_and_integrate&quot;</span><span class="p">)</span>
        <span class="n">FL</span> <span class="o">+=</span> <span class="n">M_FL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SkyMoon</span> <span class="o">=</span> <span class="n">InterpolatedSpectrum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span><span class="n">FL</span><span class="p">]),</span><span class="s">&quot;SkySpectrum + Moon&quot;</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&quot;resolve_and_integrate&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SkySpectrum</span> <span class="o">=</span> <span class="n">InterpolatedSpectrum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span><span class="n">FL</span><span class="p">]),</span><span class="s">&quot;SkySpectrum&quot;</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&quot;resolve_and_integrate&quot;</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="SEDSimulator.apply_atmosphere"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.apply_atmosphere">[docs]</a>    <span class="k">def</span> <span class="nf">apply_atmosphere</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply the atmospheric extinction term.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_apply_atmosphere</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Spectrum</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Extinction</span>
        
        </div>
    <span class="k">def</span> <span class="nf">_apply_atmosphere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lenslet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for _apply_atmosphere&quot;&quot;&quot;</span>
        <span class="n">lenslet</span><span class="o">.</span><span class="n">spectrum</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Extinction</span>
        
<div class="viewcode-block" id="SEDSimulator.setup_hexagons"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_hexagons">[docs]</a>    <span class="k">def</span> <span class="nf">setup_hexagons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make the lenslet hexagons&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="o">.</span><span class="n">make_hexagon</span><span class="p">(),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;green&quot;</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="SEDSimulator.setup_source_pixels"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_source_pixels">[docs]</a>    <span class="k">def</span> <span class="nf">setup_source_pixels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup source pixels&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_pixels</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">make_pixel_square</span><span class="p">(),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;green&quot;</span><span class="p">)</span>
       </div>
<div class="viewcode-block" id="SEDSimulator.apply_sky"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.apply_sky">[docs]</a>    <span class="k">def</span> <span class="nf">apply_sky</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply Sky Spectrum to each lenslet&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_apply_sky_spectrum</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Spectrum</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SkySpectrum</span>
        
        </div>
    <span class="k">def</span> <span class="nf">_apply_sky_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lenslet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for _apply_sky_spectrum&quot;&quot;&quot;</span>
        <span class="n">lenslet</span><span class="o">.</span><span class="n">spectrum</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SkySpectrum</span>
        
    <span class="k">def</span> <span class="nf">_apply_qe_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lenslet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply qe to each lenslet&quot;&quot;&quot;</span>
        <span class="n">lenslet</span><span class="o">.</span><span class="n">spectrum</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qe</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;Thpt&quot;</span><span class="p">][</span><span class="s">&quot;Type&quot;</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;tel_area&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Observation&quot;</span><span class="p">][</span><span class="s">&quot;exposure&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;eADU&quot;</span><span class="p">]</span>
        
<div class="viewcode-block" id="SEDSimulator.apply_qe"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.apply_qe">[docs]</a>    <span class="k">def</span> <span class="nf">apply_qe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply the instrument quantum efficiency&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_apply_qe_spectrum</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SkySpectrum</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qe</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;Thpt&quot;</span><span class="p">][</span><span class="s">&quot;Type&quot;</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;tel_area&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Observation&quot;</span><span class="p">][</span><span class="s">&quot;exposure&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;eADU&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Spectrum</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qe</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;Thpt&quot;</span><span class="p">][</span><span class="s">&quot;Type&quot;</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;tel_area&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Observation&quot;</span><span class="p">][</span><span class="s">&quot;exposure&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;eADU&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Original</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;tel_area&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Observation&quot;</span><span class="p">][</span><span class="s">&quot;exposure&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;eADU&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SkyOriginal</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;tel_area&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Observation&quot;</span><span class="p">][</span><span class="s">&quot;exposure&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;eADU&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SkyMoon</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;tel_area&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Observation&quot;</span><span class="p">][</span><span class="s">&quot;exposure&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;eADU&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MoonSpectrum</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;tel_area&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Observation&quot;</span><span class="p">][</span><span class="s">&quot;exposure&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;eADU&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MoonSpectrumQE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MoonSpectrum</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">qe</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;Thpt&quot;</span><span class="p">][</span><span class="s">&quot;Type&quot;</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;eADU&quot;</span><span class="p">]</span>
        
        </div>
<div class="viewcode-block" id="SEDSimulator.geometric_resample"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.geometric_resample">[docs]</a>    <span class="k">def</span> <span class="nf">geometric_resample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for fname&quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SourcePixels</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lenslets</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span><span class="n">l</span><span class="o">.</span><span class="n">setup_crosstalk</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_pixels</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">setup_crosstalk</span><span class="p">(</span><span class="n">m</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">map_over_pixels</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span><span class="n">l</span><span class="o">.</span><span class="n">find_crosstalk</span><span class="p">(</span><span class="n">p</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;green&quot;</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="SEDSimulator.setup_line_list"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_line_list">[docs]</a>    <span class="k">def</span> <span class="nf">setup_line_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set up a line-list based spectrum for wavelength calibration.&quot;&quot;&quot;</span>
        <span class="n">List</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Source&quot;</span><span class="p">][</span><span class="s">&quot;WLCal&quot;</span><span class="p">][</span><span class="s">&quot;List&quot;</span><span class="p">])</span>
        <span class="n">CalSpec</span> <span class="o">=</span> <span class="n">FlatSpectrum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">List</span><span class="p">:</span>
            <span class="n">CalSpec</span> <span class="o">+=</span> <span class="n">GaussianSpectrum</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Source&quot;</span><span class="p">][</span><span class="s">&quot;WLCal&quot;</span><span class="p">][</span><span class="s">&quot;sigma&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Source&quot;</span><span class="p">][</span><span class="s">&quot;WLCal&quot;</span><span class="p">][</span><span class="s">&quot;value&quot;</span><span class="p">],</span><span class="s">&quot;Line </span><span class="si">%g</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CalSpec</span> <span class="o">=</span> <span class="n">UnitarySpectrum</span><span class="p">(</span><span class="n">CalSpec</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&#39;resolve_and_integrate&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Calibration Lamp&quot;</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="SEDSimulator.line_source"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.line_source">[docs]</a>    <span class="k">def</span> <span class="nf">line_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use the line spectrum only&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replace_source</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CalSpec</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="SEDSimulator.sky_source"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.sky_source">[docs]</a>    <span class="k">def</span> <span class="nf">sky_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use the sky spectrum only&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replace_source</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SkySpectrum</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">SkyOriginal</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SEDSimulator.replace_source"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.replace_source">[docs]</a>    <span class="k">def</span> <span class="nf">replace_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">spectrum</span><span class="p">,</span><span class="n">original</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replace the default file-source with a flat spectrum&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Spectrum</span> <span class="o">=</span> <span class="n">spectrum</span>
        <span class="k">if</span> <span class="n">original</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Original</span> <span class="o">=</span> <span class="n">original</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Original</span> <span class="o">=</span> <span class="n">spectrum</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_replace_source</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    </div>
    <span class="k">def</span> <span class="nf">_replace_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lenslet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for _flat_source&quot;&quot;&quot;</span>
        <span class="n">lenslet</span><span class="o">.</span><span class="n">spectrum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Spectrum</span>
            
<div class="viewcode-block" id="SEDSimulator.flat_source"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.flat_source">[docs]</a>    <span class="k">def</span> <span class="nf">flat_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replace the default file-source with a flat spectrum&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replace_source</span><span class="p">(</span><span class="n">FlatSpectrum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Source&quot;</span><span class="p">][</span><span class="s">&quot;Flat&quot;</span><span class="p">][</span><span class="s">&quot;value&quot;</span><span class="p">]))</span>
</div>
<div class="viewcode-block" id="SEDSimulator.lenslet_dispersion"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.lenslet_dispersion">[docs]</a>    <span class="k">def</span> <span class="nf">lenslet_dispersion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate the dispersion for each lenslet&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="o">.</span><span class="n">find_dispersion</span><span class="p">(),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;blue&quot;</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="SEDSimulator.lenslet_trace"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.lenslet_trace">[docs]</a>    <span class="k">def</span> <span class="nf">lenslet_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Trace out each lenslet&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="o">.</span><span class="n">get_trace</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">spectrum</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;blue&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SEDSimulator.lenslet_place"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.lenslet_place">[docs]</a>    <span class="k">def</span> <span class="nf">lenslet_place</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Place each spectrum into the subimage&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lenslet_place</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;yellow&quot;</span><span class="p">)</span>
        </div>
    <span class="k">def</span> <span class="nf">_lenslet_place</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">l</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for _lenslet_place&quot;&quot;&quot;</span>
        <span class="n">l</span><span class="o">.</span><span class="n">place_trace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_conv</span><span class="p">)</span>
        <span class="n">l</span><span class="o">.</span><span class="n">write_subimage</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/LensletAudit.dat&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">],</span><span class="s">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">vars</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="p">)</span>
        <span class="c"># gc.collect()</span>
    
<div class="viewcode-block" id="SEDSimulator.image_merge"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.image_merge">[docs]</a>    <span class="k">def</span> <span class="nf">image_merge</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Merge subimages into master image&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&quot;Blank&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">(),</span><span class="s">&quot;Merge&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lenslet_merge</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;yellow&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&quot;Merge&quot;</span><span class="p">)</span>
        </div>
    <span class="k">def</span> <span class="nf">_lenslet_merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lenslet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Merge a single lenslet into the master image&quot;&quot;&quot;</span>
        <span class="n">lenslet</span><span class="o">.</span><span class="n">read_subimage</span><span class="p">()</span>
        <span class="n">lenslet</span><span class="o">.</span><span class="n">bin_subimage</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">lenslet</span><span class="o">.</span><span class="n">data</span><span class="p">(),</span><span class="n">lenslet</span><span class="o">.</span><span class="n">subcorner</span><span class="p">)</span>
        <span class="n">lenslet</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
<div class="viewcode-block" id="SEDSimulator.setup_scatter"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_scatter">[docs]</a>    <span class="k">def</span> <span class="nf">setup_scatter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets up scattered light level&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full</span> <span class="o">=</span> <span class="n">FlatSpectrum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scatter_addition</span><span class="p">,</span><span class="s">&quot;green&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_resolved</span> <span class="o">=</span> <span class="n">InterpolatedSpectrum</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;wavelengths&quot;</span><span class="p">][</span><span class="s">&quot;values&quot;</span><span class="p">],</span><span class="n">resolution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;wavelengths&quot;</span><span class="p">][</span><span class="s">&quot;resolutions&quot;</span><span class="p">]),</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Full Addition&quot;</span><span class="p">)</span>
        <span class="n">scatter_mag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_resolved</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;scatter&quot;</span><span class="p">][</span><span class="s">&quot;wavelength&quot;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gauss_kern</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;scatter&quot;</span><span class="p">][</span><span class="s">&quot;radius&quot;</span><span class="p">],</span><span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;ccd_size&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">scatter_mag</span><span class="p">,</span><span class="s">&quot;Scatter&quot;</span><span class="p">)</span>
        <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        </div>
    <span class="k">def</span> <span class="nf">_scatter_addition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lenslet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add all spectra together for scattered light purposes&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full</span> <span class="o">+=</span> <span class="n">lenslet</span><span class="o">.</span><span class="n">spectrum</span>
        
        
        
<div class="viewcode-block" id="SEDSimulator.ccd_crop"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.ccd_crop">[docs]</a>    <span class="k">def</span> <span class="nf">ccd_crop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Crops the image to the appropriate ccd size&quot;&quot;&quot;</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;ccd_size&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">size</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="SEDSimulator.setup_noise"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_noise">[docs]</a>    <span class="k">def</span> <span class="nf">setup_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes noise masks&quot;&quot;&quot;</span>
        
        <span class="n">read_noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cameras</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;camera&quot;</span><span class="p">]][</span><span class="s">&quot;RN&quot;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;psf_size&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Observation&quot;</span><span class="p">][</span><span class="s">&quot;number&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;gain&quot;</span><span class="p">])</span>
        <span class="n">dark_noise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cameras</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;camera&quot;</span><span class="p">]][</span><span class="s">&quot;DC&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Observation&quot;</span><span class="p">][</span><span class="s">&quot;exposure&quot;</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_poisson_noise</span><span class="p">(</span><span class="s">&quot;Read&quot;</span><span class="p">,</span><span class="n">read_noise</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_poisson_noise</span><span class="p">(</span><span class="s">&quot;Dark&quot;</span><span class="p">,</span><span class="n">dark_noise</span><span class="p">)</span>
    
        </div>
<div class="viewcode-block" id="SEDSimulator.apply_noise"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.apply_noise">[docs]</a>    <span class="k">def</span> <span class="nf">apply_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply the noise masks to the target image label&quot;&quot;&quot;</span>
        
        <span class="n">dark</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="s">&quot;Dark&quot;</span><span class="p">)</span>
        <span class="n">bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="s">&quot;Read&quot;</span><span class="p">)</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
        
        <span class="n">data</span> <span class="o">+=</span> <span class="n">dark</span> <span class="o">+</span> <span class="n">bias</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="s">&quot;Noisy&quot;</span><span class="p">,</span><span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="SEDSimulator.apply_scatter"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.apply_scatter">[docs]</a>    <span class="k">def</span> <span class="nf">apply_scatter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply the scattered light frame&quot;&quot;&quot;</span>
        
        <span class="n">scatter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="s">&quot;Scatter&quot;</span><span class="p">)</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
        
        <span class="n">data</span> <span class="o">+=</span> <span class="n">scatter</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="s">&quot;Scattered&quot;</span><span class="p">,</span><span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
    </div>
<div class="viewcode-block" id="SEDSimulator.transpose"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.transpose">[docs]</a>    <span class="k">def</span> <span class="nf">transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;transpose the final image&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="s">&quot;Transposed&quot;</span><span class="p">,</span><span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
    </div>
<div class="viewcode-block" id="SEDSimulator.save_file"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.save_file">[docs]</a>    <span class="k">def</span> <span class="nf">save_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Saves the file&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Filename</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Images)s</span><span class="s">/</span><span class="si">%(label)s</span><span class="s">-</span><span class="si">%(date)s</span><span class="s">.</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Output&quot;</span><span class="p">][</span><span class="s">&quot;Label&quot;</span><span class="p">],</span><span class="n">date</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">),</span> <span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Output&quot;</span><span class="p">][</span><span class="s">&quot;Format&quot;</span><span class="p">],</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">]</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Filename</span><span class="p">,</span><span class="n">states</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">statename</span><span class="p">],</span><span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Wrote </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">Filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Filename</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Images)s</span><span class="s">/</span><span class="si">%(label)s</span><span class="s">-deep-</span><span class="si">%(date)s</span><span class="s">.</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Output&quot;</span><span class="p">][</span><span class="s">&quot;Label&quot;</span><span class="p">],</span><span class="n">date</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">),</span> <span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Output&quot;</span><span class="p">][</span><span class="s">&quot;Format&quot;</span><span class="p">],</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">]</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Filename</span><span class="p">,</span><span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Wrote </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">Filename</span><span class="p">)</span>
    
    
    <span class="c">################################</span>
    <span class="c">## IMAGE MANAGEMENT FUNCTIONS ##</span>
    <span class="c">################################</span>
        </div>
<div class="viewcode-block" id="SEDSimulator.place"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.place">[docs]</a>    <span class="k">def</span> <span class="nf">place</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">img</span><span class="p">,</span><span class="n">corner</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Place the given AstroObject.AnalyticSpectra.AnalyticSpectrum onto the SEDMachine Image&quot;&quot;&quot;</span>
        
        <span class="n">xstart</span> <span class="o">=</span> <span class="n">corner</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">xend</span> <span class="o">=</span> <span class="n">xstart</span> <span class="o">+</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ystart</span> <span class="o">=</span> <span class="n">corner</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">yend</span> <span class="o">=</span> <span class="n">ystart</span> <span class="o">+</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">xend</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">yend</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SEDLimits</span>
        
        <span class="k">if</span> <span class="n">xstart</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">ystart</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SEDLimits</span>
        
        <span class="k">if</span> <span class="n">xend</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">yend</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SEDLimits</span>
        
        <span class="n">data</span><span class="p">[</span><span class="n">xstart</span><span class="p">:</span><span class="n">xend</span><span class="p">,</span><span class="n">ystart</span><span class="p">:</span><span class="n">yend</span><span class="p">]</span> <span class="o">+=</span> <span class="n">img</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">statename</span><span class="p">,</span><span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>    
        
    </div>
<div class="viewcode-block" id="SEDSimulator.crop"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.crop">[docs]</a>    <span class="k">def</span> <span class="nf">crop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">xsize</span><span class="p">,</span><span class="n">ysize</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Crops the provided image to twice the specified size, centered around the x and y coordinates provided.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ysize</span><span class="p">:</span>
            <span class="n">ysize</span> <span class="o">=</span> <span class="n">xsize</span>
        <span class="n">cropped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">statename</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="n">xsize</span><span class="p">:</span><span class="n">x</span><span class="o">+</span><span class="n">xsize</span><span class="p">,</span><span class="n">y</span><span class="o">-</span><span class="n">ysize</span><span class="p">:</span><span class="n">y</span><span class="o">+</span><span class="n">ysize</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Cropped and Saved Image&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s">&quot;Cropped&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">cropped</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    
    <span class="c">#######################</span>
    <span class="c">## DEBUGGING METHODS ##</span>
    <span class="c">#######################</span>
    </div>
<div class="viewcode-block" id="SEDSimulator.plot_dispersion_data"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_dispersion_data">[docs]</a>    <span class="k">def</span> <span class="nf">plot_dispersion_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Outputs dispersion debugging data&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="o">.</span><span class="n">plot_dispersion</span><span class="p">(),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="SEDSimulator.plot_trace_data"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_trace_data">[docs]</a>    <span class="k">def</span> <span class="nf">plot_trace_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Outputs plots about each lenslet trace&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="SEDSimulator.plot_spectrum_data"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_spectrum_data">[docs]</a>    <span class="k">def</span> <span class="nf">plot_spectrum_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Outputs plots about each lenslet trace&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="o">.</span><span class="n">plot_spectrum</span><span class="p">(),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="SEDSimulator.plot_lenslet_data"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_lenslet_data">[docs]</a>    <span class="k">def</span> <span class="nf">plot_lenslet_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Outputs the lenslet data&quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Plotting lenslet arc positions in CCD (x,y) space&quot;</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Lenslet-xy</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots&quot;</span><span class="p">][</span><span class="s">&quot;format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">xcs</span><span class="p">,</span><span class="n">l</span><span class="o">.</span><span class="n">ycs</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Lenslet x-y positions&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Plotting lenslet physical positions in mm space&quot;</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Lenslet-pxy</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots&quot;</span><span class="p">][</span><span class="s">&quot;format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">l</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">marker</span><span class="o">=</span><span class="s">&#39;.&#39;</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
            
            
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Lenslet p-xy positions&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="o">.</span><span class="n">plot_raw_data</span><span class="p">(),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="SEDSimulator.compare_methods"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.compare_methods">[docs]</a>    <span class="k">def</span> <span class="nf">compare_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A plot for comparing resolving methods&quot;&quot;&quot;</span>
        <span class="n">WL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;wavelengths&quot;</span><span class="p">][</span><span class="s">&quot;values&quot;</span><span class="p">]</span>
        <span class="n">RS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;wavelengths&quot;</span><span class="p">][</span><span class="s">&quot;resolutions&quot;</span><span class="p">]</span>
        <span class="n">DWL</span><span class="p">,</span><span class="n">DRS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_resolution_spectrum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">WL</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">WL</span><span class="p">),</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">SWL</span><span class="p">,</span><span class="n">SRS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_resolution_spectrum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">WL</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">WL</span><span class="p">),</span><span class="mi">500</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Resolutions&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">RS</span><span class="p">,</span><span class="s">&#39;g.&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">DWL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">DRS</span><span class="p">,</span><span class="s">&#39;r.&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">SWL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">SRS</span><span class="p">,</span><span class="s">&#39;b.&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="n">expandLim</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">()))</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Test-Spectrum-Res</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots&quot;</span><span class="p">][</span><span class="s">&quot;format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Resolve \&amp; Resample Tests&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">npArrayInfo</span><span class="p">(</span><span class="n">WL</span><span class="p">,</span><span class="s">&quot;Wavelength for Sky Plot&quot;</span><span class="p">))</span>
        
        <span class="n">Results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">master</span> <span class="o">=</span> <span class="s">&quot;H Iq&quot;</span>
        
        <span class="k">for</span> <span class="n">wl</span><span class="p">,</span><span class="n">rs</span><span class="p">,</span><span class="n">Label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span><span class="n">DWL</span><span class="p">,</span><span class="n">SWL</span><span class="p">],[</span><span class="n">RS</span><span class="p">,</span><span class="n">DRS</span><span class="p">,</span><span class="n">SRS</span><span class="p">],[</span><span class="s">&quot;L&quot;</span><span class="p">,</span><span class="s">&quot;M&quot;</span><span class="p">,</span><span class="s">&quot;H&quot;</span><span class="p">]):</span>
            <span class="n">identity</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> Iq&quot;</span> <span class="o">%</span> <span class="n">Label</span>                
            <span class="n">wl</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Original</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">wl</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">rs</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&quot;integrate_quad&quot;</span><span class="p">)</span>
            <span class="n">Results</span><span class="p">[</span><span class="n">identity</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">FL</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">wl</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;g.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&quot;-&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> $\Sigma$</span><span class="si">%.2e</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">identity</span><span class="p">,</span><span class="n">Results</span><span class="p">[</span><span class="n">identity</span><span class="p">]))</span>
            
            <span class="n">identity</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> Ih&quot;</span> <span class="o">%</span> <span class="n">Label</span>                
            <span class="n">wl</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Original</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">wl</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">rs</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&quot;integrate_hist&quot;</span><span class="p">)</span>
            <span class="n">Results</span><span class="p">[</span><span class="n">identity</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">FL</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">wl</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;b.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&quot;-&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> $\Sigma$</span><span class="si">%.2e</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">identity</span><span class="p">,</span><span class="n">Results</span><span class="p">[</span><span class="n">identity</span><span class="p">]))</span>
            
            <span class="n">identity</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> RR&quot;</span> <span class="o">%</span> <span class="n">Label</span>                
            <span class="n">wl</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Original</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">wl</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">rs</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&quot;resolve_and_integrate&quot;</span><span class="p">)</span>
            <span class="n">Results</span><span class="p">[</span><span class="n">identity</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">FL</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">wl</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;r.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&quot;-&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> $\Sigma$</span><span class="si">%.2e</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">identity</span><span class="p">,</span><span class="n">Results</span><span class="p">[</span><span class="n">identity</span><span class="p">]))</span>
        
        <span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Error relative to </span><span class="si">%s</span><span class="s"> in integration and resolution spectrum methods:</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">master</span>
        <span class="n">mv</span> <span class="o">=</span> <span class="n">Results</span><span class="p">[</span><span class="n">master</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">Label</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;L&quot;</span><span class="p">,</span><span class="s">&quot;M&quot;</span><span class="p">,</span><span class="s">&quot;H&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;Iq&quot;</span><span class="p">,</span><span class="s">&quot;Ih&quot;</span><span class="p">,</span><span class="s">&quot;RR&quot;</span><span class="p">]:</span>
                <span class="n">identity</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(label)s</span><span class="s"> </span><span class="si">%(method)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s">&#39;label&#39;</span><span class="p">:</span><span class="n">Label</span><span class="p">,</span><span class="s">&#39;method&#39;</span><span class="p">:</span><span class="n">method</span><span class="p">}</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">Results</span><span class="p">[</span><span class="n">identity</span><span class="p">]</span>
                <span class="n">perr</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">val</span> <span class="o">-</span> <span class="n">mv</span><span class="p">)</span> <span class="o">/</span> <span class="n">mv</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span>
                <span class="n">line</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(identity)s</span><span class="s"> $\Sigma = $</span><span class="si">%(value).3e</span><span class="s"> Error </span><span class="si">%(perr).2f</span><span class="s"> \</span><span class="si">%%</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s">&#39;identity&#39;</span><span class="p">:</span><span class="n">identity</span><span class="p">,</span><span class="s">&#39;value&#39;</span><span class="p">:</span><span class="n">val</span><span class="p">,</span><span class="s">&#39;perr&#39;</span><span class="p">:</span><span class="n">perr</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">identity</span> <span class="o">==</span> <span class="n">master</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s">&quot; MASTER</span><span class="se">\n</span><span class="s">&quot;</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="n">line</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;Flux (Photons)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;expand&quot;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Test-R-and-R</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots&quot;</span><span class="p">][</span><span class="s">&quot;format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        
        
        
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Resolve \&amp; Resample Test Results&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span><span class="n">text</span><span class="p">,</span>
            <span class="n">horizontalalignment</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">,</span>
            <span class="n">verticalalignment</span><span class="o">=</span><span class="s">&#39;center&#39;</span><span class="p">,</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Test-R-and-R-vals</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots&quot;</span><span class="p">][</span><span class="s">&quot;format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        
        
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Resample Tests&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">npArrayInfo</span><span class="p">(</span><span class="n">WL</span><span class="p">,</span><span class="s">&quot;Wavelength for Sky Plot&quot;</span><span class="p">))</span>
        
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Original</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&quot;interpolate&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Interpolate&quot;</span><span class="p">)</span>
        
        <span class="n">SWL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Original</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">SWL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">SRS</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&quot;resample&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">SWL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;SR Resample&quot;</span><span class="p">)</span>
        
        <span class="n">DWL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Original</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">DWL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">DRS</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&quot;resample&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">DWL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;HR Resample&quot;</span><span class="p">)</span>
        
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Original</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&quot;resample&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;LR Resample&quot;</span><span class="p">)</span>
        
        


        
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;Flux (Photons)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Test-Resample</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots&quot;</span><span class="p">][</span><span class="s">&quot;format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        
        
    </div>
<div class="viewcode-block" id="SEDSimulator.plot_sky"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_sky">[docs]</a>    <span class="k">def</span> <span class="nf">plot_sky</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot sky spectrum&quot;&quot;&quot;</span>
        <span class="n">WL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;wavelengths&quot;</span><span class="p">][</span><span class="s">&quot;values&quot;</span><span class="p">]</span>
        <span class="n">RS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;wavelengths&quot;</span><span class="p">][</span><span class="s">&quot;resolutions&quot;</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Resolution&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">RS</span><span class="p">,</span><span class="s">&#39;g.&#39;</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Sky-Spectrum-Res</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots&quot;</span><span class="p">][</span><span class="s">&quot;format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Sky Spectrum&quot;</span><span class="p">)</span>

        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SkySpectrum</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;b.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Sky + Moon (qe)&quot;</span><span class="p">)</span>
        
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SkyMoon</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;m.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Sky + Moon&quot;</span><span class="p">)</span>
        
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SkyOriginal</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;g.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Sky&quot;</span><span class="p">)</span>
        
        <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">()</span>
        
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MoonSpectrum</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;y.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Moon&quot;</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MoonSpectrumQE</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;c.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Moon (qe)&quot;</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;Flux (Photons)&quot;</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Sky-Spectrum</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots&quot;</span><span class="p">][</span><span class="s">&quot;format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    </div>
<div class="viewcode-block" id="SEDSimulator.plot_sky_original"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_sky_original">[docs]</a>    <span class="k">def</span> <span class="nf">plot_sky_original</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot sky spectrum&quot;&quot;&quot;</span>
        <span class="n">WL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;wavelengths&quot;</span><span class="p">][</span><span class="s">&quot;values&quot;</span><span class="p">]</span>
        <span class="n">RS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;wavelengths&quot;</span><span class="p">][</span><span class="s">&quot;resolutions&quot;</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Resolution&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">RS</span><span class="p">,</span><span class="s">&#39;g.&#39;</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Sky-Spectrum-Res</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots&quot;</span><span class="p">][</span><span class="s">&quot;format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Sky Spectrum&quot;</span><span class="p">)</span>

        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SkyOriginal</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;g.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Sky&quot;</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;Flux (Photons)&quot;</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Sky-Original-Spectrum</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots&quot;</span><span class="p">][</span><span class="s">&quot;format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    
    </div>
<div class="viewcode-block" id="SEDSimulator.plot_original_calibration"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_original_calibration">[docs]</a>    <span class="k">def</span> <span class="nf">plot_original_calibration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot the original calibration source&quot;&quot;&quot;</span>
        <span class="n">WL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;wavelengths&quot;</span><span class="p">][</span><span class="s">&quot;values&quot;</span><span class="p">]</span>
        <span class="n">RS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;wavelengths&quot;</span><span class="p">][</span><span class="s">&quot;resolutions&quot;</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Calibration Spectrum&quot;</span><span class="p">)</span>
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CalSpec</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;r.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Source&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;Flux (Photons)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Cal-Original-Spectrum</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots&quot;</span><span class="p">][</span><span class="s">&quot;format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        
    </div>
<div class="viewcode-block" id="SEDSimulator.plot_original_source"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_original_source">[docs]</a>    <span class="k">def</span> <span class="nf">plot_original_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot the original source spectrum only&quot;&quot;&quot;</span>
        <span class="n">WL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;wavelengths&quot;</span><span class="p">][</span><span class="s">&quot;values&quot;</span><span class="p">]</span>
        <span class="n">RS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;wavelengths&quot;</span><span class="p">][</span><span class="s">&quot;resolutions&quot;</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Resolution&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">RS</span><span class="p">,</span><span class="s">&#39;g.&#39;</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Source-Spectrum-Res</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots&quot;</span><span class="p">][</span><span class="s">&quot;format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Source Spectrum&quot;</span><span class="p">)</span>
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Original</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;r.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Source&quot;</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;Flux (Photons)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Source-Original-Spectrum</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots&quot;</span><span class="p">][</span><span class="s">&quot;format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        
    </div>
<div class="viewcode-block" id="SEDSimulator.plot_source"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_source">[docs]</a>    <span class="k">def</span> <span class="nf">plot_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot the source spectrum&quot;&quot;&quot;</span>
        <span class="n">WL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;wavelengths&quot;</span><span class="p">][</span><span class="s">&quot;values&quot;</span><span class="p">]</span>
        <span class="n">RS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;wavelengths&quot;</span><span class="p">][</span><span class="s">&quot;resolutions&quot;</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Resolution&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">RS</span><span class="p">,</span><span class="s">&#39;g.&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Requested R&quot;</span><span class="p">)</span>
        <span class="n">GWL</span><span class="p">,</span><span class="n">GFL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SpectrumData</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">GWL</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">GWL</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">GWL</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Given R&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Source-Spectrum-Res</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots&quot;</span><span class="p">][</span><span class="s">&quot;format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Source Spectrum&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">npArrayInfo</span><span class="p">(</span><span class="n">WL</span><span class="p">,</span><span class="s">&quot;Wavelength for Sky Plot&quot;</span><span class="p">))</span>
        
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Spectrum</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">npArrayInfo</span><span class="p">(</span><span class="n">WL</span><span class="p">,</span><span class="s">&quot;Wavelength from Source Plot&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">npArrayInfo</span><span class="p">(</span><span class="n">FL</span><span class="p">,</span><span class="s">&quot;Flux from Source Plot&quot;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;b.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Combined&quot;</span><span class="p">)</span>
        
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Spectrum</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Extinction</span><span class="p">)(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;m.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Source (qe)&quot;</span><span class="p">)</span>
        
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SkySpectrum</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;g.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Sky (qe)&quot;</span><span class="p">)</span>
        
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SkyMoon</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;m.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Sky + Moon&quot;</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        
        
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SkyOriginal</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;c.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Sky&quot;</span><span class="p">)</span>
        
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Original</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;r.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Source&quot;</span><span class="p">)</span>
        
        <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">()</span>
        
        
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MoonSpectrum</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">npArrayInfo</span><span class="p">(</span><span class="n">WL</span><span class="p">,</span><span class="s">&quot;Wavelength from Moon Plot&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">npArrayInfo</span><span class="p">(</span><span class="n">FL</span><span class="p">,</span><span class="s">&quot;Flux from Moon Plot&quot;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;y.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Moon&quot;</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        
        
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;Flux (Photons)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Source-Spectrum</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots&quot;</span><span class="p">][</span><span class="s">&quot;format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        
</div>
<div class="viewcode-block" id="SEDSimulator.plot_qe"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_qe">[docs]</a>    <span class="k">def</span> <span class="nf">plot_qe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot sky spectrum&quot;&quot;&quot;</span>
        <span class="n">WL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;wavelengths&quot;</span><span class="p">][</span><span class="s">&quot;values&quot;</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;QE Spectrum&quot;</span><span class="p">)</span>
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qe</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;Thpt&quot;</span><span class="p">][</span><span class="s">&quot;Type&quot;</span><span class="p">]](</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;b.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Quantum Efficiency&quot;</span><span class="p">)</span>
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Extinction</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;m.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Extinction&quot;</span><span class="p">)</span>
        
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_formatter</span><span class="p">(</span>
            <span class="n">LogFormatterTeXExponent</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
             <span class="n">labelOnlyBase</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
                     
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;Flux (Fraction)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/QE-Spectrum</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots&quot;</span><span class="p">][</span><span class="s">&quot;format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    </div>
<div class="viewcode-block" id="SEDSimulator.plot_hexagons"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_hexagons">[docs]</a>    <span class="k">def</span> <span class="nf">plot_hexagons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot the lenslet Hexagons&quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Position of Lenslets&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span><span class="n">l</span><span class="o">.</span><span class="n">show_geometry</span><span class="p">(),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Lenslet-Hexagons</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots&quot;</span><span class="p">][</span><span class="s">&quot;format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        </div>
<div class="viewcode-block" id="SEDSimulator.plot_pixels"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_pixels">[docs]</a>    <span class="k">def</span> <span class="nf">plot_pixels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot the source pixels&quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Position of pixels&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_pixels</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">show_geometry</span><span class="p">(),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Pixel-Geometry</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots&quot;</span><span class="p">][</span><span class="s">&quot;format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    </div>
<div class="viewcode-block" id="SEDSimulator.plot_invalid_pixels"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_invalid_pixels">[docs]</a>    <span class="k">def</span> <span class="nf">plot_invalid_pixels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot invalid shapes&quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Position of invalid pixels&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_pixels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_plot_invalid_pixels</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Pixel-Invalid-Geometry</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots&quot;</span><span class="p">][</span><span class="s">&quot;format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    </div>
    <span class="k">def</span> <span class="nf">_plot_invalid_pixels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pixel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for _plot_invalid_hexagon&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pixel</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
            <span class="n">pixel</span><span class="o">.</span><span class="n">show_geometry</span><span class="p">()</span>
    
        
<div class="viewcode-block" id="SEDSimulator.plot_invalid_hexagons"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_invalid_hexagons">[docs]</a>    <span class="k">def</span> <span class="nf">plot_invalid_hexagons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot invalid shapes&quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Position of invalid hexagons&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_plot_invalid_hexagon</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Lenslet-Invalid-Geometry</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots&quot;</span><span class="p">][</span><span class="s">&quot;format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    </div>
    <span class="k">def</span> <span class="nf">_plot_invalid_hexagon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lenslet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for _plot_invalid_hexagon&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lenslet</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
            <span class="n">lenslet</span><span class="o">.</span><span class="n">show_geometry</span><span class="p">()</span>
        
<div class="viewcode-block" id="SEDSimulator.plot_geometry"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_geometry">[docs]</a>    <span class="k">def</span> <span class="nf">plot_geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot all of the geomoetry stacked&quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Lenslet Plane Geometry&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span><span class="n">l</span><span class="o">.</span><span class="n">show_geometry</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;#cccc00&quot;</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_pixels</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">show_geometry</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;#cc00cc&quot;</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/System-Geometry</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots&quot;</span><span class="p">][</span><span class="s">&quot;format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    </div>
<div class="viewcode-block" id="SEDSimulator.plot_resample"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_resample">[docs]</a>    <span class="k">def</span> <span class="nf">plot_resample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show the geometric resample&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_pixels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_show_resample</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
    </div>
    <span class="k">def</span> <span class="nf">_show_resample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pixel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for _show_resample&quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Resample for pixel </span><span class="si">%g</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">pixel</span><span class="o">.</span><span class="n">num</span><span class="p">)</span>
        <span class="n">pixel</span><span class="o">.</span><span class="n">show_geometry</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_show_lenslet_resample</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">pixel</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="c"># plt.colorbar()</span>
        
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/System-Geometry-</span><span class="si">%(pixel)g%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">pixel</span><span class="o">=</span><span class="n">pixel</span><span class="o">.</span><span class="n">num</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots&quot;</span><span class="p">][</span><span class="s">&quot;format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
   
<div class="viewcode-block" id="SEDSimulator.plot_kernel_partials"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_kernel_partials">[docs]</a>    <span class="k">def</span> <span class="nf">plot_kernel_partials</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plots the kernel data partials&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Generating Kernel Plots and Images&quot;</span><span class="p">)</span>
        <span class="n">major</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;tel_radii&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;density&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.2</span>
        <span class="n">minor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;tel_radii&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;density&quot;</span><span class="p">]</span>
        <span class="n">ETEL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tel_kern</span><span class="p">(</span><span class="n">major</span><span class="p">,</span><span class="n">minor</span><span class="p">)</span>
        <span class="n">ECONV</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="p">[</span><span class="s">&quot;PSF&quot;</span><span class="p">],</span><span class="n">ETEL</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;same&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ETEL</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Telescope Image (Ellipse)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/Instrument-ETEL-Kernel</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">][</span><span class="s">&quot;Partials&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots&quot;</span><span class="p">][</span><span class="s">&quot;format&quot;</span><span class="p">]))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ECONV</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Convolved ETel + PSF Image&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/Instrument-ECONV-Kernel</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">][</span><span class="s">&quot;Partials&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots&quot;</span><span class="p">][</span><span class="s">&quot;format&quot;</span><span class="p">]))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        
        
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="p">[</span><span class="s">&quot;TEL&quot;</span><span class="p">],</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Telescope Image&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/Instrument-TEL-Kernel</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">][</span><span class="s">&quot;Partials&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots&quot;</span><span class="p">][</span><span class="s">&quot;format&quot;</span><span class="p">]))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="p">[</span><span class="s">&quot;PSF&quot;</span><span class="p">],</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;PSF Image&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/Instrument-PSF-Kernel</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">][</span><span class="s">&quot;Partials&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots&quot;</span><span class="p">][</span><span class="s">&quot;format&quot;</span><span class="p">]))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="p">[</span><span class="s">&quot;CONV&quot;</span><span class="p">],</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Convolved Tel + PSF Image&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/Instrument-FIN-Kernel</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">][</span><span class="s">&quot;Partials&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots&quot;</span><span class="p">][</span><span class="s">&quot;format&quot;</span><span class="p">]))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        
        </div>
    <span class="k">def</span> <span class="nf">_show_lenslet_resample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lenslet</span><span class="p">,</span><span class="n">pixel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for _show_lenslet_resample&quot;&quot;&quot;</span>
        <span class="n">lenslet</span><span class="o">.</span><span class="n">show_geometry</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">pixel</span><span class="o">.</span><span class="n">get_color</span><span class="p">(</span><span class="n">lenslet</span><span class="o">.</span><span class="n">idx</span><span class="p">))</span>
    
    
<div class="viewcode-block" id="SEDSimulator.write_resample"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.write_resample">[docs]</a>    <span class="k">def</span> <span class="nf">write_resample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the resample matrix to file&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Resample-info.dat&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">]),</span><span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infostream</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Resample.dat&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">]),</span><span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">rawstream</span><span class="p">:</span>
                <span class="n">infostream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;# Resample Matrix </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_resample</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">infostream</span><span class="p">,</span><span class="n">rawstream</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
    </div>
    <span class="k">def</span> <span class="nf">_write_resample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lenslet</span><span class="p">,</span><span class="n">streama</span><span class="p">,</span><span class="n">streamb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the resampleing matrix&quot;&quot;&quot;</span>
        <span class="n">string</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(lenslet)d</span><span class="s"> </span><span class="si">%(info)s</span><span class="s"> </span><span class="si">%(spec)s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">{</span> <span class="s">&#39;lenslet&#39;</span><span class="p">:</span> <span class="n">lenslet</span><span class="o">.</span><span class="n">num</span><span class="p">,</span> <span class="s">&#39;info&#39;</span><span class="p">:</span> <span class="n">npArrayInfo</span><span class="p">(</span><span class="n">lenslet</span><span class="o">.</span><span class="n">pixelValues</span><span class="p">),</span> <span class="s">&#39;array&#39;</span><span class="p">:</span> <span class="n">lenslet</span><span class="o">.</span><span class="n">pixelValues</span> <span class="p">,</span> <span class="s">&#39;spec&#39;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">lenslet</span><span class="o">.</span><span class="n">spectrum</span><span class="p">)}</span>
        <span class="n">streama</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">streamb</span><span class="p">,</span><span class="n">lenslet</span><span class="o">.</span><span class="n">pixelValues</span><span class="p">)</span>
        
    
    <span class="c">#######################</span>
    <span class="c">## Mapping Functions ##</span>
    <span class="c">#######################</span>
    
<div class="viewcode-block" id="SEDSimulator.map_over_lenslets"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.map_over_lenslets">[docs]</a>    <span class="k">def</span> <span class="nf">map_over_lenslets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">function</span><span class="p">,</span><span class="n">exceptions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;green&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps a given function to operate on each lenslet, and displays a progress bar along the way.&quot;&quot;&quot;</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lenslets</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_collection</span><span class="p">(</span><span class="n">function</span><span class="p">,</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span><span class="n">l</span><span class="o">.</span><span class="n">num</span><span class="p">,</span><span class="n">collection</span><span class="p">,</span><span class="n">exceptions</span><span class="p">,</span><span class="n">color</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="SEDSimulator.map_over_pixels"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.map_over_pixels">[docs]</a>    <span class="k">def</span> <span class="nf">map_over_pixels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">function</span><span class="p">,</span><span class="n">exceptions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;green&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps some function over a bunch of source pixels&quot;&quot;&quot;</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SourcePixels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_collection</span><span class="p">(</span><span class="n">function</span><span class="p">,</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">num</span><span class="p">,</span><span class="n">collection</span><span class="p">,</span><span class="n">exceptions</span><span class="p">,</span><span class="n">color</span><span class="p">)</span>
        
    </div>
<div class="viewcode-block" id="SEDSimulator.map_over_collection"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.map_over_collection">[docs]</a>    <span class="k">def</span> <span class="nf">map_over_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">function</span><span class="p">,</span><span class="n">idfun</span><span class="p">,</span><span class="n">collection</span><span class="p">,</span><span class="n">exceptions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;green&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for map_over_collection&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">exceptions</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">exceptions</span> <span class="o">=</span> <span class="ne">Exception</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">showBar</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">color</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">showBar</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bar</span> <span class="o">=</span> <span class="n">arpytools</span><span class="o">.</span><span class="n">progressbar</span><span class="o">.</span><span class="n">ProgressBar</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">useConsole</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bar</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;L:</span><span class="si">%4s</span><span class="s"> </span><span class="si">%4d</span><span class="s">/</span><span class="si">%-4d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">total</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_collection_map</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">function</span><span class="p">,</span><span class="n">exceptions</span><span class="p">,</span><span class="n">idfun</span><span class="p">,</span><span class="n">showBar</span><span class="p">),</span><span class="n">collection</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">showBar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bar</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="s">&quot;L:</span><span class="si">%4s</span><span class="s"> </span><span class="si">%4d</span><span class="s">/</span><span class="si">%-4d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;Done&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">total</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">useConsole</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Progress and Total are different at end of loop: </span><span class="si">%d</span><span class="s"> != </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">total</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Trapped </span><span class="si">%d</span><span class="s"> errors&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span> <span class="o">=</span> <span class="bp">False</span>
        
    
            </div>
    <span class="k">def</span> <span class="nf">_collection_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lenslet</span><span class="p">,</span><span class="n">function</span><span class="p">,</span><span class="n">exceptions</span><span class="p">,</span><span class="n">idfun</span><span class="p">,</span><span class="n">showBar</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps something over a bunch of lenslets&quot;&quot;&quot;</span>
        <span class="n">identity</span> <span class="o">=</span> <span class="n">idfun</span><span class="p">(</span><span class="n">lenslet</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">showBar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bar</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span><span class="s">&quot;L:</span><span class="si">%4d</span><span class="s"> </span><span class="si">%4d</span><span class="s">/</span><span class="si">%-4d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">identity</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">total</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">function</span><span class="p">(</span><span class="n">lenslet</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exceptions</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">u&quot;Caught </span><span class="si">%s</span><span class="s"> in </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span><span class="n">identity</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">u&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Debug&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">useConsole</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">showBar</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">+=</span> <span class="mf">1.0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bar</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span><span class="s">&quot;L:</span><span class="si">%4d</span><span class="s"> </span><span class="si">%4d</span><span class="s">/</span><span class="si">%-4d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">identity</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">total</span><span class="p">))</span>
        
        
        
    <span class="c">###################</span>
    <span class="c">## Image KERNELS ##</span>
    <span class="c">###################</span>
    
    
    
<div class="viewcode-block" id="SEDSimulator.generate_poisson_noise"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.generate_poisson_noise">[docs]</a>    <span class="k">def</span> <span class="nf">generate_poisson_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">lam</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates a poisson noise mask, saving to this object&quot;&quot;&quot;</span>
        <span class="n">distribution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;ccd_size&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;ccd_size&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s">&quot;Poisson Noise Mask (</span><span class="si">%2g</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lam</span><span class="p">)</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="p">(</span><span class="n">lam</span><span class="p">,</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">distribution</span><span class="p">(</span><span class="o">*</span><span class="n">arguments</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span><span class="n">label</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="SEDSimulator.get_conv"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.get_conv">[docs]</a>    <span class="k">def</span> <span class="nf">get_conv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">wavelength</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a PSF for a given wavelength in the system&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">b</span><span class="p">:</span>
            <span class="n">ETEL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tel_kern</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CONV</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="p">[</span><span class="s">&quot;PSF&quot;</span><span class="p">],</span><span class="n">ETEL</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;same&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&quot;found&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">found</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CONV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="p">[</span><span class="s">&quot;CONV&quot;</span><span class="p">]</span> 
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONV</span>
    </div>
<div class="viewcode-block" id="SEDSimulator.psf_kern"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.psf_kern">[docs]</a>    <span class="k">def</span> <span class="nf">psf_kern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">truncate</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">header_lines</span><span class="o">=</span><span class="mi">18</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates a PSF Kernel from a file with micron-encircled energy conversions. The file should have two columns, first, microns from the center of the PSF, and second, the fraction of encircled energy at that distance from the PSF.</span>
<span class="sd">        </span>
<span class="sd">        The calculation is then carried out using a spline fit to this data. From the spline fit, the function returns the first derivative of the encircled energy at each point. This in effect is the amount of energy at each point. These values are then normalized, to create a PSF mask for the instrument.</span>
<span class="sd">        </span>
<span class="sd">        The `size` parameter specifies the size of the kernel to use. If the size is greater than the encircled energy data, then a larger figure will be returned. If `size` is smaller than the encircled energy data, it will return an image the size of the encircled energy data, unless the `truncate` parameter is set to `true`.</span>
<span class="sd">        </span>
<span class="sd">        The `header_lines` parameter defaults to 18, which works with Zemax encircled energy output.&quot;&quot;&quot;</span>
        
        <span class="n">uM</span><span class="p">,</span><span class="n">FR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">skip_header</span><span class="o">=</span><span class="n">header_lines</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="c"># Convert microns to milimeters, then pixels, then dense pixels</span>
        <span class="n">PX</span> <span class="o">=</span> <span class="n">uM</span> <span class="o">*</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;convert&quot;</span><span class="p">][</span><span class="s">&quot;mmtopx&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;density&quot;</span><span class="p">]</span>
        <span class="c"># Set the frame size for the PSF</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">PX</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">size</span> <span class="ow">or</span> <span class="n">truncate</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">PX</span><span class="p">))</span>
        <span class="c"># Create the Interpolation Function</span>
        <span class="n">fit_vars</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">PX</span><span class="p">,</span><span class="n">FR</span><span class="p">)</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">fit_vars</span><span class="p">,</span><span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">vfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
        <span class="c"># Create the 2-D function application grid</span>
        <span class="n">x</span> <span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="o">-</span><span class="n">size</span><span class="p">:</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="n">size</span><span class="p">:</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="c"># Convert this grid into the distance from the center of the PSF at each point</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">vfit</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">v</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Generated a PSF Kernel for the encircled energy file </span><span class="si">%s</span><span class="s"> with shape </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">val</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    
    </div>
<div class="viewcode-block" id="SEDSimulator.ellipse_kern"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.ellipse_kern">[docs]</a>    <span class="k">def</span> <span class="nf">ellipse_kern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">major</span><span class="p">,</span><span class="n">minor</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">sizey</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">normalize</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for elipse_kern&quot;&quot;&quot;</span>
        <span class="n">size</span> <span class="o">/=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">sizey</span><span class="p">:</span>
            <span class="n">sizey</span> <span class="o">/=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">minor</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">minor</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sizey</span><span class="p">:</span>
            <span class="n">sizey</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sizey</span> <span class="o">&lt;</span> <span class="n">major</span><span class="p">:</span>
            <span class="n">sizey</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">major</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sizey</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">sizey</span><span class="p">)</span>
        
        <span class="n">major</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">major</span><span class="p">)</span>
        <span class="n">minor</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">minor</span><span class="p">)</span>
        
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="o">-</span><span class="n">size</span><span class="p">:</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">sizey</span><span class="p">:</span><span class="n">sizey</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span><span class="o">/</span><span class="n">minor</span><span class="p">)</span><span class="o">**</span><span class="mf">2.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="n">major</span><span class="p">)</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>
        
        
        </div>
<div class="viewcode-block" id="SEDSimulator.circle_kern"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.circle_kern">[docs]</a>    <span class="k">def</span> <span class="nf">circle_kern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">sizey</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">normalize</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a Circle Kernel for modeling the \&quot;Image of the Telescope\&quot;. The radius should be set in array units.</span>
<span class="sd">        </span>
<span class="sd">        `size` will determine the size of the array image, unless `size` is less than `radius`, in which case the image will be automatically increased to fit the entire circle.</span>
<span class="sd">        </span>
<span class="sd">        `normalize` controls whether the data is normalized or not. If it is not normalized, the data will have only 1.0 and 0.0 values, where 1.0 is within the radius, and 0.0 is outside the raidus.&quot;&quot;&quot;</span>
        <span class="n">size</span> <span class="o">/=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">radius</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="o">-</span><span class="n">size</span><span class="p">:</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">size</span><span class="p">:</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mf">2.0</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span> <span class="o">&lt;=</span> <span class="n">radius</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>
    </div>
<div class="viewcode-block" id="SEDSimulator.gauss_kern"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.gauss_kern">[docs]</a>    <span class="k">def</span> <span class="nf">gauss_kern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stdev</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">stdevy</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">sizey</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a normalized 2D gaussian kernel array for convolutions.</span>
<span class="sd">        </span>
<span class="sd">        `stdev` is the standard deviation in the x-direction. If the `stdevy` keyword is not set, then it will be used as the standard deviation in the y-direction as well.</span>
<span class="sd">        </span>
<span class="sd">        `size` will determine the size of the returned image unless `size` is less than `stdev**2`.</span>
<span class="sd">        </span>
<span class="sd">        Results from this function are always normalized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">stdev</span><span class="o">**</span><span class="mf">2.0</span><span class="p">):</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">stdev</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stdevy</span><span class="p">:</span>
            <span class="n">stdevy</span> <span class="o">=</span> <span class="n">stdev</span>
        <span class="k">if</span> <span class="n">sizey</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">stdevy</span><span class="o">**</span><span class="mf">2.0</span><span class="p">):</span>
            <span class="n">sizey</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">stdevy</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sizey</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">sizey</span><span class="p">)</span>
        
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="o">-</span><span class="n">size</span><span class="p">:</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">sizey</span><span class="p">:</span><span class="n">sizey</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mf">2.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">stdev</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span><span class="o">+</span><span class="n">y</span><span class="o">**</span><span class="mf">2.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">stdevy</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)))</span>
        
        <span class="k">return</span> <span class="n">g</span> <span class="o">/</span> <span class="n">g</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    </div>
<div class="viewcode-block" id="SEDSimulator.get_tel_kern"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.get_tel_kern">[docs]</a>    <span class="k">def</span> <span class="nf">get_tel_kern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">major</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">minor</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the telescope kernel. This kernel is built by creating a circle mask for the size of the telescope mirror, and then subtracting a telescope obscuration from the center of the mirror image. The values for all of these items are set in the configuration file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">major</span> <span class="ow">or</span> <span class="n">minor</span><span class="p">:</span>
            <span class="n">TELIMG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ellipse_kern</span><span class="p">(</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span> <span class="p">)</span>
            <span class="n">center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ellipse_kern</span><span class="p">(</span> <span class="n">major</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;tel_obsc&quot;</span><span class="p">][</span><span class="s">&quot;ratio&quot;</span><span class="p">],</span> <span class="n">minor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;tel_obsc&quot;</span><span class="p">][</span><span class="s">&quot;ratio&quot;</span><span class="p">],</span> <span class="o">*</span><span class="n">TELIMG</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">TELIMG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">circle_kern</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;tel_radii&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;density&quot;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">circle_kern</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;tel_obsc&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;density&quot;</span><span class="p">]</span> <span class="p">,</span>
                <span class="o">*</span><span class="n">TELIMG</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span>
        <span class="n">TELIMG</span> <span class="o">-=</span> <span class="n">center</span>
        <span class="n">TELIMG</span> <span class="o">=</span> <span class="n">TELIMG</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">TELIMG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Generated a Telescpe Kernel with shape </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">TELIMG</span><span class="o">.</span><span class="n">shape</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">TELIMG</span>
    </div>
<div class="viewcode-block" id="SEDSimulator.get_psf_kern"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.get_psf_kern">[docs]</a>    <span class="k">def</span> <span class="nf">get_psf_kern</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the PSF Kernel. The function first tries to read the encircled energy file. In this case, if a `psf_size` is set in the instrument configuration, this value will be used to truncate the size of the encircled energy function. If the encircled energy function cannot be loaded, the system will fall back on to a gaussian psf as configured by the instrument.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;psf_size&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;psf_size&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;density&quot;</span><span class="p">]</span>
            <span class="n">truncate</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">truncate</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">PSFIMG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf_kern</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;files&quot;</span><span class="p">][</span><span class="s">&quot;encircledenergy&quot;</span><span class="p">],</span><span class="n">size</span><span class="p">,</span><span class="n">truncate</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Could not access encircled energy file: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">PSFIMG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gauss_kern</span><span class="p">(</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;psf_stdev&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;density&quot;</span><span class="p">])</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Loaded Encircled Energy from </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;files&quot;</span><span class="p">][</span><span class="s">&quot;encircledenergy&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">PSFIMG</span>
        </div>
<div class="viewcode-block" id="SEDSimulator.setup_configuration"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_configuration">[docs]</a>    <span class="k">def</span> <span class="nf">setup_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate dynamic configuration values.</span>
<span class="sd">        </span>
<span class="sd">        Currently, the configuration variables that use \&quot;px\&quot; or \&quot;mm\&quot; keys automatically have their counter-part filled in. As well, the conversion has its counterpart filled in. To disable this dynamic value setting, include a \&quot;calc:False\&quot; variable in the configuration.</span>
<span class="sd">        </span>
<span class="sd">        Example Configuration::</span>
<span class="sd">        </span>
<span class="sd">            image_size:</span>
<span class="sd">                mm: 40 # system will calculate pixels</span>
<span class="sd">            ccd_size:</span>
<span class="sd">                px: 2048</span>
<span class="sd">                calc: False # Conversion will not be performed by system</span>
<span class="sd">                mm: 30</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>        
        <span class="k">if</span> <span class="s">&quot;calc&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;convert&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s">&quot;mmtopx&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;convert&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="s">&quot;pxtomm&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;convert&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;convert&quot;</span><span class="p">][</span><span class="s">&quot;mmtopx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;convert&quot;</span><span class="p">][</span><span class="s">&quot;pxtomm&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;convert&quot;</span><span class="p">][</span><span class="s">&quot;calc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;convert&quot;</span><span class="p">][</span><span class="s">&quot;pxtomm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;convert&quot;</span><span class="p">][</span><span class="s">&quot;mmtopx&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;convert&quot;</span><span class="p">][</span><span class="s">&quot;calc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setUnits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">],</span><span class="bp">None</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;image_size&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;image_size&quot;</span><span class="p">][</span><span class="s">&quot;px&quot;</span><span class="p">]</span> <span class="p">,</span> <span class="mi">0</span> <span class="p">)</span>
                
        <span class="n">wl</span><span class="p">,</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_resolution_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;wavelengths&quot;</span><span class="p">][</span><span class="s">&quot;min&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;wavelengths&quot;</span><span class="p">][</span><span class="s">&quot;max&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;wavelengths&quot;</span><span class="p">][</span><span class="s">&quot;resolution&quot;</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;wavelengths&quot;</span><span class="p">][</span><span class="s">&quot;values&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;wavelengths&quot;</span><span class="p">][</span><span class="s">&quot;resolutions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
        
        <span class="n">sys</span><span class="o">.</span><span class="n">setrecursionlimit</span><span class="p">(</span><span class="mi">10000000</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="SEDSimulator.get_resolution_spectrum"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.get_resolution_spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">get_resolution_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">minwl</span><span class="p">,</span><span class="n">maxwl</span><span class="p">,</span><span class="n">resolution</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for get_resolution_spectrum&quot;&quot;&quot;</span>
        
        <span class="n">dwl</span> <span class="o">=</span> <span class="p">[</span><span class="n">minwl</span><span class="p">]</span>
        <span class="n">new_wl</span> <span class="o">=</span> <span class="n">minwl</span>
        <span class="k">while</span> <span class="n">new_wl</span> <span class="o">&lt;=</span> <span class="n">maxwl</span><span class="p">:</span>
            <span class="n">new_wl</span> <span class="o">+=</span> <span class="p">(</span><span class="n">new_wl</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">)</span>
            <span class="n">dwl</span> <span class="o">+=</span> <span class="p">[</span><span class="n">new_wl</span><span class="p">]</span>
            
        <span class="n">dense_wavelengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dwl</span><span class="p">)</span>
        <span class="n">dense_resolution</span> <span class="o">=</span> <span class="n">dense_wavelengths</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dense_wavelengths</span><span class="p">)</span>
        <span class="n">dense_wavelengths</span> <span class="o">=</span> <span class="n">dense_wavelengths</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dense_wavelengths</span><span class="p">,</span> <span class="n">dense_resolution</span>
    </div>
    <span class="k">def</span> <span class="nf">_setUnits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config</span><span class="p">,</span><span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for _setUnits&quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
                <span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setUnits</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">k</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s">&quot;mm&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="s">&quot;calc&quot;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&quot;px&quot;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="p">(</span><span class="s">&quot;calc&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">):</span>
                    <span class="n">r</span><span class="p">[</span><span class="s">&quot;px&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;convert&quot;</span><span class="p">][</span><span class="s">&quot;mmtopx&quot;</span><span class="p">]</span>
                    <span class="n">r</span><span class="p">[</span><span class="s">&quot;calc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Value for </span><span class="si">%s</span><span class="s"> set in both px and mm.&quot;</span> <span class="o">%</span> <span class="n">parent</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s">&quot;px&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="s">&quot;calc&quot;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&quot;mm&quot;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="p">(</span><span class="s">&quot;calc&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">r</span><span class="p">):</span>
                    <span class="n">r</span><span class="p">[</span><span class="s">&quot;mm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">][</span><span class="s">&quot;convert&quot;</span><span class="p">][</span><span class="s">&quot;pxtomm&quot;</span><span class="p">]</span>
                    <span class="n">r</span><span class="p">[</span><span class="s">&quot;calc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Value for </span><span class="si">%s</span><span class="s"> set in both px and mm.&quot;</span> <span class="o">%</span> <span class="n">parent</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span>
</div>
<span class="k">def</span> <span class="nf">run</span><span class="p">():</span>
    <span class="n">SIM</span> <span class="o">=</span> <span class="n">SEDSimulator</span><span class="p">()</span>
    <span class="n">SIM</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>    
    <span class="n">run</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">SEDMsim 0.3.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Alexander Rudy.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>