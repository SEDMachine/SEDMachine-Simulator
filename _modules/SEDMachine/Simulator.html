
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>SEDMachine.Simulator &mdash; SEDMsim 0.3.9-p3 documentation</title>
    
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.3.9-p3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="SEDMsim 0.3.9-p3 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">SEDMsim 0.3.9-p3 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for SEDMachine.Simulator</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c"># </span>
<span class="c">#  Simulator.py</span>
<span class="c">#  SEDM-Dev</span>
<span class="c">#  </span>
<span class="c">#  Created by Alexander Rudy on 2012-02-08.</span>
<span class="c">#  Copyright 2012 Alexander Rudy. All rights reserved.</span>
<span class="c">#  Version 0.3.9-p1</span>
<span class="c"># </span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="c"># import pyfits as pf</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="kn">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="kn">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">scipy.signal</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="kn">import</span> <span class="nn">shapely</span> <span class="kn">as</span> <span class="nn">sh</span>
<span class="kn">import</span> <span class="nn">shapely.geometry</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span><span class="o">,</span><span class="nn">logging.handlers</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">gc</span>

<span class="kn">from</span> <span class="nn">pkg_resources</span> <span class="kn">import</span> <span class="n">resource_filename</span>

<span class="kn">import</span> <span class="nn">AstroObject</span>
<span class="kn">from</span> <span class="nn">AstroObject.AstroSimulator</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">AstroObject.AstroCache</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">AstroObject.AstroConfig</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">AstroObject.AstroSpectra</span> <span class="kn">import</span> <span class="n">SpectraStack</span><span class="p">,</span><span class="n">SpectraFrame</span>
<span class="kn">from</span> <span class="nn">AstroObject.AstroImage</span> <span class="kn">import</span> <span class="n">ImageStack</span><span class="p">,</span><span class="n">ImageFrame</span>
<span class="kn">from</span> <span class="nn">AstroObject.AnalyticSpectra</span> <span class="kn">import</span> <span class="n">BlackBodySpectrum</span><span class="p">,</span><span class="n">GaussianSpectrum</span><span class="p">,</span> <span class="n">AnalyticSpectrum</span><span class="p">,</span> <span class="n">FlatSpectrum</span><span class="p">,</span> <span class="n">InterpolatedSpectrum</span><span class="p">,</span> <span class="n">UnitarySpectrum</span>
<span class="kn">from</span> <span class="nn">AstroObject.Utilities</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">AstroObject.mpl_utilities</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">version</span> <span class="kn">import</span> <span class="n">version</span> <span class="k">as</span> <span class="n">versionstr</span>
<span class="kn">from</span> <span class="nn">Objects</span> <span class="kn">import</span> <span class="o">*</span>


<div class="viewcode-block" id="SEDSimulator"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator">[docs]</a><span class="k">class</span> <span class="nc">SEDSimulator</span><span class="p">(</span><span class="n">Simulator</span><span class="p">,</span><span class="n">ImageStack</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A simulator implementation for the SED Machine.</span>
<span class="sd">    </span>
<span class="sd">    This simulator is based on :class:`AstroObject.AstroSimulator.Simulator`. It is designed to run as a series of dependent stages. The simulator is first setup, with basic data structures created in the constructor, and then simulator stages registered in :meth:`setup_stages`.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SEDSimulator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;SEDMachine&quot;</span><span class="p">,</span><span class="n">version</span><span class="o">=</span><span class="n">versionstr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataClasses</span> <span class="o">=</span> <span class="p">[</span><span class="n">SubImage</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lenslets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ellipses</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qe</span> <span class="o">=</span> <span class="n">SpectraStack</span><span class="p">(</span><span class="n">dataClasses</span><span class="o">=</span><span class="p">[</span><span class="n">AnalyticSpectrum</span><span class="p">,</span><span class="n">SpectraFrame</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qe</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">FlatSpectrum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span> <span class="o">=</span>  <span class="n">SpectraStack</span><span class="p">(</span><span class="n">dataClasses</span><span class="o">=</span><span class="p">[</span><span class="n">AnalyticSpectrum</span><span class="p">,</span><span class="n">SpectraFrame</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">FlatSpectrum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sky</span> <span class="o">=</span>  <span class="n">SpectraStack</span><span class="p">(</span><span class="n">dataClasses</span><span class="o">=</span><span class="p">[</span><span class="n">AnalyticSpectrum</span><span class="p">,</span><span class="n">SpectraFrame</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">FlatSpectrum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">astrologger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&quot;AstroObject&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">resource_filename</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span><span class="s">&quot;SED.main.config.default.yaml&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">setFile</span><span class="p">(</span><span class="s">&quot;Main&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_stages</span><span class="p">()</span>
    
<div class="viewcode-block" id="SEDSimulator.setup_stages"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_stages">[docs]</a>    <span class="k">def</span> <span class="nf">setup_stages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Registers all of the availalbe simulator stages. For basic command help on the options registered here, use::</span>
<span class="sd">            </span>
<span class="sd">            $ SEDMsim --help</span>
<span class="sd">            </span>
<span class="sd">        To get a list of all available stages, use::</span>
<span class="sd">            </span>
<span class="sd">            $ SEDMsim --stages</span>
<span class="sd">        </span>
<span class="sd">        This function is **ONLY** used to register stages and configuration options with the command-line parser. It is called by :class:`SEDSimulator` during construction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerConfigOpts</span><span class="p">(</span><span class="s">&quot;D&quot;</span><span class="p">,{</span><span class="s">&quot;Lenslets&quot;</span><span class="p">:{</span><span class="s">&quot;start&quot;</span><span class="p">:</span><span class="mi">2100</span><span class="p">,</span><span class="s">&quot;number&quot;</span><span class="p">:</span><span class="mi">50</span><span class="p">},</span><span class="s">&quot;Debug&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span><span class="s">&quot;Output&quot;</span><span class="p">:{</span><span class="s">&quot;Label&quot;</span><span class="p">:</span><span class="s">&quot;DFlag&quot;</span><span class="p">,},},</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Debug, Limit lenslets (50,start from 2100)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerConfigOpts</span><span class="p">(</span><span class="s">&quot;S&quot;</span><span class="p">,{</span><span class="s">&quot;Lenslets&quot;</span><span class="p">:{</span><span class="s">&quot;start&quot;</span><span class="p">:</span><span class="mi">2100</span><span class="p">,</span><span class="s">&quot;number&quot;</span><span class="p">:</span><span class="mi">5</span><span class="p">},</span><span class="s">&quot;Debug&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span><span class="s">&quot;Output&quot;</span><span class="p">:{</span><span class="s">&quot;Label&quot;</span><span class="p">:</span><span class="s">&quot;SFlag&quot;</span><span class="p">,},},</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Debug, Limit lenslets (5,start from 2100)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerConfigOpts</span><span class="p">(</span><span class="s">&quot;T&quot;</span><span class="p">,{</span><span class="s">&quot;Lenslets&quot;</span><span class="p">:{</span><span class="s">&quot;start&quot;</span><span class="p">:</span><span class="mi">2100</span><span class="p">,</span><span class="s">&quot;number&quot;</span><span class="p">:</span><span class="mi">50</span><span class="p">},</span><span class="s">&quot;Debug&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s">&quot;Output&quot;</span><span class="p">:{</span><span class="s">&quot;Label&quot;</span><span class="p">:</span><span class="s">&quot;TFlag&quot;</span><span class="p">,},},</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Limit lenslets (50,start from 2100)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerConfigOpts</span><span class="p">(</span><span class="s">&quot;M&quot;</span><span class="p">,{</span><span class="s">&quot;Lenslets&quot;</span><span class="p">:{</span><span class="s">&quot;start&quot;</span><span class="p">:</span><span class="mi">1000</span><span class="p">,</span><span class="s">&quot;number&quot;</span><span class="p">:</span><span class="mi">500</span><span class="p">},</span><span class="s">&quot;Debug&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span><span class="s">&quot;Output&quot;</span><span class="p">:{</span><span class="s">&quot;Label&quot;</span><span class="p">:</span><span class="s">&quot;MFlag&quot;</span><span class="p">,},},</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Limit lenslets (500,start from 1000)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerConfigOpts</span><span class="p">(</span><span class="s">&quot;N&quot;</span><span class="p">,{</span><span class="s">&quot;Lenslets&quot;</span><span class="p">:{</span><span class="s">&quot;start&quot;</span><span class="p">:</span><span class="mi">1000</span><span class="p">,</span><span class="s">&quot;number&quot;</span><span class="p">:</span><span class="mi">500</span><span class="p">},</span><span class="s">&quot;Debug&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s">&quot;Output&quot;</span><span class="p">:{</span><span class="s">&quot;Label&quot;</span><span class="p">:</span><span class="s">&quot;NFlag&quot;</span><span class="p">,},},</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Limit lenslets (500,start from 1000)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerConfigOpts</span><span class="p">(</span><span class="s">&quot;A&quot;</span><span class="p">,{</span><span class="s">&quot;Lenslets&quot;</span><span class="p">:{</span><span class="s">&quot;start&quot;</span><span class="p">:</span><span class="mi">2100</span><span class="p">,</span><span class="s">&quot;number&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span><span class="s">&quot;Debug&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span><span class="s">&quot;Output&quot;</span><span class="p">:{</span><span class="s">&quot;Label&quot;</span><span class="p">:</span><span class="s">&quot;AFlag&quot;</span><span class="p">,},},</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Debug, Single lenslets (start from 2100)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerConfigOpts</span><span class="p">(</span><span class="s">&quot;C&quot;</span><span class="p">,{</span><span class="s">&quot;Lenslets&quot;</span><span class="p">:{</span><span class="s">&quot;position&quot;</span><span class="p">:{</span><span class="s">&quot;x&quot;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span><span class="s">&quot;y&quot;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">},</span><span class="s">&quot;radius&quot;</span><span class="p">:</span><span class="mf">0.01</span><span class="p">},</span><span class="s">&quot;Debug&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span><span class="s">&quot;Output&quot;</span><span class="p">:{</span><span class="s">&quot;Label&quot;</span><span class="p">:</span><span class="s">&quot;CFlag&quot;</span><span class="p">,},},</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Debug, Central Lenslets&quot;</span><span class="p">)</span>
        
        <span class="c"># SETUP Stages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_caches</span><span class="p">,</span><span class="s">&quot;setup-caches&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_configuration</span><span class="p">,</span><span class="s">&quot;setup-config&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_constants</span><span class="p">,</span><span class="s">&quot;setup-constants&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_cameras</span><span class="p">,</span><span class="s">&quot;setup-cameras&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_lenslets</span><span class="p">,</span><span class="s">&quot;setup-lenslets&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_hexagons</span><span class="p">,</span><span class="s">&quot;setup-hexagons&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_blank</span><span class="p">,</span><span class="s">&quot;setup-blank&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_dummy_blank</span><span class="p">,</span><span class="s">&quot;setup-blank-d&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_simple_source</span><span class="p">,</span><span class="s">&quot;setup-source-simple&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="s">&quot;simple-source&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Use a simple, centered source object&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Replacing default source with a simple one&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-source-simple&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="s">&quot;setup-source&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Creating source spectrum objects&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-config&quot;</span><span class="p">,</span><span class="s">&quot;setup-constants&quot;</span><span class="p">,</span><span class="s">&quot;simple-source&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_source_pixels</span><span class="p">,</span><span class="s">&quot;setup-source-pixels&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_noise</span><span class="p">,</span><span class="s">&quot;setup-noise&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_sky</span><span class="p">,</span><span class="s">&quot;setup-sky&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_line_list</span><span class="p">,</span><span class="s">&quot;setup-lines&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_scatter</span><span class="p">,</span><span class="s">&quot;setup-scatter&quot;</span><span class="p">)</span>
        <span class="c"># Setup Macro</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="s">&quot;setup&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;System Setup&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Set up simulator&quot;</span><span class="p">,</span>
            <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;setup-hexagons&quot;</span><span class="p">,</span><span class="s">&quot;setup-blank&quot;</span><span class="p">,</span><span class="s">&quot;setup-source&quot;</span><span class="p">,</span><span class="s">&quot;setup-noise&quot;</span><span class="p">,</span><span class="s">&quot;setup-constants&quot;</span><span class="p">,</span><span class="s">&quot;setup-sky&quot;</span><span class="p">,</span><span class="s">&quot;setup-cameras&quot;</span><span class="p">,</span><span class="s">&quot;setup-lines&quot;</span><span class="p">,</span><span class="s">&quot;setup-scatter&quot;</span><span class="p">],</span>
            <span class="p">)</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometric_resample</span><span class="p">,</span><span class="s">&quot;geometric-resample&quot;</span><span class="p">)</span>
        
        <span class="c"># Apply spectral properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_sky</span><span class="p">,</span><span class="s">&quot;apply-sky&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_qe</span><span class="p">,</span><span class="s">&quot;apply-qe&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_atmosphere</span><span class="p">,</span><span class="s">&quot;apply-atmosphere&quot;</span><span class="p">)</span>

        <span class="c"># Adjust spectra</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sky_source</span><span class="p">,</span><span class="s">&quot;sky-source&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flat_source</span><span class="p">,</span><span class="s">&quot;flat-source&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_source</span><span class="p">,</span><span class="s">&quot;line-source&quot;</span><span class="p">)</span>
        
        
        <span class="c"># Dispersion functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lenslet_dispersion</span><span class="p">,</span><span class="s">&quot;dispersion&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lenslet_trace</span><span class="p">,</span><span class="s">&quot;trace&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lenslet_place</span><span class="p">,</span><span class="s">&quot;place&quot;</span><span class="p">)</span>
        
        <span class="c"># Merge images back together</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_merge</span><span class="p">,</span><span class="s">&quot;merge-cached&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="s">&quot;merge&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Merge Subimages&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Merging subimage into master image&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;place&quot;</span><span class="p">,</span><span class="s">&quot;merge-cached&quot;</span><span class="p">])</span>
        
        <span class="c"># Final Image work</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ccd_crop</span><span class="p">,</span><span class="s">&quot;crop&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_scatter</span><span class="p">,</span><span class="s">&quot;add-scatter&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_noise</span><span class="p">,</span><span class="s">&quot;add-noise&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transpose</span><span class="p">,</span><span class="s">&quot;transpose&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_file</span><span class="p">,</span><span class="s">&quot;save&quot;</span><span class="p">)</span>
        
        <span class="c"># Alternative work macros</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="s">&quot;cached-only&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Use cached subimages to construct final image&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Building image from caches&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;merge-cached&quot;</span><span class="p">,</span><span class="s">&quot;crop&quot;</span><span class="p">,</span><span class="s">&quot;add-noise&quot;</span><span class="p">,</span><span class="s">&quot;add-scatter&quot;</span><span class="p">,</span><span class="s">&quot;transpose&quot;</span><span class="p">,</span><span class="s">&quot;save&quot;</span><span class="p">])</span>
        
        
        <span class="c"># Plotting geometry functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_kernel_partials</span><span class="p">,</span><span class="s">&quot;plot-kernel&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_hexagons</span><span class="p">,</span><span class="s">&quot;plot-hexagons&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_invalid_hexagons</span><span class="p">,</span><span class="s">&quot;plot-bad-hexagons&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_pixels</span><span class="p">,</span><span class="s">&quot;plot-pixels&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_invalid_pixels</span><span class="p">,</span><span class="s">&quot;plot-bad-pixels&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_geometry</span><span class="p">,</span><span class="s">&quot;plot-p-geometry&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_resample</span><span class="p">,</span><span class="s">&quot;write-resample&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_resample</span><span class="p">,</span><span class="s">&quot;plot-resample&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="s">&quot;plot-geometry&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Do all geometry plots&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Plotting geometries&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;plot-hexagons&quot;</span><span class="p">,</span><span class="s">&quot;plot-invalid-hexagons&quot;</span><span class="p">,</span><span class="s">&quot;plot-pixels&quot;</span><span class="p">,</span><span class="s">&quot;plot-bad-pixels&quot;</span><span class="p">,</span><span class="s">&quot;plot-p-geometry&quot;</span><span class="p">,</span><span class="s">&quot;plot-resample&quot;</span><span class="p">])</span>
        
        <span class="c"># Spectrum Plotting Functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compare_methods</span><span class="p">,</span><span class="s">&quot;plot-spectrum-tests&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_original_calibration</span><span class="p">,</span><span class="s">&quot;plot-cal-o&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_original_source</span><span class="p">,</span><span class="s">&quot;plot-source-o&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_source</span><span class="p">,</span><span class="s">&quot;plot-source&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_sky_original</span><span class="p">,</span><span class="s">&quot;plot-sky-o&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_sky</span><span class="p">,</span><span class="s">&quot;plot-sky&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_qe</span><span class="p">,</span><span class="s">&quot;plot-qe&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="s">&quot;plot-spectra&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;plot-qe&quot;</span><span class="p">,</span><span class="s">&quot;plot-sky&quot;</span><span class="p">,</span><span class="s">&quot;plot-source&quot;</span><span class="p">,</span><span class="s">&quot;plot-cal-o&quot;</span><span class="p">])</span>
        
        
        <span class="c"># Dispersion plotting functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_ellipses</span><span class="p">,</span><span class="s">&quot;plot-lenslet-es&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_rotation</span><span class="p">,</span><span class="s">&quot;plot-lenslet-rs&quot;</span><span class="p">)</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_lenslet_data</span><span class="p">,</span><span class="s">&quot;plot-lenslet-xy&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_dispersion_data</span><span class="p">,</span><span class="s">&quot;plot-dispersion&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_trace_data</span><span class="p">,</span><span class="s">&quot;plot-trace&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_spectrum_data</span><span class="p">,</span><span class="s">&quot;plot-spectrum&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="s">&quot;plot-lenslets&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Plotting data about each lenslet&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;plot-dispersion&quot;</span><span class="p">,</span><span class="s">&quot;plot-trace&quot;</span><span class="p">,</span><span class="s">&quot;plot-spectrum&quot;</span><span class="p">])</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">registerStage</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="s">&quot;plot&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;Create all plots&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Plotting everything&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;plot-lenslet-xy&quot;</span><span class="p">,</span><span class="s">&quot;plot-lenslets&quot;</span><span class="p">,</span><span class="s">&quot;plot-sky&quot;</span><span class="p">,</span><span class="s">&quot;plot-qe&quot;</span><span class="p">,</span><span class="s">&quot;plot-source&quot;</span><span class="p">,</span><span class="s">&quot;plot-p-geometry&quot;</span><span class="p">,</span><span class="s">&quot;plot-hexagons&quot;</span><span class="p">,</span><span class="s">&quot;plot-pixels&quot;</span><span class="p">,</span><span class="s">&quot;plot-spectrum-tests&quot;</span><span class="p">,</span><span class="s">&quot;plot-kernel&quot;</span><span class="p">])</span>
        
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Setting up Caches&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.setup_caches"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_caches">[docs]</a>    <span class="k">def</span> <span class="nf">setup_caches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Establish Cache objects for image kernels. The Caching algorithm doesn&#39;t quite work properly yet, so this method is really superfluous.</span>
<span class="sd">        </span>
<span class="sd">        **Command Name:** ``*setup-caches``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Caches&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Caches&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs.Caches&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Caches&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="p">[</span><span class="s">&quot;TEL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NumpyCache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_tel_kern</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Caches.Telescope&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="p">[</span><span class="s">&quot;PSF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NumpyCache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_psf_kern</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Caches.PSF&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="p">[</span><span class="s">&quot;CONV&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NumpyCache</span><span class="p">(</span><span class="k">lambda</span> <span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="p">[</span><span class="s">&quot;PSF&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="p">[</span><span class="s">&quot;TEL&quot;</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;same&#39;</span><span class="p">),</span><span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Caches.CONV&quot;</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="s">&quot;clear_cache&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Options&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Options&quot;</span><span class="p">][</span><span class="s">&quot;clear_cache&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="o">.</span><span class="n">flag</span><span class="p">(</span><span class="s">&#39;enabled&#39;</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&quot;cache&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Options&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Options&quot;</span><span class="p">][</span><span class="s">&quot;cache&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="o">.</span><span class="n">flag</span><span class="p">(</span><span class="s">&#39;saving&#39;</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
    
    
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Setting up operational constants&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-caches&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.setup_constants"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_constants">[docs]</a>    <span class="k">def</span> <span class="nf">setup_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate the physical constants required for simple calculations.</span>
<span class="sd">        </span>
<span class="sd">        **Command Name:** ``*setup-constants``</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        **Constants Generated**</span>
<span class="sd">        </span>
<span class="sd">        :var hc: Plank&#39;s constant times the speed of light. For the conversion between energy and photons.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">const</span> <span class="o">=</span> <span class="n">StructuredConfiguration</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">setFile</span><span class="p">(</span><span class="s">&quot;const&quot;</span><span class="p">,</span><span class="s">&quot;SED.const.config.yaml&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s">&quot;hc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.98644521e-8</span> <span class="c"># erg angstrom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="p">[</span><span class="s">&quot;CONST&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ConfigCache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Caches.const&quot;</span><span class="p">])</span>
        
    
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Setting up lenslets&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-config&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.setup_lenslets"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_lenslets">[docs]</a>    <span class="k">def</span> <span class="nf">setup_lenslets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="sd">&quot;&quot;&quot;This function loads data about lenslet positions, and thier dispersion through the prism. The data are original produced by ZEMAX. This function reads the Zeemax data directly and then cleans the data in certain ways, preparing it for use later in the system.</span>
<span class="sd">       </span>
<span class="sd">       **Command Name:** ``*setup-lenslets``</span>
<span class="sd">       </span>
<span class="sd">       Cleaning actions taken:</span>
<span class="sd">       </span>
<span class="sd">       - Indexes (ix) become integers</span>
<span class="sd">       - Wavelenghts are converted to SI units (m) instead of microns</span>
<span class="sd">       - Center of the lenslet array is calculated</span>
<span class="sd">       - Lenslets are validated. See :meth:`SEDMachine.Lenslet.Lenslet.valid`.</span>
<span class="sd">        </span>
<span class="sd">       **Data expected from ZEMAX**:</span>
<span class="sd">       </span>
<span class="sd">       The data are given as a list of spots. Each lenslet will have many spots. The variables below are listed in order.</span>
<span class="sd">       </span>
<span class="sd">       :var ix: index of the lenslet</span>
<span class="sd">       :var xps: Pupil position in the x-direction in mm</span>
<span class="sd">       :var yps: Pupil position in the y-direction in mm</span>
<span class="sd">       :var lams: Wavelength of this spot in microns</span>
<span class="sd">       :var xcs: Camera image position of the spot in the x direction in mm.</span>
<span class="sd">       :var ycs: Camera image position of the spot in the y direction in mm.</span>
<span class="sd">       :var xls: Camera image position of the next R=100 resolution element in the x direction in mm.</span>
<span class="sd">       :var yls: Camera image position of the next R=100 resolution element in the y direction in mm.</span>
<span class="sd">       :var xas: Camera image position of the major axis extent of the telescope image in the x direction in mm.</span>
<span class="sd">       :var yas: Camera image position of the major axis extent of the telescope image in the y direction in mm.</span>
<span class="sd">       :var xbs: Camera image position of the minor axis extent of the telescope image in the x direction in mm.</span>
<span class="sd">       :var ybs: Camera image position of the minor axis extent of the telescope image in the y direction in mm.</span>
<span class="sd">       :var rs: Instantaneous resolution of this position.</span>
<span class="sd">       </span>
<span class="sd">      </span>
<span class="sd">       &quot;&quot;&quot;</span>
       <span class="c"># Load Lenslet Specification File</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Opening filename </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.files.lenslets&quot;</span><span class="p">])</span>
       <span class="n">ix</span><span class="p">,</span> <span class="n">xps</span><span class="p">,</span> <span class="n">yps</span><span class="p">,</span> <span class="n">lams</span><span class="p">,</span> <span class="n">xcs</span><span class="p">,</span> <span class="n">ycs</span><span class="p">,</span> <span class="n">xls</span><span class="p">,</span> <span class="n">yls</span><span class="p">,</span> <span class="n">xas</span><span class="p">,</span> <span class="n">yas</span><span class="p">,</span> <span class="n">xbs</span><span class="p">,</span> <span class="n">ybs</span><span class="p">,</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_filename</span><span class="p">(</span><span class="s">&quot;Data&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.files.lenslets&quot;</span><span class="p">]),</span><span class="n">skip_header</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">comments</span><span class="o">=</span><span class="s">&quot;#&quot;</span><span class="p">,</span><span class="n">unpack</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
       <span class="c"># This data describes the following:</span>
       <span class="c"># ix - Index (number)</span>
       <span class="c"># xps - Pupil position in the x-direction</span>
       <span class="c"># yps - Pupil position in the y-direction</span>
       <span class="c"># lams - wavelengths for this position</span>
       <span class="c"># xs - X position (in mm, offest from top right corner) of this wavelength</span>
       <span class="c"># ys - Y Position (in mm, offset from top right corner) of this wavelength</span>
        
       <span class="c"># Correctly Type Lenslet Specification Data</span>
       <span class="n">ix</span> <span class="o">=</span> <span class="n">ix</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span> <span class="c">#Indicies should always be integers</span>
        
       <span class="n">lams</span> <span class="o">*=</span> <span class="mf">1e-6</span> <span class="c"># Convert wavelength to SI units (m)</span>
        
       <span class="c"># This simply generates a list of all of the lenslets</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">lensletIndex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span>
        
       <span class="c"># Determine the center of the whole system by finding the x position that is closest to 0,0 in pupil position</span>
       <span class="n">cntix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">xps</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">yps</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="p">((</span><span class="n">xcs</span><span class="p">[</span><span class="n">cntix</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.image.size.mm&quot;</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.convert.mmtopx&quot;</span><span class="p">],</span> <span class="p">(</span><span class="n">ycs</span><span class="p">[</span><span class="n">cntix</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.image.size.mm&quot;</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.convert.mmtopx&quot;</span><span class="p">])</span>
       
        
       <span class="c"># Progress bar for lenslet creation and validation</span>
      
       <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lensletIndex</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">_start_progress_bar</span><span class="p">(</span><span class="n">total</span><span class="p">,</span><span class="s">&quot;green&quot;</span><span class="p">)</span>
        
       <span class="c"># Variables for lenslet use</span>
       <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/</span><span class="si">%(name)s%(ext)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Lenslets-raw&quot;</span><span class="p">,</span><span class="n">ext</span><span class="o">=</span><span class="s">&quot;.dat&quot;</span><span class="p">,</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
       <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">FileName</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
           <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lensletIndex</span><span class="p">:</span>
               <span class="n">select</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">ix</span>
               <span class="n">lenslet</span> <span class="o">=</span> <span class="n">Lenslet</span><span class="p">(</span><span class="n">xps</span><span class="p">[</span><span class="n">select</span><span class="p">],</span><span class="n">yps</span><span class="p">[</span><span class="n">select</span><span class="p">],</span><span class="n">lams</span><span class="p">[</span><span class="n">select</span><span class="p">],</span><span class="n">idx</span><span class="p">,</span><span class="n">xcs</span><span class="p">[</span><span class="n">select</span><span class="p">],</span> <span class="n">ycs</span><span class="p">[</span><span class="n">select</span><span class="p">],</span><span class="n">xls</span><span class="p">[</span><span class="n">select</span><span class="p">],</span> <span class="n">yls</span><span class="p">[</span><span class="n">select</span><span class="p">],</span>  <span class="n">xas</span><span class="p">[</span><span class="n">select</span><span class="p">],</span> <span class="n">yas</span><span class="p">[</span><span class="n">select</span><span class="p">],</span> <span class="n">xbs</span><span class="p">[</span><span class="n">select</span><span class="p">],</span> <span class="n">ybs</span><span class="p">[</span><span class="n">select</span><span class="p">],</span> <span class="n">rs</span><span class="p">[</span><span class="n">select</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="p">)</span>
               <span class="k">if</span> <span class="n">lenslet</span><span class="o">.</span><span class="n">valid</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.Lenslets.strict&quot;</span><span class="p">]):</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">lenslets</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">lenslet</span>
                   <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">lenslet</span><span class="o">.</span><span class="n">introspect</span><span class="p">())</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">+=</span> <span class="mi">1</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">progressbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">lensletIndex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lenslets</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">_end_progress_bar</span><span class="p">()</span>
       
       
       <span class="c"># Central Lenslet Output</span>
       <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/</span><span class="si">%(name)s%(ext)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;center-raw&quot;</span><span class="p">,</span><span class="n">ext</span><span class="o">=</span><span class="s">&quot;.dat&quot;</span><span class="p">,</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
       <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">FileName</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
           <span class="n">lenslet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lenslets</span><span class="p">[</span><span class="n">ix</span><span class="p">[</span><span class="n">cntix</span><span class="p">]]</span>
           <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">lenslet</span><span class="o">.</span><span class="n">introspect</span><span class="p">())</span>
       
       
       <span class="k">if</span> <span class="s">&quot;start&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Lenslets&quot;</span><span class="p">]:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">lensletIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lensletIndex</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Lenslets.start&quot;</span><span class="p">]:]</span>
       <span class="k">if</span> <span class="s">&quot;number&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Lenslets&quot;</span><span class="p">]:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">lensletIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lensletIndex</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Lenslets.number&quot;</span><span class="p">]]</span>
       <span class="k">if</span> <span class="s">&quot;radius&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Lenslets&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="s">&quot;position&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Lenslets&quot;</span><span class="p">]:</span>
           <span class="n">xp</span><span class="p">,</span><span class="n">yp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Lenslets.position.x&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Lenslets.position.y&quot;</span><span class="p">]</span>
           <span class="n">xps</span><span class="p">,</span><span class="n">yps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">l</span><span class="o">.</span><span class="n">ps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lenslets</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span><span class="o">.</span><span class="n">T</span>
           <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xps</span><span class="o">-</span><span class="n">xp</span><span class="p">)</span><span class="o">**</span><span class="mf">2.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">yps</span><span class="o">-</span><span class="n">yp</span><span class="p">)</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span>
           <span class="n">include</span> <span class="o">=</span> <span class="n">distances</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Lenslets.radius&quot;</span><span class="p">]</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">lensletIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lensletIndex</span><span class="p">[</span><span class="n">include</span><span class="p">]</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lensletIndex</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">lenslets</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">lenslets</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lensletIndex</span><span class="p">}</span>
       <span class="k">for</span> <span class="n">ix</span><span class="p">,</span><span class="n">lx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lenslets</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
           <span class="n">lx</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">ix</span>
    
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Creating blank frame&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-config&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.setup_blank"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_blank">[docs]</a>    <span class="k">def</span> <span class="nf">setup_blank</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Establish a blank image of zeros in every position. The image is established as ``np.int32`` values.</span>
<span class="sd">        </span>
<span class="sd">        **Command Name:** ``*setup-blank``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="p">[</span><span class="s">&quot;Blank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.image.size.px&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.image.size.px&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Creating blank frame with a single one&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-config&quot;</span><span class="p">)</span>
    <span class="nd">@replaces</span><span class="p">(</span><span class="s">&quot;setup-blank&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.setup_dummy_blank"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_dummy_blank">[docs]</a>    <span class="k">def</span> <span class="nf">setup_dummy_blank</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup a dummy blank image with a single value of 1.0 in the center of the image. This is useful for a sanity-check of the scattered light calculation.</span>
<span class="sd">        </span>
<span class="sd">        **Command Name:** ``*setup-blank-d``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">blank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.image.size.px&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.image.size.px&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.image.size.px&quot;</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">blank</span><span class="p">[</span><span class="n">center</span><span class="p">,</span><span class="n">center</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="p">[</span><span class="s">&quot;Blank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">blank</span>
        </div>
<div class="viewcode-block" id="SEDSimulator.setup_source"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_source">[docs]</a>    <span class="k">def</span> <span class="nf">setup_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set up a source for use with this system.</span>
<span class="sd">        </span>
<span class="sd">        **Command Name:** ``*setup-source``</span>
<span class="sd">        </span>
<span class="sd">        .. Warning::</span>
<span class="sd">            This method is not ready for use yet. It requires some concept of the wavelength data for a data-cube. Extracting the wavelength calibration may be non-trivial.&quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Stage &#39;setup-source&#39; not ready yet, doing nothing!&quot;</span><span class="p">)</span>
        <span class="k">return</span>
        
        <span class="n">Source</span> <span class="o">=</span> <span class="n">ImageStack</span><span class="p">()</span>
        <span class="n">Source</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_filename</span><span class="p">(</span><span class="s">&quot;Data&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Source.CubeName&quot;</span><span class="p">]))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">Source</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="c"># Progress bar for lenslet creation and validation</span>
        <span class="n">PBar</span> <span class="o">=</span> <span class="n">arpytools</span><span class="o">.</span><span class="n">progressbar</span><span class="o">.</span><span class="n">ProgressBar</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;green&quot;</span><span class="p">)</span>
        <span class="n">finished</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">useConsole</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">PBar</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;L:</span><span class="si">%4s</span><span class="s">,</span><span class="si">%4s</span><span class="s"> </span><span class="si">%6d</span><span class="s">/</span><span class="si">%-6d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">finished</span><span class="p">,</span><span class="n">total</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">SourcePixels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">progress</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">finished</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">total</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
                <span class="n">finished</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SourcePixels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SourcePixel</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Source Pixel </span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">),</span><span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="n">finished</span><span class="p">))</span>
                <span class="n">PBar</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">progress</span><span class="p">,</span><span class="s">&quot;L:</span><span class="si">%4d</span><span class="s">,</span><span class="si">%4d</span><span class="s"> </span><span class="si">%6d</span><span class="s">/</span><span class="si">%-6d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">finished</span><span class="p">,</span><span class="n">total</span><span class="p">))</span>
        
        <span class="n">PBar</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;L:</span><span class="si">%4s</span><span class="s">,</span><span class="si">%4s</span><span class="s"> </span><span class="si">%6d</span><span class="s">/</span><span class="si">%-6d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;Done&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">finished</span><span class="p">,</span><span class="n">total</span><span class="p">))</span>
        
    
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Creating a simple source object&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-config&quot;</span><span class="p">,</span><span class="s">&quot;setup-constants&quot;</span><span class="p">)</span>
    <span class="nd">@replaces</span><span class="p">(</span><span class="s">&quot;setup-source&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.setup_simple_source"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_simple_source">[docs]</a>    <span class="k">def</span> <span class="nf">setup_simple_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a simple-source object. The simple source is placed in three fixed positions on the image plane. Each source is a uniform distribution of the provided spectrum.</span>
<span class="sd">        </span>
<span class="sd">        **Command Name:** ``*simple-source``        </span>
<span class="sd">        </span>
<span class="sd">        The spectrum is set up using the source configuration values::</span>
<span class="sd">            </span>
<span class="sd">            Source:</span>
<span class="sd">              Filename: Data/SNIa.R1000.dat</span>
<span class="sd">        </span>
<span class="sd">        There is no amplification applied to the source. Sources are expected to be in cgs units during input.</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_filename</span><span class="p">(</span><span class="s">&quot;Data&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Source.Filename&quot;</span><span class="p">]),</span><span class="n">unpack</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">comments</span><span class="o">=</span><span class="s">&quot;#&quot;</span><span class="p">)</span>
        <span class="n">FL</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s">&quot;hc&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">WL</span>
        <span class="n">FL</span> <span class="o">*=</span> <span class="mf">1e10</span> <span class="c">#Spectrum was per Angstrom, should now be per Meter</span>
        <span class="n">WL</span> <span class="o">*=</span> <span class="mf">1e-10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">InterpolatedSpectrum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span><span class="n">FL</span><span class="p">]),</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Source.Filename&quot;</span><span class="p">],</span><span class="n">method</span><span class="o">=</span><span class="s">&quot;resolve_and_integrate&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">InterpolatedSpectrum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span><span class="n">FL</span><span class="p">]),</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Source.Filename&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&quot; (O)&quot;</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&quot;resolve_and_integrate&quot;</span><span class="p">),</span><span class="n">select</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">SpectraFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span><span class="n">FL</span><span class="p">]),</span><span class="s">&quot;Original&quot;</span><span class="p">),</span><span class="n">select</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SourcePixels</span> <span class="o">=</span> <span class="p">[</span><span class="n">SourcePixel</span><span class="p">(</span><span class="o">-</span><span class="mf">0.13</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span><span class="n">FL</span><span class="p">]),</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Source Pixel&quot;</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">SourcePixel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span><span class="n">FL</span><span class="p">]),</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Source Pixel&quot;</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span><span class="n">SourcePixel</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span><span class="n">FL</span><span class="p">]),</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Source Pixel&quot;</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">3</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span><span class="n">px</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SourcePixels</span><span class="p">):</span>
            <span class="n">px</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">ix</span>
    
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Setting up Cameras&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-config&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.setup_cameras"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_cameras">[docs]</a>    <span class="k">def</span> <span class="nf">setup_cameras</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set up camera configuration values. Camera configuratiosn can be slightly dynamic, so some values are copied from others.</span>
<span class="sd">        </span>
<span class="sd">        .. Note:: </span>
<span class="sd">            Camera configurations do not contain QE values (unlike the SEDSpec simulators).</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.Cameras.PI-fast&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.Cameras.PI&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.Cameras.PI-fast.RN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.Cameras.PI-fast.readtime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.265</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.Cameras.Andor-fast&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.Cameras.Andor&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.Cameras.Andor-fast.RN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">11.7</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.Cameras.Andor-fast.readtime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.398</span>
        
    
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Setting up Sky Sources&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-config&quot;</span><span class="p">,</span><span class="s">&quot;setup-constants&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.setup_sky"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_sky">[docs]</a>    <span class="k">def</span> <span class="nf">setup_sky</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup sky spectrum from a file. Sky spectrum setup also includes moon spectrum, atmospheric extinction setup and quantum efficiency setup for cameras.</span>
<span class="sd">        </span>
<span class="sd">        **Command Name:** ``*setup-sky``</span>
<span class="sd">        </span>
<span class="sd">        Configuration for this stage is included in both the ``Instrument`` values and ``Observation``::</span>
<span class="sd">            </span>
<span class="sd">            Observation:</span>
<span class="sd">              Background:</span>
<span class="sd">                Atmosphere: Atmosph</span>
<span class="sd">                Files:</span>
<span class="sd">                  Atmosph:</span>
<span class="sd">                    Amplifier: 1</span>
<span class="sd">                    Filename: Data/atmosphere.fits</span>
<span class="sd">                  PalSky:</span>
<span class="sd">                    Amplifier: 1</span>
<span class="sd">                    Filename: Data/PalSky.fits</span>
<span class="sd">                Sky: PalSky</span>
<span class="sd">              Moon:</span>
<span class="sd">                Phase: 0.45</span>
<span class="sd">              airmass: 1</span>
<span class="sd">            Instrument:</span>
<span class="sd">              Thpt:</span>
<span class="sd">                File: Data/thpt.npy</span>
<span class="sd">                Type: prism_pi</span>
<span class="sd">            </span>
<span class="sd">            </span>
<span class="sd">        These configuration values allow for multiple possibilities for sky and atmosphere spectra. See the default configuration values found with::</span>
<span class="sd">            </span>
<span class="sd">            $ SEDMsim --dump *none</span>
<span class="sd">            </span>
<span class="sd">        for more information.</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        
        <span class="c"># Sky Data (From sim_pdr.py by Nick, regenerated using SEDTools module&#39;s make_files.py script)</span>
        <span class="c"># Each sky spectrum is saved in a FITS file for easy recall as a spectrum object.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SKYData</span> <span class="o">=</span> <span class="n">SpectraStack</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Observation.Background.Files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SKYData</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_filename</span><span class="p">(</span><span class="s">&quot;Data&quot;</span><span class="p">,</span><span class="n">d</span><span class="p">[</span><span class="s">&quot;Filename&quot;</span><span class="p">]),</span><span class="n">framename</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                
        
        <span class="c"># Moon phase adjustments. These moon phase attenuation values are for different filter bands.</span>
        <span class="c"># The intermediate wavelengths are accounted for using a polyfit</span>
        <span class="c"># the result is a function which takes phase and wavelength, and outputs an attenuation...</span>
        
        <span class="c"># See derivation on pg 83 of SED NB 1 (20 July 2011)</span>
        <span class="n">moon_phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.24</span><span class="p">,</span> <span class="mf">0.32</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">])</span>
        <span class="n">moon_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2e-17</span><span class="p">,</span> <span class="mf">2.1e-17</span><span class="p">,</span> <span class="mf">2.15e-17</span><span class="p">,</span> <span class="mf">2.3e-17</span><span class="p">,</span> <span class="mf">5.3e-17</span><span class="p">,</span> <span class="mf">1.7e-16</span><span class="p">,</span> <span class="mf">3.2e-16</span><span class="p">])</span>
        <span class="n">moon_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.3e-17</span><span class="p">,</span><span class="mf">2.3e-17</span><span class="p">,</span><span class="mf">2.3e-17</span><span class="p">,</span><span class="mf">3.3e-17</span><span class="p">,</span><span class="mf">3.5e-17</span><span class="p">,</span><span class="mf">8.3e-17</span><span class="p">,</span><span class="mf">1.3e-16</span><span class="p">])</span>
        <span class="n">moon_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.8e-17</span><span class="p">,</span><span class="mf">3.0e-17</span><span class="p">,</span><span class="mf">3.0e-17</span><span class="p">,</span><span class="mf">3.3e-17</span><span class="p">,</span><span class="mf">3.8e-17</span><span class="p">,</span><span class="mf">7.0e-17</span><span class="p">,</span><span class="mf">9.0e-17</span><span class="p">])</span>
        
        <span class="n">sky_ls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">4868.</span><span class="p">,</span> <span class="mf">6290.</span><span class="p">,</span> <span class="mf">7706.</span><span class="p">,</span> <span class="mi">10000</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e-10</span>
        
        <span class="n">gm</span> <span class="o">=</span> <span class="n">moon_g</span> <span class="o">-</span> <span class="n">moon_g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rm</span> <span class="o">=</span> <span class="n">moon_r</span> <span class="o">-</span> <span class="n">moon_r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">moon_i</span> <span class="o">-</span> <span class="n">moon_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">zm</span> <span class="o">=</span> <span class="n">im</span>
        
        <span class="n">fluxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">gm</span><span class="p">,</span> <span class="n">rm</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">zm</span><span class="p">])</span>
        
        <span class="n">moon_specs</span> <span class="o">=</span> <span class="p">[</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">moon_phase</span><span class="p">,</span><span class="n">fl</span><span class="p">)</span> <span class="k">for</span> <span class="n">fl</span> <span class="ow">in</span> <span class="n">fluxes</span><span class="p">]</span>            
        <span class="n">mfl</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">moon_specs</span><span class="p">)):</span>
            <span class="n">mfl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">moon_specs</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Observation.Moon.Phase&quot;</span><span class="p">]))</span>
            <span class="n">mls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sky_ls</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            
        
        
        <span class="c"># Throughputs are generated from Nick&#39;s simulation scripts in throughput.py</span>
        <span class="c"># They are simply re-read here.</span>
        <span class="n">thpts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_filename</span><span class="p">(</span><span class="s">&quot;Data&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.Thpt.File&quot;</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">WL</span> <span class="o">=</span> <span class="n">thpts</span><span class="p">[</span><span class="s">&quot;lambda&quot;</span><span class="p">]</span><span class="o">*</span> <span class="mf">1e-10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qe</span><span class="p">[</span><span class="s">&quot;prism_pi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">InterpolatedSpectrum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span> <span class="n">thpts</span><span class="p">[</span><span class="s">&quot;thpt-prism-PI&quot;</span><span class="p">]]),</span><span class="s">&quot;PI Prism&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qe</span><span class="p">[</span><span class="s">&quot;prism_andor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">InterpolatedSpectrum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span> <span class="n">thpts</span><span class="p">[</span><span class="s">&quot;thpt-prism-Andor&quot;</span><span class="p">]]),</span><span class="s">&quot;Andor Prism&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qe</span><span class="p">[</span><span class="s">&quot;grating&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">InterpolatedSpectrum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span> <span class="n">thpts</span><span class="p">[</span><span class="s">&quot;thpt-grating&quot;</span><span class="p">]]),</span><span class="s">&quot;Grating&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qe</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.Thpt.Type&quot;</span><span class="p">])</span>
        
        <span class="c"># Set up extinction and airmass term.</span>
        <span class="n">WL</span><span class="p">,</span><span class="n">EX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SKYData</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Observation.Background.Atmosphere&quot;</span><span class="p">])</span>
        <span class="n">FL</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">EX</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Observation.airmass&quot;</span><span class="p">]</span><span class="o">/</span><span class="mf">2.5</span><span class="p">)</span>
        <span class="n">WL</span> <span class="o">*=</span> <span class="mf">1e-10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">InterpolatedSpectrum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span><span class="n">FL</span><span class="p">]),</span><span class="s">&quot;Atmosphere&quot;</span><span class="p">),</span><span class="n">select</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        
        
        <span class="c"># This calculation fixes the units of the TurnroseSKY values</span>
        <span class="c"># I&#39;m not sure what these units are doing, but we will leave them here for now.</span>
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SKYData</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Observation.Background.Sky&quot;</span><span class="p">])</span>
        <span class="n">FL</span> <span class="o">*=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Observation.Background.Files&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Observation.Background.Sky&quot;</span><span class="p">]][</span><span class="s">&quot;Amplifier&quot;</span><span class="p">]</span>
        <span class="n">FL</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s">&quot;hc&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">WL</span>
        <span class="n">FL</span> <span class="o">*=</span> <span class="mf">1e10</span> <span class="c">#Spectrum was per Angstrom, should now be per Meter</span>
        
        
        <span class="n">M_FL</span> <span class="o">=</span> <span class="n">InterpolatedSpectrum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mls</span><span class="p">,</span><span class="n">mfl</span><span class="p">]),</span><span class="s">&quot;Moon Phase </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&#39;polyfit&#39;</span><span class="p">)(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e-10</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">M_FL</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s">&quot;hc&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">WL</span>
        <span class="n">M_FL</span> <span class="o">*=</span> <span class="mf">1e10</span>
        
        <span class="n">WL</span> <span class="o">*=</span> <span class="mf">1e-10</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">InterpolatedSpectrum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span><span class="n">M_FL</span><span class="p">]),</span><span class="s">&quot;Moon&quot;</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&#39;resolve_and_integrate&#39;</span><span class="p">),</span><span class="n">select</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">InterpolatedSpectrum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span><span class="n">FL</span><span class="p">]),</span><span class="s">&quot;SkySpectrum (O)&quot;</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&quot;resolve_and_integrate&quot;</span><span class="p">),</span><span class="n">select</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">FL</span> <span class="o">+=</span> <span class="n">M_FL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">InterpolatedSpectrum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span><span class="n">FL</span><span class="p">]),</span><span class="s">&quot;SkySpectrum&quot;</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&quot;resolve_and_integrate&quot;</span><span class="p">))</span>
        
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Applying atmospheric extinction term&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-sky&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.apply_atmosphere"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.apply_atmosphere">[docs]</a>    <span class="k">def</span> <span class="nf">apply_atmosphere</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply the atmospheric extinction term.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_apply_atmosphere</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">save</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="s">&quot;Atmosphere&quot;</span><span class="p">)</span> <span class="p">)</span>
        
        </div>
    <span class="k">def</span> <span class="nf">_apply_atmosphere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lenslet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for _apply_atmosphere&quot;&quot;&quot;</span>
        <span class="n">lenslet</span><span class="o">.</span><span class="n">spectrum</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="s">&quot;Atmosphere&quot;</span><span class="p">)</span>
        
    
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Setting up lenslet hexagons&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-lenslets&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.setup_hexagons"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_hexagons">[docs]</a>    <span class="k">def</span> <span class="nf">setup_hexagons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make the lenslet hexagons&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="o">.</span><span class="n">make_hexagon</span><span class="p">(),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;green&quot;</span><span class="p">)</span>
        
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Making source pixels&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-source&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.setup_source_pixels"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_source_pixels">[docs]</a>    <span class="k">def</span> <span class="nf">setup_source_pixels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup source pixels&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_pixels</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">make_pixel_square</span><span class="p">(),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;green&quot;</span><span class="p">)</span>
       
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Applying Sky Spectrum to Source&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-sky&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.apply_sky"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.apply_sky">[docs]</a>    <span class="k">def</span> <span class="nf">apply_sky</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply Sky Spectrum to each lenslet&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_apply_sky_spectrum</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">frame</span><span class="p">())</span>
        
        </div>
    <span class="k">def</span> <span class="nf">_apply_sky_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lenslet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for _apply_sky_spectrum&quot;&quot;&quot;</span>
        <span class="n">lenslet</span><span class="o">.</span><span class="n">spectrum</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">_apply_qe_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lenslet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply qe to each lenslet&quot;&quot;&quot;</span>
        <span class="n">lenslet</span><span class="o">.</span><span class="n">spectrum</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qe</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.Tel.area&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Observation.exposure&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.eADU&quot;</span><span class="p">]</span>
        
    
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Applying Quantum Efficiency Functions&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-sky&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.apply_qe"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.apply_qe">[docs]</a>    <span class="k">def</span> <span class="nf">apply_qe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply the instrument quantum efficiency&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_apply_qe_spectrum</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.Tel.area&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Observation.exposure&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.eADU&quot;</span><span class="p">],</span><span class="s">&quot;Sky Mul&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">qe</span><span class="o">.</span><span class="n">frame</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.Tel.area&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Observation.exposure&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.eADU&quot;</span><span class="p">],</span><span class="s">&quot;Spec Mul&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">qe</span><span class="o">.</span><span class="n">frame</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="s">&quot;Moon&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.Tel.area&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Observation.exposure&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.eADU&quot;</span><span class="p">],</span><span class="s">&quot;Moon Mul&quot;</span><span class="p">,</span><span class="n">select</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="s">&quot;Moon Mul&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">qe</span><span class="o">.</span><span class="n">frame</span><span class="p">(),</span><span class="s">&quot;Moon QE&quot;</span><span class="p">,</span><span class="n">select</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Performing geometric resample&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-source-pixels&quot;</span><span class="p">,</span><span class="s">&quot;setup-hexagons&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.geometric_resample"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.geometric_resample">[docs]</a>    <span class="k">def</span> <span class="nf">geometric_resample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for fname&quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SourcePixels</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lenslets</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span><span class="n">l</span><span class="o">.</span><span class="n">setup_crosstalk</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_pixels</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">setup_crosstalk</span><span class="p">(</span><span class="n">m</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">map_over_pixels</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span><span class="n">l</span><span class="o">.</span><span class="n">find_crosstalk</span><span class="p">(</span><span class="n">p</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;green&quot;</span><span class="p">)</span>
        
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Setting up calibration source&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-config&quot;</span><span class="p">,</span><span class="s">&quot;setup-constants&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.setup_line_list"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_line_list">[docs]</a>    <span class="k">def</span> <span class="nf">setup_line_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set up a line-list based spectrum for wavelength calibration.&quot;&quot;&quot;</span>
        <span class="n">linelist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_filename</span><span class="p">(</span><span class="s">&quot;Data&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Source.Lines.List&quot;</span><span class="p">]),</span><span class="n">comments</span><span class="o">=</span><span class="s">&quot;#&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">linelist</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">linelist</span> <span class="o">=</span> <span class="n">linelist</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">CalSpec</span> <span class="o">=</span> <span class="n">FlatSpectrum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Source.Lines.sigma&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">linelist</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Source.Lines.peaks&quot;</span><span class="p">]:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">center</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Source.Lines.value&quot;</span><span class="p">]</span>
                <span class="n">center</span> <span class="o">=</span> <span class="n">line</span>
            <span class="n">CalSpec</span> <span class="o">+=</span> <span class="n">GaussianSpectrum</span><span class="p">(</span><span class="n">center</span><span class="p">,</span><span class="n">sigma</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="s">&quot;Line </span><span class="si">%g</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">UnitarySpectrum</span><span class="p">(</span><span class="n">CalSpec</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&#39;resolve_and_integrate&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Calibration Lamp&quot;</span><span class="p">),</span><span class="n">select</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Using calibration lamp source&quot;</span><span class="p">)</span>
    <span class="nd">@help</span><span class="p">(</span><span class="s">&quot;Use a calibration lamp source&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-lenslets&quot;</span><span class="p">,</span><span class="s">&quot;setup-lines&quot;</span><span class="p">,</span><span class="s">&quot;setup&quot;</span><span class="p">)</span>
    <span class="nd">@replaces</span><span class="p">(</span><span class="s">&quot;setup-source&quot;</span><span class="p">,</span><span class="s">&quot;geometric-resample&quot;</span><span class="p">,</span><span class="s">&quot;setup-source-pixels&quot;</span><span class="p">,</span><span class="s">&quot;apply-sky&quot;</span><span class="p">,</span><span class="s">&quot;apply-atmosphere&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.line_source"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.line_source">[docs]</a>    <span class="k">def</span> <span class="nf">line_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use the line spectrum only&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Output.Label&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&quot;-cal-&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replace_source</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="s">&quot;Calibration Lamp&quot;</span><span class="p">))</span>
        
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Using only Sky spectrum&quot;</span><span class="p">)</span>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Use only Sky spectrum&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-sky&quot;</span><span class="p">,</span><span class="s">&quot;apply-sky&quot;</span><span class="p">,</span><span class="s">&quot;apply-qe&quot;</span><span class="p">,</span><span class="s">&quot;apply-atmosphere&quot;</span><span class="p">,</span><span class="s">&quot;setup-lenslets&quot;</span><span class="p">,</span><span class="s">&quot;setup&quot;</span><span class="p">)</span>
    <span class="nd">@replaces</span><span class="p">(</span><span class="s">&quot;setup-source&quot;</span><span class="p">,</span><span class="s">&quot;geometric-resample&quot;</span><span class="p">,</span><span class="s">&quot;setup-source-pixels&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.sky_source"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.sky_source">[docs]</a>    <span class="k">def</span> <span class="nf">sky_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use the sky spectrum only&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Output.Label&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&quot;-sky-&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replace_source</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">frame</span><span class="p">())</span>

    </div>
    <span class="nd">@ignore</span>
<div class="viewcode-block" id="SEDSimulator.replace_source"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.replace_source">[docs]</a>    <span class="k">def</span> <span class="nf">replace_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">spectrum</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replace the default file-source with a flat spectrum&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span><span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_replace_source</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    
    </div>
    <span class="nd">@ignore</span>
    <span class="k">def</span> <span class="nf">_replace_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lenslet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for _flat_source&quot;&quot;&quot;</span>
        <span class="n">lenslet</span><span class="o">.</span><span class="n">spectrum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span>
            
    
    
    
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Using flat source&quot;</span><span class="p">)</span>
    <span class="nd">@help</span><span class="p">(</span><span class="s">&quot;Make a constant value source&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-lenslets&quot;</span><span class="p">,</span><span class="s">&quot;setup&quot;</span><span class="p">)</span>
    <span class="nd">@replaces</span><span class="p">(</span><span class="s">&quot;setup-source&quot;</span><span class="p">,</span><span class="s">&quot;geometric-resample&quot;</span><span class="p">,</span><span class="s">&quot;setup-source-pixels&quot;</span><span class="p">,</span><span class="s">&quot;apply-sky&quot;</span><span class="p">,</span><span class="s">&quot;apply-atmosphere&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.flat_source"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.flat_source">[docs]</a>    <span class="k">def</span> <span class="nf">flat_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replace the default file-source with a flat spectrum&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Output.Label&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&quot;-flat-&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replace_source</span><span class="p">(</span><span class="n">FlatSpectrum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Source.Flat.value&quot;</span><span class="p">]))</span>
        
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Calculating dispersion for each lenslet&quot;</span><span class="p">)</span>
    <span class="nd">@help</span><span class="p">(</span><span class="s">&quot;Calculate lenslet dispersion&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-lenslets&quot;</span><span class="p">,</span><span class="s">&quot;setup-caches&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.lenslet_dispersion"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.lenslet_dispersion">[docs]</a>    <span class="k">def</span> <span class="nf">lenslet_dispersion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate the dispersion for each lenslet&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="o">.</span><span class="n">find_dispersion</span><span class="p">(),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;blue&quot;</span><span class="p">)</span>
        
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Tracing lenslet spectra dispersion&quot;</span><span class="p">)</span>
    <span class="nd">@help</span><span class="p">(</span><span class="s">&quot;Trace lenslet spectra dispersion&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;dispersion&quot;</span><span class="p">,</span><span class="s">&quot;setup-caches&quot;</span><span class="p">,</span><span class="s">&quot;setup-lenslets&quot;</span><span class="p">,</span><span class="s">&quot;apply-sky&quot;</span><span class="p">,</span><span class="s">&quot;apply-qe&quot;</span><span class="p">,</span><span class="s">&quot;apply-atmosphere&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.lenslet_trace"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.lenslet_trace">[docs]</a>    <span class="k">def</span> <span class="nf">lenslet_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Trace out each lenslet&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="o">.</span><span class="n">get_trace</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">spectrum</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;blue&quot;</span><span class="p">)</span>

    </div>
    <span class="nd">@include</span>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Placing lenslet spectra&quot;</span><span class="p">)</span>
    <span class="nd">@help</span><span class="p">(</span><span class="s">&quot;Place subimages&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;trace&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.lenslet_place"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.lenslet_place">[docs]</a>    <span class="k">def</span> <span class="nf">lenslet_place</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Place each spectrum into the subimage&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lenslet_place</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;yellow&quot;</span><span class="p">)</span>
        
    </div>
    <span class="nd">@ignore</span>
    <span class="k">def</span> <span class="nf">_lenslet_place</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">l</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for _lenslet_place&quot;&quot;&quot;</span>
        <span class="n">l</span><span class="o">.</span><span class="n">place_trace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_conv</span><span class="p">)</span>
        <span class="n">l</span><span class="o">.</span><span class="n">write_subimage</span><span class="p">()</span>
    
    
    <span class="nd">@include</span>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Merging subimages&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-blank&quot;</span><span class="p">,</span><span class="s">&quot;setup-lenslets&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.image_merge"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.image_merge">[docs]</a>    <span class="k">def</span> <span class="nf">image_merge</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Merge subimages into master image&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&quot;Blank&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">(),</span><span class="s">&quot;Merge&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lenslet_merge</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;yellow&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&quot;Merge&quot;</span><span class="p">)</span>
        
    
    </div>
    <span class="nd">@ignore</span>
    <span class="k">def</span> <span class="nf">_lenslet_merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lenslet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Merge a single lenslet into the master image&quot;&quot;&quot;</span>
        <span class="n">lenslet</span><span class="o">.</span><span class="n">read_subimage</span><span class="p">()</span>
        <span class="n">lenslet</span><span class="o">.</span><span class="n">bin_subimage</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">lenslet</span><span class="o">.</span><span class="n">data</span><span class="p">(),</span><span class="n">lenslet</span><span class="o">.</span><span class="n">subcorner</span><span class="p">)</span>
        <span class="n">lenslet</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    
    
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Setting up scattered light calculations&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-config&quot;</span><span class="p">,</span><span class="s">&quot;setup-blank&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.setup_scatter"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_scatter">[docs]</a>    <span class="k">def</span> <span class="nf">setup_scatter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets up scattered light level&quot;&quot;&quot;</span>
        
        <span class="n">area</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.ccd.size.px&quot;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.ccd.size.px&quot;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.ccd.size.px&quot;</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.Scatter.Kernels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Gaussian&quot;</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s">&quot;mag&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">gauss_kern</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s">&quot;stdev&quot;</span><span class="p">],</span><span class="n">size</span><span class="p">,</span><span class="n">enlarge</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">normalize</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">npArrayInfo</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="s">&quot;Gauss Kernel&quot;</span><span class="p">))</span>
            <span class="n">area</span> <span class="o">+=</span> <span class="n">n</span>
        
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">framename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">area</span><span class="p">,</span><span class="s">&quot;Scatter&quot;</span><span class="p">)</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        
    
    </div>
    <span class="nd">@include</span>
    <span class="nd">@help</span><span class="p">(</span><span class="s">&quot;Crop Final Image&quot;</span><span class="p">)</span>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Cropping image to CCD size&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-blank&quot;</span><span class="p">,</span><span class="s">&quot;setup-lenslets&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.ccd_crop"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.ccd_crop">[docs]</a>    <span class="k">def</span> <span class="nf">ccd_crop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Crops the image to the appropriate ccd size&quot;&quot;&quot;</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.ccd.size.px&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">size</span><span class="p">)</span>
        
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Setting up Dark/Bias frames&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-config&quot;</span><span class="p">,</span><span class="s">&quot;setup-cameras&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.setup_noise"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_noise">[docs]</a>    <span class="k">def</span> <span class="nf">setup_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes noise masks&quot;&quot;&quot;</span>
        
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">framename</span>
        
        <span class="n">read_noise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.Cameras&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.Cameras.Selected&quot;</span><span class="p">]][</span><span class="s">&quot;RN&quot;</span><span class="p">]</span>
        <span class="n">dark_noise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.Cameras&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.Cameras.Selected&quot;</span><span class="p">]][</span><span class="s">&quot;DC&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Observation.exposure&quot;</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_poisson_noise</span><span class="p">(</span><span class="s">&quot;Read&quot;</span><span class="p">,</span><span class="n">read_noise</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Observation.number&quot;</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_poisson_noise</span><span class="p">(</span><span class="s">&quot;Dark&quot;</span><span class="p">,</span><span class="n">dark_noise</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    
        
    </div>
    <span class="nd">@include</span>
    <span class="nd">@help</span><span class="p">(</span><span class="s">&quot;Add Dark/Bias noise to image&quot;</span><span class="p">)</span>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Adding Dark/Bias noise&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;crop&quot;</span><span class="p">,</span><span class="s">&quot;setup-noise&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.apply_noise"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.apply_noise">[docs]</a>    <span class="k">def</span> <span class="nf">apply_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply the noise masks to the target image label&quot;&quot;&quot;</span>
        
        <span class="n">dark</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="s">&quot;Dark&quot;</span><span class="p">)</span>
        <span class="n">bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="s">&quot;Read&quot;</span><span class="p">)</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
        
        <span class="n">data</span> <span class="o">+=</span> <span class="n">dark</span> <span class="o">+</span> <span class="n">bias</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="s">&quot;Noisy&quot;</span><span class="p">,</span><span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    </div>
    <span class="nd">@include</span>
    <span class="nd">@help</span><span class="p">(</span><span class="s">&quot;Add scattered light noise to image&quot;</span><span class="p">)</span>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Adding scatter noise&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;crop&quot;</span><span class="p">,</span><span class="s">&quot;setup-scatter&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.apply_scatter"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.apply_scatter">[docs]</a>    <span class="k">def</span> <span class="nf">apply_scatter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply the scattered light frame&quot;&quot;&quot;</span>
        
        
        <span class="n">scatter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="s">&quot;Scatter&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">npArrayInfo</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span><span class="s">&quot;Scatter&quot;</span><span class="p">))</span>
        
        
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">npArrayInfo</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="s">&quot;Data </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">framename</span><span class="p">))</span>
        
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.Scatter.FFT&quot;</span><span class="p">]:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">scatter</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;same&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">scatter</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;same&#39;</span><span class="p">)</span>
        
        <span class="n">result</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.Scatter.Amplifier&quot;</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">npArrayInfo</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="s">&quot;Scattered Light&quot;</span><span class="p">))</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">result</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="s">&quot;ScatterOnly&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">end</span><span class="p">,</span><span class="s">&quot;Scattered&quot;</span><span class="p">,</span><span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
    
    </div>
    <span class="nd">@include</span>
    <span class="nd">@help</span><span class="p">(</span><span class="s">&quot;Transpose the image&quot;</span><span class="p">)</span>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Transposing Image&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;crop&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.transpose"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.transpose">[docs]</a>    <span class="k">def</span> <span class="nf">transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;transpose the final image&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span><span class="s">&quot;Transposed&quot;</span><span class="p">,</span><span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
    
    
    
    
    </div>
    <span class="nd">@include</span>
    <span class="nd">@help</span><span class="p">(</span><span class="s">&quot;Save image to file&quot;</span><span class="p">)</span>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Saving image to disk&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.save_file"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.save_file">[docs]</a>    <span class="k">def</span> <span class="nf">save_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Saves the file&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Filename</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Output)s</span><span class="s">/</span><span class="si">%(label)s</span><span class="s">-</span><span class="si">%(date)s</span><span class="s">.</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Output.Label&quot;</span><span class="p">],</span><span class="n">date</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">),</span> <span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Output.Format&quot;</span><span class="p">],</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">]</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Filename</span><span class="p">,</span><span class="n">frames</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">framename</span><span class="p">],</span><span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Wrote </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">Filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Filename</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Output)s</span><span class="s">/</span><span class="si">%(label)s</span><span class="s">-deep-</span><span class="si">%(date)s</span><span class="s">.</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Output.Label&quot;</span><span class="p">],</span><span class="n">date</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">),</span> <span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Output.Format&quot;</span><span class="p">],</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">]</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Filename</span><span class="p">,</span><span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Wrote </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">Filename</span><span class="p">)</span>
    
    
    <span class="c">################################</span>
    <span class="c">## IMAGE MANAGEMENT FUNCTIONS ##</span>
    <span class="c">################################</span>
    </div>
    <span class="nd">@ignore</span>
<div class="viewcode-block" id="SEDSimulator.place"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.place">[docs]</a>    <span class="k">def</span> <span class="nf">place</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">img</span><span class="p">,</span><span class="n">corner</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Place the given AstroObject.AnalyticSpectra.AnalyticSpectrum onto the SEDMachine Image&quot;&quot;&quot;</span>
        
        <span class="n">xstart</span> <span class="o">=</span> <span class="n">corner</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">xend</span> <span class="o">=</span> <span class="n">xstart</span> <span class="o">+</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ystart</span> <span class="o">=</span> <span class="n">corner</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">yend</span> <span class="o">=</span> <span class="n">ystart</span> <span class="o">+</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">xend</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">yend</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SEDLimits</span>
        
        <span class="k">if</span> <span class="n">xstart</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">ystart</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SEDLimits</span>
        
        <span class="k">if</span> <span class="n">xend</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">yend</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SEDLimits</span>
        
        <span class="n">data</span><span class="p">[</span><span class="n">xstart</span><span class="p">:</span><span class="n">xend</span><span class="p">,</span><span class="n">ystart</span><span class="p">:</span><span class="n">yend</span><span class="p">]</span> <span class="o">+=</span> <span class="n">img</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">framename</span><span class="p">,</span><span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>    
        
    
    </div>
    <span class="nd">@ignore</span>
<div class="viewcode-block" id="SEDSimulator.crop"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.crop">[docs]</a>    <span class="k">def</span> <span class="nf">crop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">xsize</span><span class="p">,</span><span class="n">ysize</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Crops the provided image to twice the specified size, centered around the x and y coordinates provided.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ysize</span><span class="p">:</span>
            <span class="n">ysize</span> <span class="o">=</span> <span class="n">xsize</span>
        <span class="n">cropped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="n">xsize</span><span class="p">:</span><span class="n">x</span><span class="o">+</span><span class="n">xsize</span><span class="p">,</span><span class="n">y</span><span class="o">-</span><span class="n">ysize</span><span class="p">:</span><span class="n">y</span><span class="o">+</span><span class="n">ysize</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Cropped and Saved Image&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s">&quot;Cropped&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">cropped</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    
    <span class="c">#######################</span>
    <span class="c">## DEBUGGING METHODS ##</span>
    <span class="c">#######################</span>
    </div>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;dispersion&quot;</span><span class="p">)</span>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Plotting dispersion for each lenslet&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.plot_dispersion_data"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_dispersion_data">[docs]</a>    <span class="k">def</span> <span class="nf">plot_dispersion_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Outputs dispersion debugging data&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="o">.</span><span class="n">plot_dispersion</span><span class="p">(),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Plotting trace data for each lenslet&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;trace&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.plot_trace_data"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_trace_data">[docs]</a>    <span class="k">def</span> <span class="nf">plot_trace_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Outputs plots about each lenslet trace&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="SEDSimulator.plot_spectrum_data"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_spectrum_data">[docs]</a>    <span class="k">def</span> <span class="nf">plot_spectrum_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Outputs plots about each lenslet trace&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="o">.</span><span class="n">plot_spectrum</span><span class="p">(),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Plotting lenslet positions&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-lenslets&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.plot_lenslet_data"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_lenslet_data">[docs]</a>    <span class="k">def</span> <span class="nf">plot_lenslet_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Outputs the lenslet data&quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Plotting lenslet arc positions in Camera (x,y) space&quot;</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Lenslet-cxy</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">xcs</span><span class="p">,</span><span class="n">l</span><span class="o">.</span><span class="n">ycs</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Lenslet c-xy positions&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Plotting lenslet Pupil positions in Pupil (x,y) space&quot;</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Lenslet-pxy</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">l</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">marker</span><span class="o">=</span><span class="s">&#39;.&#39;</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
            
            
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Lenslet p-xy positions&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        
    </div>
<div class="viewcode-block" id="SEDSimulator.plot_lenslet_raw"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_lenslet_raw">[docs]</a>    <span class="k">def</span> <span class="nf">plot_lenslet_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot lesnlet raw data&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="o">.</span><span class="n">plot_raw_data</span><span class="p">(),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Plotting Spectrum Tests&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-sky&quot;</span><span class="p">,</span><span class="s">&quot;setup-source&quot;</span><span class="p">,</span><span class="s">&quot;apply-sky&quot;</span><span class="p">,</span><span class="s">&quot;apply-qe&quot;</span><span class="p">,</span><span class="s">&quot;apply-atmosphere&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.compare_methods"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.compare_methods">[docs]</a>    <span class="k">def</span> <span class="nf">compare_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A plot for comparing resolving methods&quot;&quot;&quot;</span>
        <span class="n">WL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.wavelengths.values&quot;</span><span class="p">]</span>
        <span class="n">RS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.wavelengths.resolutions&quot;</span><span class="p">]</span>
        <span class="n">DWL</span><span class="p">,</span><span class="n">DRS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_resolution_spectrum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">WL</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">WL</span><span class="p">),</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">SWL</span><span class="p">,</span><span class="n">SRS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_resolution_spectrum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">WL</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">WL</span><span class="p">),</span><span class="mi">500</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Resolutions&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">RS</span><span class="p">,</span><span class="s">&#39;g.&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">DWL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">DRS</span><span class="p">,</span><span class="s">&#39;r.&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">SWL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">SRS</span><span class="p">,</span><span class="s">&#39;b.&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="n">expandLim</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">()))</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Test-Spectrum-Res</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Resolve \&amp; Resample Tests&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">npArrayInfo</span><span class="p">(</span><span class="n">WL</span><span class="p">,</span><span class="s">&quot;Wavelength for Sky Plot&quot;</span><span class="p">))</span>
        
        <span class="n">Results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">master</span> <span class="o">=</span> <span class="s">&quot;H Iq&quot;</span>
        
        <span class="k">for</span> <span class="n">wl</span><span class="p">,</span><span class="n">rs</span><span class="p">,</span><span class="n">Label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">WL</span><span class="p">,</span><span class="n">DWL</span><span class="p">,</span><span class="n">SWL</span><span class="p">],[</span><span class="n">RS</span><span class="p">,</span><span class="n">DRS</span><span class="p">,</span><span class="n">SRS</span><span class="p">],[</span><span class="s">&quot;L&quot;</span><span class="p">,</span><span class="s">&quot;M&quot;</span><span class="p">,</span><span class="s">&quot;H&quot;</span><span class="p">]):</span>
            <span class="n">identity</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> Iq&quot;</span> <span class="o">%</span> <span class="n">Label</span>                
            <span class="n">wl</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Source.Filename&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&quot; (O)&quot;</span><span class="p">)(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">wl</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">rs</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&quot;integrate_quad&quot;</span><span class="p">)</span>
            <span class="n">Results</span><span class="p">[</span><span class="n">identity</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">FL</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">wl</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;g.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&quot;-&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> $\Sigma$</span><span class="si">%.2e</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">identity</span><span class="p">,</span><span class="n">Results</span><span class="p">[</span><span class="n">identity</span><span class="p">]))</span>
            
            <span class="n">identity</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> Ih&quot;</span> <span class="o">%</span> <span class="n">Label</span>                
            <span class="n">wl</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Source.Filename&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&quot; (O)&quot;</span><span class="p">)(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">wl</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">rs</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&quot;integrate_hist&quot;</span><span class="p">)</span>
            <span class="n">Results</span><span class="p">[</span><span class="n">identity</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">FL</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">wl</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;b.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&quot;-&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> $\Sigma$</span><span class="si">%.2e</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">identity</span><span class="p">,</span><span class="n">Results</span><span class="p">[</span><span class="n">identity</span><span class="p">]))</span>
            
            <span class="n">identity</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> RR&quot;</span> <span class="o">%</span> <span class="n">Label</span>                
            <span class="n">wl</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Source.Filename&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&quot; (O)&quot;</span><span class="p">)(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">wl</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">rs</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&quot;resolve_and_integrate&quot;</span><span class="p">)</span>
            <span class="n">Results</span><span class="p">[</span><span class="n">identity</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">FL</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">wl</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;r.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&quot;-&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> $\Sigma$</span><span class="si">%.2e</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">identity</span><span class="p">,</span><span class="n">Results</span><span class="p">[</span><span class="n">identity</span><span class="p">]))</span>
        
        <span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Error relative to </span><span class="si">%s</span><span class="s"> in integration and resolution spectrum methods:</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">master</span>
        <span class="n">mv</span> <span class="o">=</span> <span class="n">Results</span><span class="p">[</span><span class="n">master</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">Label</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;L&quot;</span><span class="p">,</span><span class="s">&quot;M&quot;</span><span class="p">,</span><span class="s">&quot;H&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;Iq&quot;</span><span class="p">,</span><span class="s">&quot;Ih&quot;</span><span class="p">,</span><span class="s">&quot;RR&quot;</span><span class="p">]:</span>
                <span class="n">identity</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(label)s</span><span class="s"> </span><span class="si">%(method)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s">&#39;label&#39;</span><span class="p">:</span><span class="n">Label</span><span class="p">,</span><span class="s">&#39;method&#39;</span><span class="p">:</span><span class="n">method</span><span class="p">}</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">Results</span><span class="p">[</span><span class="n">identity</span><span class="p">]</span>
                <span class="n">perr</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">val</span> <span class="o">-</span> <span class="n">mv</span><span class="p">)</span> <span class="o">/</span> <span class="n">mv</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span>
                <span class="n">line</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(identity)s</span><span class="s"> $\Sigma = $</span><span class="si">%(value).3e</span><span class="s"> Error </span><span class="si">%(perr).2f</span><span class="s"> \</span><span class="si">%%</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s">&#39;identity&#39;</span><span class="p">:</span><span class="n">identity</span><span class="p">,</span><span class="s">&#39;value&#39;</span><span class="p">:</span><span class="n">val</span><span class="p">,</span><span class="s">&#39;perr&#39;</span><span class="p">:</span><span class="n">perr</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">identity</span> <span class="o">==</span> <span class="n">master</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s">&quot; MASTER</span><span class="se">\n</span><span class="s">&quot;</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="n">line</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;Flux (Photons)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;expand&quot;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Test-R-and-R</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        
        
        
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Resolve \&amp; Resample Test Results&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span><span class="n">text</span><span class="p">,</span>
            <span class="n">horizontalalignment</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">,</span>
            <span class="n">verticalalignment</span><span class="o">=</span><span class="s">&#39;center&#39;</span><span class="p">,</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Test-R-and-R-vals</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        
        
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Resample Tests&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">npArrayInfo</span><span class="p">(</span><span class="n">WL</span><span class="p">,</span><span class="s">&quot;Wavelength for Sky Plot&quot;</span><span class="p">))</span>
        
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Source.Filename&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&quot; (O)&quot;</span><span class="p">)(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&quot;interpolate&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Interpolate&quot;</span><span class="p">)</span>
        
        <span class="n">SWL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Source.Filename&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&quot; (O)&quot;</span><span class="p">)(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">SWL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">SRS</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&quot;resample&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">SWL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;SR Resample&quot;</span><span class="p">)</span>
        
        <span class="n">DWL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Source.Filename&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&quot; (O)&quot;</span><span class="p">)(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">DWL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">DRS</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&quot;resample&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">DWL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;HR Resample&quot;</span><span class="p">)</span>
        
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Source.Filename&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&quot; (O)&quot;</span><span class="p">)(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&quot;resample&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;LR Resample&quot;</span><span class="p">)</span>
        
        


        
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;Flux (Photons)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Test-Resample</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        
        </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Plotting Sky Spectrum&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-sky&quot;</span><span class="p">,</span><span class="s">&quot;apply-sky&quot;</span><span class="p">,</span><span class="s">&quot;apply-qe&quot;</span><span class="p">,</span><span class="s">&quot;plot-sky-o&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.plot_sky"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_sky">[docs]</a>    <span class="k">def</span> <span class="nf">plot_sky</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot sky spectrum&quot;&quot;&quot;</span>
        <span class="n">WL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.wavelengths.values&quot;</span><span class="p">]</span>
        <span class="n">RS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.wavelengths.resolutions&quot;</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Resolution&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">RS</span><span class="p">,</span><span class="s">&#39;g.&#39;</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Sky-Spectrum-Res</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Sky Spectrum&quot;</span><span class="p">)</span>

        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">frame</span><span class="p">()(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;b.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Sky + Moon (qe)&quot;</span><span class="p">)</span>
        
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="s">&quot;Sky Mul&quot;</span><span class="p">)(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;m.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Sky + Moon&quot;</span><span class="p">)</span>
        
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="s">&quot;Sky Mul&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="s">&quot;Moon Mul&quot;</span><span class="p">))(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;g.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Sky&quot;</span><span class="p">)</span>
        
        <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">()</span>
        
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="s">&quot;Moon Mul&quot;</span><span class="p">)(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;y.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Moon&quot;</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="s">&quot;Moon QE&quot;</span><span class="p">)(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;c.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Moon (qe)&quot;</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        
        <span class="c"># plt.axis(axis)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;Flux (Photons)&quot;</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Sky-Spectrum</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Plotting Original Sky Spectrum&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-sky&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.plot_sky_original"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_sky_original">[docs]</a>    <span class="k">def</span> <span class="nf">plot_sky_original</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot sky spectrum&quot;&quot;&quot;</span>
        <span class="n">WL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.wavelengths.values&quot;</span><span class="p">]</span>
        <span class="n">RS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.wavelengths.resolutions&quot;</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Resolution&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">RS</span><span class="p">,</span><span class="s">&#39;g.&#39;</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Sky-Spectrum-Res</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Sky Spectrum&quot;</span><span class="p">)</span>

        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="s">&quot;SkySpectrum (O)&quot;</span><span class="p">)(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;g.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Sky&quot;</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;Flux (Photons)&quot;</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Sky-Original-Spectrum</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Plotting Original Source Spectrum&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-lines&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.plot_original_calibration"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_original_calibration">[docs]</a>    <span class="k">def</span> <span class="nf">plot_original_calibration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot the original calibration source&quot;&quot;&quot;</span>
        <span class="n">WL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.wavelengths.values&quot;</span><span class="p">]</span>
        <span class="n">RS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.wavelengths.resolutions&quot;</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Calibration Spectrum&quot;</span><span class="p">)</span>
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="s">&quot;Calibration Source&quot;</span><span class="p">)(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;r.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Source&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;Flux (Photons)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Cal-Original-Spectrum</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        
    </div>
<div class="viewcode-block" id="SEDSimulator.plot_original_source"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_original_source">[docs]</a>    <span class="k">def</span> <span class="nf">plot_original_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot the original source spectrum only&quot;&quot;&quot;</span>
        <span class="n">WL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.wavelengths.values&quot;</span><span class="p">]</span>
        <span class="n">RS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.wavelengths.resolutions&quot;</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Resolution&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">RS</span><span class="p">,</span><span class="s">&#39;g.&#39;</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Source-Spectrum-Res</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Source Spectrum&quot;</span><span class="p">)</span>
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Source.Filename&quot;</span><span class="p">]</span><span class="o">+</span><span class="s">&quot; (O)&quot;</span><span class="p">)(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;r.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Source&quot;</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;Flux (Photons)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Source-Original-Spectrum</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Plotting Source Spectrum&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-sky&quot;</span><span class="p">,</span><span class="s">&quot;setup-source&quot;</span><span class="p">,</span><span class="s">&quot;apply-sky&quot;</span><span class="p">,</span><span class="s">&quot;apply-qe&quot;</span><span class="p">,</span><span class="s">&quot;apply-atmosphere&quot;</span><span class="p">,</span><span class="s">&quot;plot-source-o&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.plot_source"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_source">[docs]</a>    <span class="k">def</span> <span class="nf">plot_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot the source spectrum&quot;&quot;&quot;</span>
        <span class="n">WL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.wavelengths.values&quot;</span><span class="p">]</span>
        <span class="n">RS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.wavelengths.resolutions&quot;</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Resolution&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">RS</span><span class="p">,</span><span class="s">&#39;g.&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Requested R&quot;</span><span class="p">)</span>
        <span class="n">GWL</span><span class="p">,</span><span class="n">GFL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="s">&quot;Original&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">GWL</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">GWL</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">GWL</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Given R&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Source-Spectrum-Res</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Source Spectrum&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">npArrayInfo</span><span class="p">(</span><span class="n">WL</span><span class="p">,</span><span class="s">&quot;Wavelength for Sky Plot&quot;</span><span class="p">))</span>
        
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">frame</span><span class="p">()(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">npArrayInfo</span><span class="p">(</span><span class="n">WL</span><span class="p">,</span><span class="s">&quot;Wavelength from Source Plot&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">npArrayInfo</span><span class="p">(</span><span class="n">FL</span><span class="p">,</span><span class="s">&quot;Flux from Source Plot&quot;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;b.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Combined&quot;</span><span class="p">)</span>
        
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="s">&quot;Atmosphere&quot;</span><span class="p">))(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;r.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Source (qe)&quot;</span><span class="p">)</span>
        
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">frame</span><span class="p">()(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;g-&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Sky (qe)&quot;</span><span class="p">)</span>
        
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="s">&quot;Sky Mul&quot;</span><span class="p">)(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;g-&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Sky + Moon&quot;</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        
        
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="s">&quot;Sky Mul&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="s">&quot;Moon Mul&quot;</span><span class="p">))(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;y-&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Sky&quot;</span><span class="p">)</span>
        
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="s">&quot;Spec Mul&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="s">&quot;Moon Mul&quot;</span><span class="p">))(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;m.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Source&quot;</span><span class="p">)</span>
        
        <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">()</span>
        
        
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="s">&quot;Moon Mul&quot;</span><span class="p">)(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">RS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">npArrayInfo</span><span class="p">(</span><span class="n">WL</span><span class="p">,</span><span class="s">&quot;Wavelength from Moon Plot&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">npArrayInfo</span><span class="p">(</span><span class="n">FL</span><span class="p">,</span><span class="s">&quot;Flux from Moon Plot&quot;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;m-&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Moon&quot;</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;Flux (Photons)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Source-Spectrum</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Plotting QE Spectrum&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-sky&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.plot_qe"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_qe">[docs]</a>    <span class="k">def</span> <span class="nf">plot_qe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot sky spectrum&quot;&quot;&quot;</span>
        <span class="n">WL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.wavelengths.values&quot;</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;QE Spectrum&quot;</span><span class="p">)</span>
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qe</span><span class="o">.</span><span class="n">frame</span><span class="p">()(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;b.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Quantum Efficiency&quot;</span><span class="p">)</span>
        <span class="n">WL</span><span class="p">,</span><span class="n">FL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sky</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="s">&quot;Atmosphere&quot;</span><span class="p">)(</span><span class="n">wavelengths</span><span class="o">=</span><span class="n">WL</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">WL</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="n">FL</span><span class="p">,</span><span class="s">&#39;m.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Extinction&quot;</span><span class="p">)</span>
        
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_formatter</span><span class="p">(</span>
            <span class="n">LogFormatterTeXExponent</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
             <span class="n">labelOnlyBase</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
                     
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;Flux (Fraction)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/QE-Spectrum</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Plotting Lenslet hexagons&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-hexagons&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.plot_hexagons"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_hexagons">[docs]</a>    <span class="k">def</span> <span class="nf">plot_hexagons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot the lenslet Hexagons&quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Position of Lenslets&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span><span class="n">l</span><span class="o">.</span><span class="n">show_geometry</span><span class="p">(),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Lenslet-Hexagons</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Plotting pixel squares&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-source-pixels&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.plot_pixels"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_pixels">[docs]</a>    <span class="k">def</span> <span class="nf">plot_pixels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot the source pixels&quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Position of pixels&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_pixels</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">show_geometry</span><span class="p">(),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Pixel-Geometry</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Plotting invalid pixel squares&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-source-pixels&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.plot_invalid_pixels"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_invalid_pixels">[docs]</a>    <span class="k">def</span> <span class="nf">plot_invalid_pixels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot invalid shapes&quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Position of invalid pixels&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_pixels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_plot_invalid_pixels</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Pixel-Invalid-Geometry</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    </div>
    <span class="nd">@ignore</span>
    <span class="k">def</span> <span class="nf">_plot_invalid_pixels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pixel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for _plot_invalid_hexagon&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pixel</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
            <span class="n">pixel</span><span class="o">.</span><span class="n">show_geometry</span><span class="p">()</span>
    
    
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Plotting invalid hexagons&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-hexagons&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.plot_invalid_hexagons"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_invalid_hexagons">[docs]</a>    <span class="k">def</span> <span class="nf">plot_invalid_hexagons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot invalid shapes&quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Position of invalid hexagons&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_plot_invalid_hexagon</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Lenslet-Invalid-Geometry</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    </div>
    <span class="nd">@ignore</span>
    <span class="k">def</span> <span class="nf">_plot_invalid_hexagon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lenslet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for _plot_invalid_hexagon&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lenslet</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
            <span class="n">lenslet</span><span class="o">.</span><span class="n">show_geometry</span><span class="p">()</span>
        
    
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Plotting Lenslet-plane geometry&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-source-pixels&quot;</span><span class="p">,</span><span class="s">&quot;setup-hexagons&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.plot_geometry"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_geometry">[docs]</a>    <span class="k">def</span> <span class="nf">plot_geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot all of the geomoetry stacked&quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Lenslet Plane Geometry&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span><span class="n">l</span><span class="o">.</span><span class="n">show_geometry</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;#cccc00&quot;</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_pixels</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">show_geometry</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;#cc00cc&quot;</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">()</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s">&#39;equal&#39;</span><span class="p">)</span>
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/System-Geometry</span><span class="si">%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Plotting resample matrix&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;geometric-resample&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.plot_resample"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_resample">[docs]</a>    <span class="k">def</span> <span class="nf">plot_resample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show the geometric resample&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_pixels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_show_resample</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
    </div>
    <span class="nd">@ignore</span>
    <span class="k">def</span> <span class="nf">_show_resample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pixel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for _show_resample&quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Resample for pixel </span><span class="si">%g</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">pixel</span><span class="o">.</span><span class="n">num</span><span class="p">)</span>
        <span class="n">pixel</span><span class="o">.</span><span class="n">show_geometry</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_show_lenslet_resample</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">pixel</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="c"># plt.colorbar()</span>
        
        <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/System-Geometry-</span><span class="si">%(pixel)g%(fmt)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">pixel</span><span class="o">=</span><span class="n">pixel</span><span class="o">.</span><span class="n">num</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">])</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    
    
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Plotting lenslet ellipse sizes&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-lenslets&quot;</span><span class="p">,</span><span class="s">&quot;dispersion&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.plot_ellipses"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_ellipses">[docs]</a>    <span class="k">def</span> <span class="nf">plot_ellipses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for plot_ellipses&quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="o">.</span><span class="n">plot_ellipses</span><span class="p">(),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Major Axis Size&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Wavelength ($\mu m$)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;$\Delta$-position ($px$)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="n">expandLim</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">()))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Lenslets-WL-dy</span><span class="si">%(ext)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ext</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">]))</span>
        
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Plotting lenslet ellipse sizes&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-lenslets&quot;</span><span class="p">,</span><span class="s">&quot;dispersion&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.plot_rotation"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_rotation">[docs]</a>    <span class="k">def</span> <span class="nf">plot_rotation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot rotation&quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="o">.</span><span class="n">plot_rotation</span><span class="p">(),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Major Axis Rotation&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;Wavelength ($\mu m$)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;Rotation (Degrees)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="n">expandLim</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">()))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Lenslets-WL-dr</span><span class="si">%(ext)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ext</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">],</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">]))</span>
        
    </div>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Plotting PSF Kernels&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;setup-caches&quot;</span><span class="p">,</span><span class="s">&quot;setup-config&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.plot_kernel_partials"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.plot_kernel_partials">[docs]</a>    <span class="k">def</span> <span class="nf">plot_kernel_partials</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plots the kernel data partials&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Generating Kernel Plots and Images&quot;</span><span class="p">)</span>
        <span class="n">major</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.Tel.radius.px&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.density&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.2</span>
        <span class="n">minor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.Tel.radius.px&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.density&quot;</span><span class="p">]</span>
        <span class="n">ETEL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tel_kern</span><span class="p">(</span><span class="n">major</span><span class="p">,</span><span class="n">minor</span><span class="p">)</span>
        <span class="n">ECONV</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="p">[</span><span class="s">&quot;PSF&quot;</span><span class="p">],</span><span class="n">ETEL</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;same&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ETEL</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Telescope Image (Ellipse)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/Instrument-ETEL-Kernel</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs.Partials&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">]))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ECONV</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Convolved ETel + PSF Image&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/Instrument-ECONV-Kernel</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs.Partials&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">]))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        
        
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="p">[</span><span class="s">&quot;TEL&quot;</span><span class="p">],</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Telescope Image&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/Instrument-TEL-Kernel</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs.Partials&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">]))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="p">[</span><span class="s">&quot;PSF&quot;</span><span class="p">],</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;PSF Image&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/Instrument-PSF-Kernel</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs.Partials&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">]))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="p">[</span><span class="s">&quot;CONV&quot;</span><span class="p">],</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Convolved Tel + PSF Image&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/Instrument-FIN-Kernel</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs.Partials&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Plots.format&quot;</span><span class="p">]))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        
        </div>
    <span class="nd">@ignore</span>
    <span class="k">def</span> <span class="nf">_show_lenslet_resample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lenslet</span><span class="p">,</span><span class="n">pixel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for _show_lenslet_resample&quot;&quot;&quot;</span>
        <span class="n">lenslet</span><span class="o">.</span><span class="n">show_geometry</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">pixel</span><span class="o">.</span><span class="n">get_color</span><span class="p">(</span><span class="n">lenslet</span><span class="o">.</span><span class="n">idx</span><span class="p">))</span>
    
    
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Writing resample Matrix&quot;</span><span class="p">)</span>
    <span class="nd">@depends</span><span class="p">(</span><span class="s">&quot;geometric-resample&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.write_resample"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.write_resample">[docs]</a>    <span class="k">def</span> <span class="nf">write_resample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the resample matrix to file&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Resample-info.dat&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">]),</span><span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infostream</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%(Partials)s</span><span class="s">/Resample.dat&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Dirs&quot;</span><span class="p">]),</span><span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">rawstream</span><span class="p">:</span>
                <span class="n">infostream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;# Resample Matrix </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">map_over_lenslets</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_resample</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">infostream</span><span class="p">,</span><span class="n">rawstream</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;cyan&quot;</span><span class="p">)</span>
    </div>
    <span class="nd">@ignore</span>
    <span class="k">def</span> <span class="nf">_write_resample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lenslet</span><span class="p">,</span><span class="n">streama</span><span class="p">,</span><span class="n">streamb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the resampleing matrix&quot;&quot;&quot;</span>
        <span class="n">string</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%(lenslet)d</span><span class="s"> </span><span class="si">%(info)s</span><span class="s"> </span><span class="si">%(spec)s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">{</span> <span class="s">&#39;lenslet&#39;</span><span class="p">:</span> <span class="n">lenslet</span><span class="o">.</span><span class="n">num</span><span class="p">,</span> <span class="s">&#39;info&#39;</span><span class="p">:</span> <span class="n">npArrayInfo</span><span class="p">(</span><span class="n">lenslet</span><span class="o">.</span><span class="n">pixelValues</span><span class="p">),</span> <span class="s">&#39;array&#39;</span><span class="p">:</span> <span class="n">lenslet</span><span class="o">.</span><span class="n">pixelValues</span> <span class="p">,</span> <span class="s">&#39;spec&#39;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">lenslet</span><span class="o">.</span><span class="n">spectrum</span><span class="p">)}</span>
        <span class="n">streama</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">streamb</span><span class="p">,</span><span class="n">lenslet</span><span class="o">.</span><span class="n">pixelValues</span><span class="p">)</span>
        
    
    <span class="c">#######################</span>
    <span class="c">## Mapping Functions ##</span>
    <span class="c">#######################</span>
    
    <span class="nd">@ignore</span>
<div class="viewcode-block" id="SEDSimulator.map_over_lenslets"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.map_over_lenslets">[docs]</a>    <span class="k">def</span> <span class="nf">map_over_lenslets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">function</span><span class="p">,</span><span class="n">exceptions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;green&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps a given function to operate on each lenslet, and displays a progress bar along the way.&quot;&quot;&quot;</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lenslets</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_collection</span><span class="p">(</span><span class="n">function</span><span class="p">,</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span><span class="n">l</span><span class="o">.</span><span class="n">num</span><span class="p">,</span><span class="n">collection</span><span class="p">,</span><span class="n">exceptions</span><span class="p">,</span><span class="n">color</span><span class="p">)</span>
        
    </div>
    <span class="nd">@ignore</span>
<div class="viewcode-block" id="SEDSimulator.map_over_pixels"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.map_over_pixels">[docs]</a>    <span class="k">def</span> <span class="nf">map_over_pixels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">function</span><span class="p">,</span><span class="n">exceptions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;green&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps some function over a bunch of source pixels&quot;&quot;&quot;</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SourcePixels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_over_collection</span><span class="p">(</span><span class="n">function</span><span class="p">,</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">num</span><span class="p">,</span><span class="n">collection</span><span class="p">,</span><span class="n">exceptions</span><span class="p">,</span><span class="n">color</span><span class="p">)</span>        
        
    
    <span class="c">###################</span>
    <span class="c">## Image KERNELS ##</span>
    <span class="c">###################</span>
    
    </div>
    <span class="nd">@ignore</span>
<div class="viewcode-block" id="SEDSimulator.generate_poisson_noise"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.generate_poisson_noise">[docs]</a>    <span class="k">def</span> <span class="nf">generate_poisson_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">lam</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates a poisson noise mask, saving to this object&quot;&quot;&quot;</span>
        <span class="n">distribution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.ccd.size.px&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.ccd.size.px&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s">&quot;Poisson Noise Mask (</span><span class="si">%2g</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lam</span><span class="p">)</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="p">(</span><span class="n">lam</span><span class="p">,</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
            <span class="n">noise</span> <span class="o">+=</span> <span class="n">distribution</span><span class="p">(</span><span class="o">*</span><span class="n">arguments</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span><span class="n">label</span><span class="p">)</span>
    </div>
    <span class="nd">@ignore</span>
<div class="viewcode-block" id="SEDSimulator.get_conv"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.get_conv">[docs]</a>    <span class="k">def</span> <span class="nf">get_conv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">wavelength</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">rot</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a PSF for a given wavelength in the system&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">b</span><span class="p">:</span>
            <span class="n">ai</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="n">bi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rot</span> <span class="o">*</span> <span class="mf">180.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ai</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ellipses</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ellipses</span><span class="p">[</span><span class="n">ai</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">bi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ellipses</span><span class="p">[</span><span class="n">ai</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ellipses</span><span class="p">[</span><span class="n">ai</span><span class="p">][</span><span class="n">bi</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">ri</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ellipses</span><span class="p">[</span><span class="n">ai</span><span class="p">][</span><span class="n">bi</span><span class="p">]:</span>
                <span class="n">ETEL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tel_kern</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">CONV</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="p">[</span><span class="s">&quot;PSF&quot;</span><span class="p">],</span><span class="n">ETEL</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;same&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ellipses</span><span class="p">[</span><span class="n">ai</span><span class="p">][</span><span class="n">bi</span><span class="p">][</span><span class="n">ri</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONV</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">CONV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ellipses</span><span class="p">[</span><span class="n">ai</span><span class="p">][</span><span class="n">bi</span><span class="p">][</span><span class="n">ri</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&quot;found&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">found</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CONV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Caches</span><span class="p">[</span><span class="s">&quot;CONV&quot;</span><span class="p">]</span> 
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONV</span>
    </div>
    <span class="nd">@ignore</span>
<div class="viewcode-block" id="SEDSimulator.psf_kern"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.psf_kern">[docs]</a>    <span class="k">def</span> <span class="nf">psf_kern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">truncate</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">header_lines</span><span class="o">=</span><span class="mi">18</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates a PSF Kernel from a file with micron-encircled energy conversions. The file should have two columns, first, microns from the center of the PSF, and second, the fraction of encircled energy at that distance from the PSF.</span>
<span class="sd">        </span>
<span class="sd">        The calculation is then carried out using a spline fit to this data. From the spline fit, the function returns the first derivative of the encircled energy at each point. This in effect is the amount of energy at each point. These values are then normalized, to create a PSF mask for the instrument.</span>
<span class="sd">        </span>
<span class="sd">        The `size` parameter specifies the size of the kernel to use. If the size is greater than the encircled energy data, then a larger figure will be returned. If `size` is smaller than the encircled energy data, it will return an image the size of the encircled energy data, unless the `truncate` parameter is set to `true`.</span>
<span class="sd">        </span>
<span class="sd">        The `header_lines` parameter defaults to 18, which works with Zemax encircled energy output.&quot;&quot;&quot;</span>
        
        <span class="n">uM</span><span class="p">,</span><span class="n">FR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">skip_header</span><span class="o">=</span><span class="n">header_lines</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="c"># Convert microns to milimeters, then pixels, then dense pixels</span>
        <span class="n">PX</span> <span class="o">=</span> <span class="n">uM</span> <span class="o">*</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.convert.mmtopx&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.density&quot;</span><span class="p">]</span>
        <span class="c"># Set the frame size for the PSF</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">PX</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">size</span> <span class="ow">or</span> <span class="n">truncate</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">PX</span><span class="p">))</span>
        <span class="c"># Create the Interpolation Function</span>
        <span class="n">fit_vars</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">PX</span><span class="p">,</span><span class="n">FR</span><span class="p">)</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">fit_vars</span><span class="p">,</span><span class="n">der</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">vfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
        <span class="c"># Create the 2-D function application grid</span>
        <span class="n">x</span> <span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="o">-</span><span class="n">size</span><span class="p">:</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="n">size</span><span class="p">:</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="c"># Convert this grid into the distance from the center of the PSF at each point</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">vfit</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">v</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Generated a PSF Kernel for the encircled energy file </span><span class="si">%s</span><span class="s"> with shape </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">val</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    </div>
    <span class="nd">@ignore</span>
<div class="viewcode-block" id="SEDSimulator.ellipse_kern"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.ellipse_kern">[docs]</a>    <span class="k">def</span> <span class="nf">ellipse_kern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">major</span><span class="p">,</span><span class="n">minor</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">sizey</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">normalize</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for elipse_kern&quot;&quot;&quot;</span>
        <span class="n">size</span> <span class="o">/=</span> <span class="mi">2</span>
        <span class="n">sizey</span> <span class="o">/=</span> <span class="mi">2</span>
        
        <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">sizey</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">sizey</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">major</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">major</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">sizey</span> <span class="o">=</span> <span class="n">size</span>
        
        <span class="n">major</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">major</span><span class="p">)</span>
        <span class="n">minor</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">minor</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
        
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="o">-</span><span class="n">size</span><span class="p">:</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">sizey</span><span class="p">:</span><span class="n">sizey</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">x</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha</span><span class="p">))</span><span class="o">/</span><span class="n">minor</span><span class="p">)</span><span class="o">**</span><span class="mf">2.0</span> <span class="o">+</span> <span class="p">((</span><span class="n">x</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">))</span><span class="o">/</span><span class="n">major</span><span class="p">)</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span>
        
        <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>
        
        
    </div>
    <span class="nd">@ignore</span>
<div class="viewcode-block" id="SEDSimulator.circle_kern"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.circle_kern">[docs]</a>    <span class="k">def</span> <span class="nf">circle_kern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">sizey</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">normalize</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a Circle Kernel for modeling the \&quot;Image of the Telescope\&quot;. The radius should be set in array units.</span>
<span class="sd">        </span>
<span class="sd">        `size` will determine the size of the array image, unless `size` is less than `radius`, in which case the image will be automatically increased to fit the entire circle.</span>
<span class="sd">        </span>
<span class="sd">        `normalize` controls whether the data is normalized or not. If it is not normalized, the data will have only 1.0 and 0.0 values, where 1.0 is within the radius, and 0.0 is outside the raidus.&quot;&quot;&quot;</span>
        <span class="n">size</span> <span class="o">/=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">radius</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="o">-</span><span class="n">size</span><span class="p">:</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">size</span><span class="p">:</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mf">2.0</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span> <span class="o">&lt;=</span> <span class="n">radius</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>
    </div>
    <span class="nd">@ignore</span>
<div class="viewcode-block" id="SEDSimulator.gauss_kern"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.gauss_kern">[docs]</a>    <span class="k">def</span> <span class="nf">gauss_kern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stdev</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">stdevy</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">sizey</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">enlarge</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">normalize</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a normalized 2D gaussian kernel array for convolutions.</span>
<span class="sd">        </span>
<span class="sd">        `stdev` is the standard deviation in the x-direction. If the `stdevy` keyword is not set, then it will be used as the standard deviation in the y-direction as well.</span>
<span class="sd">        </span>
<span class="sd">        `size` will determine the size of the returned image unless `size` is less than `stdev**2`.</span>
<span class="sd">        </span>
<span class="sd">        Results from this function are always normalized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">stdev</span><span class="o">*</span><span class="mf">1.5</span><span class="p">)</span> <span class="ow">and</span> <span class="n">enlarge</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">stdev</span><span class="o">*</span><span class="mf">1.5</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stdevy</span><span class="p">:</span>
            <span class="n">stdevy</span> <span class="o">=</span> <span class="n">stdev</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sizey</span><span class="p">:</span>
            <span class="n">sizey</span> <span class="o">=</span> <span class="n">size</span>
        <span class="k">if</span> <span class="n">sizey</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">stdevy</span><span class="o">*</span><span class="mf">1.5</span><span class="p">)</span> <span class="ow">and</span> <span class="n">enlarge</span><span class="p">:</span>
            <span class="n">sizey</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">stdevy</span><span class="o">*</span><span class="mf">1.5</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sizey</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">sizey</span><span class="p">)</span>
        
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="o">-</span><span class="n">size</span><span class="p">:</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">sizey</span><span class="p">:</span><span class="n">sizey</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mf">2.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span> <span class="p">(</span><span class="n">stdev</span><span class="o">**</span><span class="mf">2.0</span><span class="p">))</span><span class="o">+</span><span class="n">y</span><span class="o">**</span><span class="mf">2.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">stdevy</span><span class="o">**</span><span class="mf">2.0</span><span class="p">))))</span>
        
        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">g</span> <span class="o">/</span> <span class="n">g</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">g</span>
    </div>
    <span class="nd">@ignore</span>
<div class="viewcode-block" id="SEDSimulator.get_tel_kern"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.get_tel_kern">[docs]</a>    <span class="k">def</span> <span class="nf">get_tel_kern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">major</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">minor</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the telescope kernel. This kernel is built by creating a circle mask for the size of the telescope mirror, and then subtracting a telescope obscuration from the center of the mirror image. The values for all of these items are set in the configuration file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">major</span> <span class="ow">or</span> <span class="n">minor</span><span class="p">:</span>
            
            
            
            <span class="n">TELIMG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ellipse_kern</span><span class="p">(</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span> <span class="p">)</span>
            <span class="n">center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ellipse_kern</span><span class="p">(</span> <span class="n">major</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.Tel.obsc.ratio&quot;</span><span class="p">],</span> <span class="n">minor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.Tel.obsc.ratio&quot;</span><span class="p">],</span> <span class="o">*</span><span class="n">TELIMG</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">TELIMG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">circle_kern</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.Tel.radius.px&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.density&quot;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">circle_kern</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.Tel.obsc.px&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.density&quot;</span><span class="p">]</span> <span class="p">,</span>
                <span class="o">*</span><span class="n">TELIMG</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span>
        <span class="n">TELIMG</span> <span class="o">-=</span> <span class="n">center</span>
        <span class="n">TELIMG</span> <span class="o">=</span> <span class="n">TELIMG</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">TELIMG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">npArrayInfo</span><span class="p">(</span><span class="n">TELIMG</span><span class="p">,</span><span class="s">&quot;TELIMG&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">TELIMG</span>
    </div>
    <span class="nd">@ignore</span>
<div class="viewcode-block" id="SEDSimulator.get_psf_kern"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.get_psf_kern">[docs]</a>    <span class="k">def</span> <span class="nf">get_psf_kern</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the PSF Kernel. The function first tries to read the encircled energy file. In this case, if a `psf_size` is set in the instrument configuration, this value will be used to truncate the size of the encircled energy function. If the encircled energy function cannot be loaded, the system will fall back on to a gaussian psf as configured by the instrument.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.PSF.size.px&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.PSF.size.px&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.density&quot;</span><span class="p">]</span>
            <span class="n">truncate</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">truncate</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">PSFIMG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf_kern</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_filename</span><span class="p">(</span><span class="s">&quot;Data&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.files.encircledenergy&quot;</span><span class="p">]),</span><span class="n">size</span><span class="p">,</span><span class="n">truncate</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Could not access encircled energy file: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">PSFIMG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gauss_kern</span><span class="p">(</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.PSF.stdev.px&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.density&quot;</span><span class="p">])</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Loaded Encircled Energy from </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.files.encircledenergy&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">PSFIMG</span>
    </div>
    <span class="nd">@ignore</span>
    <span class="nd">@description</span><span class="p">(</span><span class="s">&quot;Setting up configuration values&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SEDSimulator.setup_configuration"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.setup_configuration">[docs]</a>    <span class="k">def</span> <span class="nf">setup_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate dynamic configuration values.</span>
<span class="sd">        </span>
<span class="sd">        Currently, the configuration variables that use \&quot;px\&quot; or \&quot;mm\&quot; keys automatically have their counter-part filled in. As well, the conversion has its counterpart filled in. To disable this dynamic value setting, include a \&quot;calc:False\&quot; variable in the configuration.</span>
<span class="sd">        </span>
<span class="sd">        Example Configuration::</span>
<span class="sd">        </span>
<span class="sd">            image_size:</span>
<span class="sd">                mm: 40 # system will calculate pixels</span>
<span class="sd">            ccd_size:</span>
<span class="sd">                px: 2048</span>
<span class="sd">                calc: False # Conversion will not be performed by system</span>
<span class="sd">                mm: 30</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">astrologger</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">configFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Configurations.This&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">astrologger</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">astrologger</span><span class="o">.</span><span class="n">useConsole</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="s">&quot;calc&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.convert&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s">&quot;mmtopx&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.convert&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="s">&quot;pxtomm&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.convert&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.convert.mmtopx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.convert.pxtomm&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.convert.calc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.convert.pxtomm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.convert.mmtopx&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.convert.calc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setUnits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument&quot;</span><span class="p">],</span><span class="bp">None</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.image.size.px&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.image.size.px&quot;</span><span class="p">]</span> <span class="p">,</span> <span class="mi">0</span> <span class="p">)</span>
                
        <span class="n">wl</span><span class="p">,</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_resolution_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.wavelengths.min&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.wavelengths.max&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.wavelengths.resolution&quot;</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.wavelengths.values&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.wavelengths.resolutions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
        
        <span class="n">sys</span><span class="o">.</span><span class="n">setrecursionlimit</span><span class="p">(</span><span class="mi">10000000</span><span class="p">)</span>
    </div>
    <span class="nd">@ignore</span>
<div class="viewcode-block" id="SEDSimulator.get_resolution_spectrum"><a class="viewcode-back" href="../../Simulator.html#SEDMachine.Simulator.SEDSimulator.get_resolution_spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">get_resolution_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">minwl</span><span class="p">,</span><span class="n">maxwl</span><span class="p">,</span><span class="n">resolution</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for get_resolution_spectrum&quot;&quot;&quot;</span>
        
        <span class="n">dwl</span> <span class="o">=</span> <span class="p">[</span><span class="n">minwl</span><span class="p">]</span>
        <span class="n">new_wl</span> <span class="o">=</span> <span class="n">minwl</span>
        <span class="k">while</span> <span class="n">new_wl</span> <span class="o">&lt;=</span> <span class="n">maxwl</span><span class="p">:</span>
            <span class="n">new_wl</span> <span class="o">+=</span> <span class="p">(</span><span class="n">new_wl</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">)</span>
            <span class="n">dwl</span> <span class="o">+=</span> <span class="p">[</span><span class="n">new_wl</span><span class="p">]</span>
            
        <span class="n">dense_wavelengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dwl</span><span class="p">)</span>
        <span class="n">dense_resolution</span> <span class="o">=</span> <span class="n">dense_wavelengths</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dense_wavelengths</span><span class="p">)</span>
        <span class="n">dense_wavelengths</span> <span class="o">=</span> <span class="n">dense_wavelengths</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dense_wavelengths</span><span class="p">,</span> <span class="n">dense_resolution</span>
    </div>
    <span class="nd">@ignore</span>
    <span class="k">def</span> <span class="nf">_setUnits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;docstring for _setUnits&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
                <span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setUnits</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">k</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s">&quot;mm&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="s">&quot;calc&quot;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&quot;px&quot;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="p">(</span><span class="s">&quot;calc&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">r</span><span class="p">):</span>
                    <span class="n">r</span><span class="p">[</span><span class="s">&quot;px&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.convert.mmtopx&quot;</span><span class="p">]</span>
                    <span class="n">r</span><span class="p">[</span><span class="s">&quot;calc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Value for </span><span class="si">%s</span><span class="s"> set in both px and mm.&quot;</span> <span class="o">%</span> <span class="n">parent</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s">&quot;px&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="s">&quot;calc&quot;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&quot;mm&quot;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="p">(</span><span class="s">&quot;calc&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">r</span><span class="p">):</span>
                    <span class="n">r</span><span class="p">[</span><span class="s">&quot;mm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;Instrument.convert.pxtomm&quot;</span><span class="p">]</span>
                    <span class="n">r</span><span class="p">[</span><span class="s">&quot;calc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Value for </span><span class="si">%s</span><span class="s"> set in both px and mm.&quot;</span> <span class="o">%</span> <span class="n">parent</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span>
</div>
<span class="k">def</span> <span class="nf">run</span><span class="p">():</span>
    <span class="n">SIM</span> <span class="o">=</span> <span class="n">SEDSimulator</span><span class="p">()</span>
    <span class="n">SIM</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>    
    <span class="n">run</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">SEDMsim 0.3.9-p3 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Alexander Rudy.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>